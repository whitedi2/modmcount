
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Если ПустаяСтрока(Объект.Склад) Тогда 
		Элементы.ТабличнаяЧастьСклад.Видимость = Истина;
	Иначе
		Элементы.ТабличнаяЧастьСклад.Видимость = Ложь;
	КонецЕсли;
	
	//-lud 19/10/22 Вся проверка вынесена в модуль объекта, в процедуру Обработка заполнения
    //Отказ = сабОперОбщегоНазначенияНаКлиенте.ПроверкаСозданияНаОснованииНаКлиенте(Объект);
	//Если Отказ Тогда
	//	Возврат;	
	//КонецЕсли; 
	
	УстановитьВидимостьЭлементов();
	
КонецПроцедуры

&НаКлиенте
Процедура ПредприятиеПриИзменении(Элемент)
	ПредприятиеПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПредприятиеПриИзмененииНаСервере()
	сабОбщегоНазначенияКлиентСервер.СкрытьПодразделения(ЭтаФорма);
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	БюджетныйНаСервере.ДействияПриСозданииФормыДокумента(ЭтаФорма);
	
	Если Не ЗначениеЗаполнено(Объект.Ссылка) И НЕ ЗначениеЗаполнено(Параметры.Основание) И Не ЗначениеЗаполнено(Параметры.ЗначениеКопирования) Тогда
		ПодразделениеПриИзмененииСервер();
		
		Если ЗначениеЗаполнено(Объект.Предприятие) Тогда
			Объект.УчитыватьНДС = Объект.Предприятие.УчетнаяПолитика.УчетНДС;
			Если Не Объект.УчитыватьНДС Тогда
				Объект.СуммаВключаетНДС = Истина;	
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;	
	
	//ограничение производства
	УстановитьОтборПроизводства();
	
	ИспользоватьСерии = Справочники.СерииНоменклатуры.СерииНоменклатурыИспользуются();
	Элементы.МатериалыЗаполнитьСерииПоФИФО.Видимость = ИспользоватьСерии;
	
	ЗаполнитьДобавленныеКолонки();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПроизводства()
	Если Ложь Тогда
		НоваяСвязь = Новый ПараметрВыбора("Отбор.ПроизводственноеПодразделение", Истина);
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НоваяСвязь);
		НовыеСвязи = Новый ФиксированныйМассив(НовыйМассив);
		Элементы.Подразделение.ПараметрыВыбора = НовыеСвязи;
	Иначе
		Элементы.ТабличнаяЧастьПерезаполнитьПоСпецификации.Видимость = Ложь;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	сабОбщегоНазначения.ОтобразитьСостояниеДокумента(ЭтаФорма);
КонецПроцедуры

&НаСервере
Процедура ПриЗаписиНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	сабОбщегоНазначения.ОтобразитьСостояниеДокумента(ЭтаФорма, ТекущийОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьНоменклатураПриИзменении(Элемент)
	
	ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
	
	Если ТекДанные.Количество = 0 Тогда
		ТекДанные.Количество = 1;		
	КонецЕсли;
	
	Если Не ТекДанные = Неопределено Тогда
		ТекДанные.Спецификация = ТабличнаяЧастьНоменклатураПриИзмененииНаСервере(ТекДанные.Номенклатура);
		УстановитьМатериалыПоСпецификации(ТекДанные.Спецификация, ТекДанные.Количество, ТекДанные.УИД);
		УстановитьРаботыПоСпецификации(ТекДанные.Спецификация, ТекДанные.Количество, ТекДанные.УИД);
	КонецЕсли;	
	
	УстановитьОтборСтрокМатериалов();
	УстановитьОтборСтрокРаботыИРасценки();
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ТабличнаяЧастьНоменклатураПриИзмененииНаСервере(ТекНоменклатура)
	Возврат Документы.ЗаказНаПроизводство.ТабличнаяЧастьНоменклатураПриИзмененииНаСервере(ТекНоменклатура);
КонецФункции

&НаКлиенте
Процедура ТабличнаяЧастьПередУдалением(Элемент, Отказ)
	
	ТекДанные = Элемент.ТекущиеДанные;
	
	Если ТекДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
		
	СтрокиМатериалов = Объект.Материалы.НайтиСтроки(Новый Структура("УИДТЧ", ТекДанные.УИД));
	Для Каждого СтрокаМатериала Из СтрокиМатериалов Цикл
		Объект.Материалы.Удалить(СтрокаМатериала);	
	КонецЦикла;
	
	СтрокиРаботы = Объект.РаботыИРасценки.НайтиСтроки(Новый Структура("УИДТЧ", ТекДанные.УИД));
	Для Каждого СтрокаРаботы Из СтрокиРаботы Цикл
		Объект.РаботыИРасценки.Удалить(СтрокаРаботы);	
	КонецЦикла;
	
КонецПроцедуры


&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	//Если ЗначениеЗаполнено(Объект.Подразделение) Тогда
	Для Каждого Текстрока Из Объект.ТабличнаяЧасть Цикл
		Если ЗначениеЗаполнено(Объект.Подразделение) Тогда
			ТекСтрока.Подразделение = Объект.Подразделение;
		КонецЕсли;
		Если ЗначениеЗаполнено(Объект.Склад) Тогда
			ТекСтрока.Склад = Объект.Склад;
		КонецЕсли;
	КонецЦикла;
	//КонецЕсли;
	
	//удалим лишние строки в таблице материалов
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.ПроизводствоПоСпецификации") Тогда
		КоличествоСтрок = Объект.Материалы.Количество();
		
		Для Индекс = 1 По КоличествоСтрок Цикл
			ТекСтрокаМатериалов = Объект.Материалы[КоличествоСтрок - Индекс];
			
			Если Объект.ТабличнаяЧасть.НайтиСтроки(Новый Структура("УИД", ТекСтрокаМатериалов.УИДТЧ)).Количество() = 0 Тогда
				Объект.Материалы.Удалить(ТекСтрокаМатериалов);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.ПроизводствоПоСпецификации") Тогда
		КоличествоСтрок = Объект.РаботыИРасценки.Количество();
		
		Для Индекс = 1 По КоличествоСтрок Цикл
			ТекСтрокаРабот = Объект.РаботыИРасценки[КоличествоСтрок - Индекс];
			
			Если Объект.ТабличнаяЧасть.НайтиСтроки(Новый Структура("УИД", ТекСтрокаРабот.УИДТЧ)).Количество() = 0 Тогда
				Объект.РаботыИРасценки.Удалить(ТекСтрокаРабот);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;

	//проверим дубли выпуска
	//Для каждого ТекСтрока Из Объект.ТабличнаяЧасть Цикл
	//	НайденныеСтроки = Объект.ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура, Склад, Подразделение, Спецификация", ТекСтрока.Номенклатура, ТекСтрока.Склад, ТекСтрока.Подразделение, ТекСтрока.Спецификация));
	//	Если НайденныеСтроки.Количество() > 1 Тогда
	//		Сообщение = Новый СообщениеПользователю;
	//		Сообщение.Текст = "В строке " + Строка(ТекСтрока.НомерСтроки) + " найдены дубли выпуска! Проверьте корректность данных.";
	//		Сообщение.Поле = "Объект.ТабличнаяЧасть[" + Строка(ТекСтрока.НомерСтроки - 1) + "].Номенклатура"; //имя реквизита 
	//		Сообщение.УстановитьДанные(Объект); //Ссылка на объект ИБ
	//		Сообщение.Сообщить();
	//		Отказ = Истина;
	//	КонецЕсли;
	//КонецЦикла; //закоменчено, т.к. они сканером бьют по журналу, встречаются повторения
	
КонецПроцедуры

#Область ПоискПоШК

&НаКлиенте
Процедура ПодобратьНоменклатуруПоШК(Команда)
	ОбработкаТабличнойЧастиТоварыКлиент.ВвестиШтрихкод(ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеПоискаПоШтрихкоду(Штрихкод, ДополнительныеПараметры) Экспорт
	
	РежимСканирования = Ложь;
	ИмяТЧ = "ТабличнаяЧасть";
	ИмяРеквизитаНоменклатуры = "Номенклатура";
	ИмяРеквизитаКоличества = "Количество";
	сабОперОбщегоНазначенияНаКлиенте.ОбработатьЗаполнениеПоШтрихкодуНаКлиенте(ЭтаФорма, ИмяТЧ, ИмяРеквизитаНоменклатуры, ИмяРеквизитаКоличества, Штрихкод);
	ТабличнаяЧастьНоменклатураПриИзменении(Неопределено);
	
	Элементы[ИмяТЧ].ТекущийЭлемент = Элементы.ТабличнаяЧастьКоличество;
	
	
	Если ЗначениеЗаполнено(Штрихкод) Тогда
		Если Элементы[ИмяТЧ].ТекущиеДанные[ИмяРеквизитаКоличества] Тогда //режим непрерывного сканирования
			ПодобратьНоменклатуруПоШК(Неопределено);
		Иначе
			РежимСканирования = Истина;
		КонецЕсли;	
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Процедура СтатусПриИзменении(Элемент)
	
		
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьКоличествоПоПервичнымДокументамПриИзменении(Элемент)
	
	ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
	
	Если Не ТекДанные = Неопределено Тогда
		ТекДанные.СуммаПоПервичнымДокументам = ТекДанные.КоличествоПоПервичнымДокументам * ТекДанные.Цена;
	КонецЕсли;	
	
	ТекРеквизиты = БюджетныйНаСервере.ВернутьРеквизиты(ТекДанные.СтавкаНДС, "Ставка");
	Если НЕ ТекРеквизиты = Неопределено Тогда
		ТекДанные.СуммаНДСПоПервичнымДокументам = ТекДанные.СуммаПоПервичнымДокументам / (1+ТекРеквизиты.Ставка/100) * (ТекРеквизиты.Ставка/100);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДоговорПриИзменении(Элемент)
	СчетВДоговоре = БюджетныйНаСервере.ВернутьРеквизит(Объект.Договор, "СчетВзаиморасчетов");
	Если ЗначениеЗаполнено(СчетВДоговоре) Тогда
		Объект.СчетКонтрагента = БюджетныйНаСервере.ВернутьРеквизит(Объект.Договор, "СчетВзаиморасчетов");
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПодразделениеПриИзменении(Элемент)
	ПодразделениеПриИзмененииСервер();
КонецПроцедуры

&НаСервере
Процедура ПодразделениеПриИзмененииСервер()
	
	Если ЗначениеЗаполнено(Объект.Подразделение) Тогда
		РеквизитыПодразделения = БюджетныйНаСервере.ВернутьРеквизиты(Объект.Подразделение, "Склад, Организация");
		Объект.Склад = РеквизитыПодразделения.Склад;
		Объект.Организация = РеквизитыПодразделения.Организация;
	КонецЕсли; 
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьСпецификацияПриИзменении(Элемент)
	
	ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
	
	Если Не ТекДанные = Неопределено Тогда
		УстановитьМатериалыПоСпецификации(ТекДанные.Спецификация, ТекДанные.Количество, ТекДанные.УИД);
		УстановитьРаботыПоСпецификации(ТекДанные.Спецификация, ТекДанные.Количество, ТекДанные.УИД);
	КонецЕсли;	
	
	УстановитьОтборСтрокМатериалов();
	УстановитьОтборСтрокРаботыИРасценки();
			 
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьКоличествоПриИзменении(Элемент)
	
	ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
	
	Если Не ТекДанные = Неопределено Тогда
		ПересчитатьКоличествоПоСпецификации(ТекДанные.Количество, ТекДанные.УИД);
		Если РежимСканирования Тогда
			ПодобратьНоменклатуруПоШК(Неопределено);	
		КонецЕсли;
	КонецЕсли;	
		
КонецПроцедуры

&НаКлиенте
Процедура УстановитьОтборСтрокМатериалов()
	
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.ПроизводствоПоСпецификации") ИЛИ Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.ПоступлениеИзПереработки") Тогда
		ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
		
		Если Не ТекДанные = Неопределено Тогда
			Элементы.Материалы.ОтборСтрок = Новый ФиксированнаяСтруктура(Новый Структура("УИДТЧ", ТекДанные.УИД));
			Элементы.Услуги.ОтборСтрок = Новый ФиксированнаяСтруктура(Новый Структура("УИДТЧ", ТекДанные.УИД));
		Иначе
			Элементы.Материалы.ОтборСтрок = Новый ФиксированнаяСтруктура();
			Элементы.Услуги.ОтборСтрок = Новый ФиксированнаяСтруктура();
		КонецЕсли;	
		Элементы.МатериалыСклад.Видимость = Ложь;
		Элементы.МатериалыСчетСписания.Видимость = Ложь;
	Иначе
		Элементы.Материалы.ОтборСтрок = Новый ФиксированнаяСтруктура();
		Элементы.МатериалыСклад.Видимость = Истина;
		Элементы.МатериалыСчетСписания.Видимость = Истина;
		
		Элементы.Услуги.ОтборСтрок = Новый ФиксированнаяСтруктура();
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура УстановитьОтборСтрокРаботыИРасценки()
	
	ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
		
		Если Не ТекДанные = Неопределено Тогда
			Элементы.РаботыИРасценки.ОтборСтрок = Новый ФиксированнаяСтруктура(Новый Структура("УИДТЧ", ТекДанные.УИД));
		Иначе
			Элементы.Материалы.ОтборСтрок = Новый ФиксированнаяСтруктура();
		КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьКоличествоПоСпецификации(ПервоначальноеКоличество, ТекУИД)

	СтрокиМатериалов = Объект.Материалы.НайтиСтроки(Новый Структура("УИДТЧ", ТекУИД));
	Для Каждого СтрокаМатериала Из СтрокиМатериалов Цикл
		Количество = ?(КоличествоДо, СтрокаМатериала.Количество / КоличествоДо, СтрокаМатериала.Количество);
		СтрокаМатериала.Количество = Количество * ПервоначальноеКоличество;	
	КонецЦикла;	
	
	СтрокиРаботыИРасценки = Объект.РаботыИРасценки.НайтиСтроки(Новый Структура("УИДТЧ", ТекУИД));
	Для Каждого СтрокаРаботыИРасценки Из СтрокиРаботыИРасценки Цикл
		Количество = ?(КоличествоДо, СтрокаРаботыИРасценки.Количество / КоличествоДо, СтрокаРаботыИРасценки.Количество);
		СтрокаРаботыИРасценки.Количество = Количество * ПервоначальноеКоличество;
		СтрокаРаботыИРасценки.Сумма = СтрокаРаботыИРасценки.Цена * СтрокаРаботыИРасценки.Количество;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьМатериалыПоСпецификации(ТекСпецификация, ПервоначальноеКоличество, ТекУИД)
	
	//заглушка
	ТаблицаМатериалов = Объект.Материалы.Выгрузить();
	
	ПодчиненныеСтроки = ТаблицаМатериалов.НайтиСтроки(Новый Структура("УИДТЧ", ТекУИД));
	Для Каждого ПодчиненнаяСтрока Из ПодчиненныеСтроки Цикл
		ТаблицаМатериалов.Удалить(ПодчиненнаяСтрока);	
	КонецЦикла;	
	
	ЗапросПоСпецификациям = Новый Запрос;
	ЗапросПоСпецификациям.Текст = 
	"ВЫБРАТЬ
	|	МАКСИМУМ(Спецификации.Дата) КАК Дата,
	|	Спецификации.Владелец КАК Продукция
	|ПОМЕСТИТЬ ВТ_ПоследнииСпецификации
	|ИЗ
	|	Справочник.СпецификацииНоменклатуры КАК Спецификации
	|ГДЕ
	//|	НЕ Спецификации.Ссылка.Вид = ЗНАЧЕНИЕ(Перечисление.ВидыСпецификаций.Разруб)
	|	НЕ Спецификации.Ссылка.ПометкаУдаления
	|	И НЕ Спецификации.Ссылка В (&СписокСпецификаций)
	|	И Спецификации.Дата <= &Дата
	|
	|СГРУППИРОВАТЬ ПО
	|	Спецификации.Владелец
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	//|ВЫБРАТЬ
	//|	СпецификацииСостав.Ссылка КАК Спецификация,
	//|	СпецификацииСостав.Ссылка.Владелец КАК Продукция,
	//|	СпецификацииСостав.Номенклатура КАК Материал,
	//|	СпецификацииСостав.Ссылка.Дата КАК Дата,
	//|	СпецификацииСостав.Количество
	////|	СпецификацииСостав.ОтходыПриХолоднойОбработке,
	////|	СпецификацииСостав.МассаНетто,
	////|	СпецификацииСостав.ПотериПриТепловойОбработке,
	////|	СпецификацииСостав.Ссылка.Выход
	//|ИЗ
	//|	ВТ_ПоследнииСпецификации КАК ВТ_ПоследнииСпецификации
	//|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпецификацииНоменклатуры.ИсходныеКомплектующие КАК СпецификацииСостав
	//|		ПО ВТ_ПоследнииСпецификации.Дата = СпецификацииСостав.Ссылка.Дата
	//|			И ВТ_ПоследнииСпецификации.Продукция = СпецификацииСостав.Ссылка.Владелец
	//|ГДЕ
	//|	НЕ СпецификацииСостав.Ссылка.ПометкаУдаления
	////|	И НЕ СпецификацииСостав.Ссылка.Вид = ЗНАЧЕНИЕ(Перечисление.ВидыСпецификаций.Разруб)
	|
	//|ОБЪЕДИНИТЬ ВСЕ
	//|
	|ВЫБРАТЬ
	|	СпецификацииСостав.Ссылка КАК Спецификация,
	|	СпецификацииСостав.Ссылка.Владелец КАК Продукция,
	|	СпецификацииСостав.Номенклатура КАК Материал,
	|	СпецификацииСостав.Ссылка.Дата КАК Дата,
	|	СпецификацииСостав.Количество / (Выбор Когда СпецификацииСостав.Ссылка.Количество > 0 Тогда СпецификацииСостав.Ссылка.Количество Иначе 1 Конец) КАК Количество 
	//|	СпецификацииСостав.ОтходыПриХолоднойОбработке,
	//|	СпецификацииСостав.МассаНетто,
	//|	СпецификацииСостав.ПотериПриТепловойОбработке,
	//|	СпецификацииСостав.Ссылка.Выход
	|ИЗ
	|	Справочник.СпецификацииНоменклатуры.ИсходныеКомплектующие КАК СпецификацииСостав
	|ГДЕ
	|	СпецификацииСостав.Ссылка В(&СписокСпецификаций)";
	
	ЗапросПоСпецификациям.УстановитьПараметр("СписокСпецификаций", ТекСпецификация);
	ЗапросПоСпецификациям.УстановитьПараметр("Дата", ?(ЗначениеЗаполнено(Объект.Дата), Объект.Дата, ТекущаяДата())); 
	РезультатЗапроса = ЗапросПоСпецификациям.Выполнить();
	ТаблицаСпецификаций = РезультатЗапроса.Выгрузить();
	
	//Если выпуск по спецификации, то спишем сразу материалы в производство
	Если ЗначениеЗаполнено(ТекСпецификация) Тогда
		НайденныйСоставСпецификаций = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Спецификация", ТекСпецификация));
		Для Каждого СоставСпецификаций Из НайденныйСоставСпецификаций Цикл
			ТекКоэф = МАКС(ПервоначальноеКоличество, 1);
			//находим подчиненные спецификации
			СоставПодчиненнойСпецификации = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Продукция", СоставСпецификаций.Материал));
			Если СоставПодчиненнойСпецификации.Количество() > 0 Тогда
				Для Каждого СтрокаПодчиненнойСпецификации Из СоставПодчиненнойСпецификации Цикл
					ТекКоэф1 = ТекКоэф * СтрокаПодчиненнойСпецификации.Количество;
					СоставПодчиненнойСпецификации2 = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Продукция", СтрокаПодчиненнойСпецификации.Материал));
					Если СоставПодчиненнойСпецификации2.Количество() > 0 Тогда
						Для Каждого СтрокаПодчиненнойСпецификации2 Из СоставПодчиненнойСпецификации2 Цикл
							ТекКоэф2 = ТекКоэф1 * СтрокаПодчиненнойСпецификации2.Количество;
							СоставПодчиненнойСпецификации3 = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Продукция", СтрокаПодчиненнойСпецификации2.Материал));
							Если СоставПодчиненнойСпецификации3.Количество() > 0 Тогда
								Для Каждого СтрокаПодчиненнойСпецификации3 Из СоставПодчиненнойСпецификации3 Цикл
									ТекКоэф3 = ТекКоэф2 * СтрокаПодчиненнойСпецификации3.Количество;
									СоставПодчиненнойСпецификации4 = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Продукция", СтрокаПодчиненнойСпецификации3.Материал));
									Если СоставПодчиненнойСпецификации4.Количество() > 0 Тогда
										Для Каждого СтрокаПодчиненнойСпецификации4 Из СоставПодчиненнойСпецификации4 Цикл
											ТекКоэф4 = ТекКоэф3 * СтрокаПодчиненнойСпецификации4.Количество;
											СтрокаТаблМатериалов = ТаблицаМатериалов.Добавить();
											СтрокаТаблМатериалов.Коэффициент = ТекКоэф4;
											СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации4.Количество * ТекКоэф4;
											СтрокаТаблМатериалов.Материал = СтрокаПодчиненнойСпецификации4.Материал;
											СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
										КонецЦикла;	
									Иначе
										СтрокаТаблМатериалов = ТаблицаМатериалов.Добавить();
										СтрокаТаблМатериалов.Коэффициент = ТекКоэф3;
										СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации3.Количество * ТекКоэф3;
										СтрокаТаблМатериалов.Материал = СтрокаПодчиненнойСпецификации3.Материал;
										СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
									КонецЕсли;
								КонецЦикла;	
							Иначе
								СтрокаТаблМатериалов = ТаблицаМатериалов.Добавить();
								СтрокаТаблМатериалов.Коэффициент = ТекКоэф2;
								СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации2.Количество * ТекКоэф2;
								СтрокаТаблМатериалов.Материал = СтрокаПодчиненнойСпецификации2.Материал;
								СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
							КонецЕсли;
						КонецЦикла;
					Иначе
						СтрокаТаблМатериалов = ТаблицаМатериалов.Добавить();	
						СтрокаТаблМатериалов.Коэффициент = ТекКоэф1;
						СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации.Количество * ТекКоэф1;
						СтрокаТаблМатериалов.Материал = СтрокаПодчиненнойСпецификации.Материал;
						СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
					КонецЕсли;
				КонецЦикла;
			Иначе
				СтрокаТаблМатериалов = ТаблицаМатериалов.Добавить();
				СтрокаТаблМатериалов.Коэффициент = ТекКоэф;
				СтрокаТаблМатериалов.Количество = СоставСпецификаций.Количество * ТекКоэф;
				СтрокаТаблМатериалов.Материал = СоставСпецификаций.Материал;
				СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
			КонецЕсли;
		КонецЦикла;	
	КонецЕсли;	
	//
	
	Объект.Материалы.Загрузить(ТаблицаМатериалов);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьРаботыПоСпецификации(ТекСпецификация, ПервоначальноеКоличество, ТекУИД)
	
	ТаблицаРабот = Объект.РаботыИРасценки.Выгрузить();
	
	ПодчиненныеСтроки = ТаблицаРабот.НайтиСтроки(Новый Структура("УИДТЧ", ТекУИД));
	Для Каждого ПодчиненнаяСтрока Из ПодчиненныеСтроки Цикл
		ТаблицаРабот.Удалить(ПодчиненнаяСтрока);	
	КонецЦикла;	
	
	ЗапросПоСпецификациям = Новый Запрос;
	ЗапросПоСпецификациям.Текст = 
	"ВЫБРАТЬ
	|	МАКСИМУМ(Спецификации.Дата) КАК Дата,
	|	Спецификации.Владелец КАК Продукция
	|ПОМЕСТИТЬ ВТ_ПоследниеСпецификации
	|ИЗ
	|	Справочник.СпецификацииНоменклатуры КАК Спецификации
	|ГДЕ
	|	НЕ Спецификации.Ссылка.ПометкаУдаления
	|	И НЕ Спецификации.Ссылка В (&СписокСпецификаций)
	|	И Спецификации.Дата <= &Дата
	|
	|СГРУППИРОВАТЬ ПО
	|	Спецификации.Владелец
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СпецификацииНоменклатурыРаботыИРасценки.Ссылка КАК Спецификация,
	|	СпецификацииНоменклатурыРаботыИРасценки.Ссылка.Владелец КАК Продукция,
	|	СпецификацииНоменклатурыРаботыИРасценки.Номенклатура КАК Работа,
	|	СпецификацииНоменклатурыРаботыИРасценки.Ссылка.Дата КАК Дата,
	|	СпецификацииНоменклатурыРаботыИРасценки.Количество / ВЫБОР
	|		КОГДА СпецификацииНоменклатурыРаботыИРасценки.Ссылка.Количество > 0
	|			ТОГДА СпецификацииНоменклатурыРаботыИРасценки.Ссылка.Количество
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК Количество,
	|	СпецификацииНоменклатурыРаботыИРасценки.Содержание КАК Содержание,
	|	СпецификацииНоменклатурыРаботыИРасценки.Цена КАК Цена,
	|	СпецификацииНоменклатурыРаботыИРасценки.Сумма КАК Сумма,
	|	СпецификацииНоменклатурыРаботыИРасценки.СчетЗатрат КАК СчетЗатрат,
	|	СпецификацииНоменклатурыРаботыИРасценки.Субконто1 КАК Субконто1,
	|	СпецификацииНоменклатурыРаботыИРасценки.Субконто2 КАК Субконто2,
	|	СпецификацииНоменклатурыРаботыИРасценки.Субконто3 КАК Субконто3,
	|	СпецификацииНоменклатурыРаботыИРасценки.СтатьяЗатрат КАК СтатьяЗатрат
	|ИЗ
	|	Справочник.СпецификацииНоменклатуры.РаботыИРасценки КАК СпецификацииНоменклатурыРаботыИРасценки
	|ГДЕ
	|	СпецификацииНоменклатурыРаботыИРасценки.Ссылка В(&СписокСпецификаций)";
	
	ЗапросПоСпецификациям.УстановитьПараметр("СписокСпецификаций", ТекСпецификация);
	ЗапросПоСпецификациям.УстановитьПараметр("Дата", ?(ЗначениеЗаполнено(Объект.Дата), Объект.Дата, ТекущаяДата())); 
	РезультатЗапроса = ЗапросПоСпецификациям.Выполнить();
	ТаблицаСпецификаций = РезультатЗапроса.Выгрузить();
	
	//Если выпуск по спецификации, то спишем сразу материалы в производство
	Если ЗначениеЗаполнено(ТекСпецификация) Тогда
		НайденныйСоставСпецификаций = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Спецификация", ТекСпецификация));
		Для Каждого СоставСпецификаций Из НайденныйСоставСпецификаций Цикл
			ТекКоэф = МАКС(ПервоначальноеКоличество, 1);
			//находим подчиненные спецификации
			СоставПодчиненнойСпецификации = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Работа", СоставСпецификаций.Работа));
			Если СоставПодчиненнойСпецификации.Количество() > 0 Тогда
				Для Каждого СтрокаПодчиненнойСпецификации Из СоставПодчиненнойСпецификации Цикл
					ТекКоэф1 = ТекКоэф * СтрокаПодчиненнойСпецификации.Количество;
					СоставПодчиненнойСпецификации2 = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Работа", СтрокаПодчиненнойСпецификации.Работа));
					Если СоставПодчиненнойСпецификации2.Количество() > 0 Тогда
						Для Каждого СтрокаПодчиненнойСпецификации2 Из СоставПодчиненнойСпецификации2 Цикл
							ТекКоэф2 = ТекКоэф1 * СтрокаПодчиненнойСпецификации2.Количество;
							СоставПодчиненнойСпецификации3 = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Работа", СтрокаПодчиненнойСпецификации2.Работа));
							Если СоставПодчиненнойСпецификации3.Количество() > 0 Тогда
								Для Каждого СтрокаПодчиненнойСпецификации3 Из СоставПодчиненнойСпецификации3 Цикл
									ТекКоэф3 = ТекКоэф2 * СтрокаПодчиненнойСпецификации3.Количество;
									СоставПодчиненнойСпецификации4 = ТаблицаСпецификаций.НайтиСтроки(Новый Структура("Работа", СтрокаПодчиненнойСпецификации3.Работа));
									Если СоставПодчиненнойСпецификации4.Количество() > 0 Тогда
										Для Каждого СтрокаПодчиненнойСпецификации4 Из СоставПодчиненнойСпецификации4 Цикл
											ТекКоэф4 = ТекКоэф3 * СтрокаПодчиненнойСпецификации4.Количество;
											СтрокаТаблМатериалов = ТаблицаРабот.Добавить();
											//СтрокаТаблМатериалов.Коэффициент = ТекКоэф4;
											СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации4.Количество * ТекКоэф4;
											СтрокаТаблМатериалов.Номенклатура = СтрокаПодчиненнойСпецификации4.Работа;
											СтрокаТаблМатериалов.Содержание = СтрокаПодчиненнойСпецификации4.Содержание;
											СтрокаТаблМатериалов.Цена = СтрокаПодчиненнойСпецификации4.Цена;
											СтрокаТаблМатериалов.Сумма = СтрокаТаблМатериалов.Количество*СтрокаПодчиненнойСпецификации4.Цена;//СтрокаПодчиненнойСпецификации4.Сумма;
											СтрокаТаблМатериалов.СчетЗатрат = СтрокаПодчиненнойСпецификации4.СчетЗатрат;
											СтрокаТаблМатериалов.Субконто1 = СтрокаПодчиненнойСпецификации4.Субконто1;
											СтрокаТаблМатериалов.Субконто2 = СтрокаПодчиненнойСпецификации4.Субконто2;
											СтрокаТаблМатериалов.Субконто3 = СтрокаПодчиненнойСпецификации4.Субконто3;
											СтрокаТаблМатериалов.СтатьяЗатрат = СтрокаПодчиненнойСпецификации4.СтатьяЗатрат;
											СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
										КонецЦикла;	
									Иначе
										СтрокаТаблМатериалов = ТаблицаРабот.Добавить();
										//СтрокаТаблМатериалов.Коэффициент = ТекКоэф3;
										СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации3.Количество * ТекКоэф3;
										СтрокаТаблМатериалов.Номенклатура = СтрокаПодчиненнойСпецификации3.Работа;
										СтрокаТаблМатериалов.Содержание = СтрокаПодчиненнойСпецификации3.Содержание;
										СтрокаТаблМатериалов.Цена = СтрокаПодчиненнойСпецификации3.Цена;
										СтрокаТаблМатериалов.Сумма = СтрокаТаблМатериалов.Количество*СтрокаПодчиненнойСпецификации3.Цена;//СтрокаПодчиненнойСпецификации3.Сумма;
										СтрокаТаблМатериалов.СчетЗатрат = СтрокаПодчиненнойСпецификации3.СчетЗатрат;
										СтрокаТаблМатериалов.Субконто1 = СтрокаПодчиненнойСпецификации3.Субконто1;
										СтрокаТаблМатериалов.Субконто2 = СтрокаПодчиненнойСпецификации3.Субконто2;
										СтрокаТаблМатериалов.Субконто3 = СтрокаПодчиненнойСпецификации3.Субконто3;
										СтрокаТаблМатериалов.СтатьяЗатрат = СтрокаПодчиненнойСпецификации3.СтатьяЗатрат;
										СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
									КонецЕсли;
								КонецЦикла;	
							Иначе
								СтрокаТаблМатериалов = ТаблицаРабот.Добавить();
								//СтрокаТаблМатериалов.Коэффициент = ТекКоэф2;
								СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации2.Количество * ТекКоэф2;
								СтрокаТаблМатериалов.Номенклатура = СтрокаПодчиненнойСпецификации2.Работа;
								СтрокаТаблМатериалов.Содержание = СтрокаПодчиненнойСпецификации2.Содержание;
								СтрокаТаблМатериалов.Цена = СтрокаПодчиненнойСпецификации2.Цена;
								СтрокаТаблМатериалов.Сумма = СтрокаТаблМатериалов.Количество*СтрокаПодчиненнойСпецификации2.Цена;//СтрокаПодчиненнойСпецификации2.Сумма;
								СтрокаТаблМатериалов.СчетЗатрат = СтрокаПодчиненнойСпецификации2.СчетЗатрат;
								СтрокаТаблМатериалов.Субконто1 = СтрокаПодчиненнойСпецификации2.Субконто1;
								СтрокаТаблМатериалов.Субконто2 = СтрокаПодчиненнойСпецификации2.Субконто2;
								СтрокаТаблМатериалов.Субконто3 = СтрокаПодчиненнойСпецификации2.Субконто3;
								СтрокаТаблМатериалов.СтатьяЗатрат = СтрокаПодчиненнойСпецификации2.СтатьяЗатрат;
								СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
							КонецЕсли;
						КонецЦикла;
					Иначе
						СтрокаТаблМатериалов = ТаблицаРабот.Добавить();	
						//СтрокаТаблМатериалов.Коэффициент = ТекКоэф1;
						СтрокаТаблМатериалов.Количество = СтрокаПодчиненнойСпецификации.Количество * ТекКоэф1;
						СтрокаТаблМатериалов.Номенклатура = СтрокаПодчиненнойСпецификации.Работа;
						СтрокаТаблМатериалов.Содержание = СтрокаПодчиненнойСпецификации.Содержание;
						СтрокаТаблМатериалов.Цена = СтрокаПодчиненнойСпецификации.Цена;
						СтрокаТаблМатериалов.Сумма = СтрокаТаблМатериалов.Количество*СтрокаПодчиненнойСпецификации.Цена;//СтрокаПодчиненнойСпецификации.Сумма;
						СтрокаТаблМатериалов.СчетЗатрат = СтрокаПодчиненнойСпецификации.СчетЗатрат;
						СтрокаТаблМатериалов.Субконто1 = СтрокаПодчиненнойСпецификации.Субконто1;
						СтрокаТаблМатериалов.Субконто2 = СтрокаПодчиненнойСпецификации.Субконто2;
						СтрокаТаблМатериалов.Субконто3 = СтрокаПодчиненнойСпецификации.Субконто3;
						СтрокаТаблМатериалов.СтатьяЗатрат = СтрокаПодчиненнойСпецификации.СтатьяЗатрат;
						СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
					КонецЕсли;
				КонецЦикла;
			Иначе
				СтрокаТаблМатериалов = ТаблицаРабот.Добавить();
				//СтрокаТаблМатериалов.Коэффициент = ТекКоэф;
				СтрокаТаблМатериалов.Количество = СоставСпецификаций.Количество * ТекКоэф;
				СтрокаТаблМатериалов.Номенклатура = СоставСпецификаций.Работа;
				СтрокаТаблМатериалов.Содержание = СоставСпецификаций.Содержание;
				СтрокаТаблМатериалов.Цена = СоставСпецификаций.Цена;
				СтрокаТаблМатериалов.Сумма = СтрокаТаблМатериалов.Количество*СоставСпецификаций.Цена;//СоставСпецификаций.Сумма;
				СтрокаТаблМатериалов.СчетЗатрат = СоставСпецификаций.СчетЗатрат;
				СтрокаТаблМатериалов.Субконто1 = СоставСпецификаций.Субконто1;
				СтрокаТаблМатериалов.Субконто2 = СоставСпецификаций.Субконто2;
				СтрокаТаблМатериалов.Субконто3 = СоставСпецификаций.Субконто3;
				СтрокаТаблМатериалов.СтатьяЗатрат = СоставСпецификаций.СтатьяЗатрат;
				СтрокаТаблМатериалов.УИДТЧ = ТекУИД;
			КонецЕсли;
		КонецЦикла;	
	КонецЕсли;	
	//
		
	Объект.РаботыИРасценки.Загрузить(ТаблицаРабот);
	
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		Элемент.ТекущиеДанные.УИД = Новый УникальныйИдентификатор;
		ТабличнаяЧастьСпецификацияПриИзменении(Неопределено);
	КонецЕсли;
	
	КоличествоДо = Элемент.ТекущиеДанные.Количество;
	
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьПриАктивизацииСтроки(Элемент)
	
	УстановитьОтборСтрокМатериалов();
	УстановитьОтборСтрокРаботыИРасценки();
	
КонецПроцедуры

&НаКлиенте
Процедура ПерезаполнитьПоСпецификации(Команда)
	
	Объект.Материалы.Очистить();
	Объект.РаботыИРасценки.Очистить();
	
	Для Каждого СтрокаТЧ Из Объект.ТабличнаяЧасть Цикл
		УстановитьМатериалыПоСпецификации(СтрокаТЧ.Спецификация, СтрокаТЧ.Количество, СтрокаТЧ.УИД);
		УстановитьРаботыПоСпецификации(СтрокаТЧ.Спецификация, СтрокаТЧ.Количество, СтрокаТЧ.УИД);
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьExel(Команда)
	
	ПутьКФайлу = ОткрытьФормуМодально("Документ.УЧ_ВыпускПродукции.Форма.ФормаЗагрузки");   //, Новый Структура("ВидЗагрузки", "ЦеныПоставщика")
	
	Если ЗначениеЗаполнено(ПутьКФайлу) Тогда
		Данные = Неопределено;
		СоответствиеНоменклатур = Новый Соответствие;
		
		ЧислоСтрок = 0;
		КоличествоСтраниц = 1;
		
		XLSОбъект = Новый COMОбъект("Excel.Application");
		ПодключениеКФайлу(ЧислоСтрок, Данные, XLSОбъект, ПутьКФайлу);
		
		НомерЗаказа = "";
		СтруДок = Новый Структура;
		МассивСтрок = Новый Массив;
		ДатаДок = Неопределено;
		ВремяНачала = ТекущаяДата();
		ОсталосьВремени = 0;
		СкоростьЗагрузки = 0;
		
		Для счСтроки = 1 по ЧислоСтрок Цикл
			Состояние("Загрузка", счСтроки / ЧислоСтрок * 100);
			СтруктураСтроки = Новый Структура;
			Код = (СтрЗаменить(СтрЗаменить(Данные[0][счСтроки], " ", ""), Символы.НПП, ""));
			ТекНоменклатура = БюджетныйНаСервере.СправочникНайтиПоКоду("Номенклатура", Код, , );
			
			Если Не ЗначениеЗаполнено(ТекНоменклатура) Тогда
				Продолжить;
			КонецЕсли;
			
			Спецификация = ТабличнаяЧастьНоменклатураПриИзмененииНаСервере(ТекНоменклатура);
			ГУИД = Новый УникальныйИдентификатор;			
		    Количество = ?(СокрЛП(Данные[2][счСтроки]) = "", 0, Число(Данные[2][счСтроки]));

			СтруктураСтроки.Вставить("Номенклатура", ТекНоменклатура); 
			СтруктураСтроки.Вставить("Количество", Количество); 
			СтруктураСтроки.Вставить("Спецификация", ?(Спецификация = "", 0, Спецификация) );   
			СтруктураСтроки.Вставить("УИД", ГУИД);
			
			ЗаполнитьЗначенияСвойств(Объект.ТабличнаяЧасть.Добавить(), СтруктураСтроки);
			
			Если ЗначениеЗаполнено(Спецификация) Тогда
			 	УстановитьМатериалыПоСпецификации(Спецификация, Количество, ГУИД);
			КонецЕсли;
			
	
		КонецЦикла;
		
		XLSОбъект.Application.Quit();
		
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура ПодключениеКФайлу(ЧислоСтрок, Данные, XLSОбъект = Неопределено, ПутьКФайлу)
	
	Если Не ЗначениеЗаполнено(ПутьКФайлу) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Укажите путь к файлу!";
		Сообщение.Поле = "Файл";
		Сообщение.Сообщить(); 	
		Возврат;
	КонецЕсли;
	
	Если НЕ ПутьКФайлу = Неопределено Тогда
		Если XLSОбъект = Неопределено Тогда
			XLSОбъект = Новый COMОбъект("Excel.Application");
		КонецЕсли;
		XLSОбъект.Visible       = Ложь;
		XLSОбъект.DisplayAlerts = Ложь;
		
		Попытка
			Book = XLSОбъект.Workbooks.Open(ПутьКФайлу, , Истина);
		Исключение
			Сообщить ("Проблемы с подключением к Excel" );
		КонецПопытки;
		
		Лист = Book.Sheets(1);
		КонечнаяСтрока = Лист.Cells.SpecialCells(11).Row;
		ЧислоСтрок = КонечнаяСтрока - 1;
		Область = Лист.Range(Лист.Cells(1,1), Лист.Cells(КонечнаяСтрока,40));	
		Данные = Область.Value.Выгрузить();
	КонецЕсли;	
	
КонецПроцедуры	

&НаСервереБезКонтекста
Функция НайтиНоменклатуру(Код)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Код = &Код
	|	И НЕ Номенклатура.ЭтоГруппа";
	Запрос.УстановитьПараметр("Код", Код);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Ссылка;			
	КонецЦикла;
	
	Возврат Справочники.Номенклатура.ПустаяСсылка();
	
КонецФункции	

&НаКлиенте
Процедура ТабличнаяЧастьНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	//Если Истина Тогда 		
	//	СтандартнаяОбработка = Ложь;
	//	ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаСписка", Новый Структура("ПометкаУдаления, РежимВыбора, ТекущаяСтрока", Истина, Истина, Элементы.ТабличнаяЧасть.ТекущиеДанные.Номенклатура), Элемент);
	//КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьНоменклатураАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
	
	Если Истина Тогда 	
		ПараметрыПолученияДанных.Отбор.Вставить("ПометкаУдаления",Ложь);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТабличнаяЧастьНоменклатураОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, СтандартнаяОбработка)
	
	Если Истина Тогда 	
		ПараметрыПолученияДанных.Отбор.Вставить("ПометкаУдаления",Ложь);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыКоличествоПриИзменении(Элемент)
	
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.Купажирование") Тогда
		
		Если Объект.ТабличнаяЧасть.Количество() Тогда
			Объект.ТабличнаяЧасть[0].Количество = Объект.Материалы.Итог("Количество");
		КонецЕсли;
	
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СпособВыпускаПриИзменении(Элемент)
	
	УстановитьОтборСтрокМатериалов();
	УстановитьОтборСтрокРаботыИРасценки();
	
	УстановитьВидимостьЭлементов();
	
КонецПроцедуры

Процедура УстановитьВидимостьЭлементов()
	
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.ПроизводствоПоСпецификации") Тогда
		//Элементы.МатериалыСклад.Видимость = Ложь;
		//Элементы.МатериалыСчетСписания.Видимость = Ложь;
		//Элементы.ДекорацияМатериалы.Видимость = Истина;
		//Элементы.ГруппаКомПанельМатериалы.Видимость = Ложь;
		Элементы.Группа4.Видимость = Истина;
		Элементы.Группа13.Видимость = Ложь;
		Если Не Элементы.Найти("ТабличнаяЧастьПерезаполнитьПоСпецификации") = Неопределено Тогда
			Элементы.ТабличнаяЧастьПерезаполнитьПоСпецификации.Видимость = Истина;
		КонецЕсли;
	ИначеЕсли Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.Купажирование") Тогда
		Элементы.Материалы.ОтборСтрок = Новый ФиксированнаяСтруктура();
		Если Не Элементы.Найти("ТабличнаяЧастьПерезаполнитьПоСпецификации") = Неопределено Тогда
			Элементы.ТабличнаяЧастьПерезаполнитьПоСпецификации.Видимость = Ложь;
		КонецЕсли;
		//Элементы.МатериалыСклад.Видимость = Истина;
		//Элементы.МатериалыСчетСписания.Видимость = Истина;
		//Элементы.ДекорацияМатериалы.Видимость = Ложь;
		//Элементы.ГруппаКомПанельМатериалы.Видимость = Истина;
		Элементы.Группа4.Видимость = Истина;
		Элементы.Группа13.Видимость = Ложь;
	ИначеЕсли Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацииВыпускаПродукции.ПоступлениеИзПереработки") Тогда
		Элементы.Материалы.ОтборСтрок = Новый ФиксированнаяСтруктура();
		Если Не Элементы.Найти("ТабличнаяЧастьПерезаполнитьПоСпецификации") = Неопределено Тогда
			Элементы.ТабличнаяЧастьПерезаполнитьПоСпецификации.Видимость = Ложь;
		КонецЕсли;
		//Элементы.МатериалыСклад.Видимость = Истина;
		//Элементы.МатериалыСчетСписания.Видимость = Истина;
		//Элементы.ДекорацияМатериалы.Видимость = Ложь;
		//Элементы.ГруппаКомПанельМатериалы.Видимость = Истина;
		Элементы.Группа4.Видимость = Истина;
		Элементы.Группа13.Видимость = Истина;
	Иначе
		Если Не Элементы.Найти("ТабличнаяЧастьПерезаполнитьПоСпецификации") = Неопределено Тогда
			Элементы.ТабличнаяЧастьПерезаполнитьПоСпецификации.Видимость = Ложь;
		КонецЕсли;
		Элементы.Группа4.Видимость = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	Если НоваяСтрока И НЕ Элементы.ТабличнаяЧасть.ТекущиеДанные = Неопределено Тогда
		Элемент.ТекущиеДанные.УИДТЧ = Элементы.ТабличнаяЧасть.ТекущиеДанные.УИД;
	КонецЕсли;	
	
	Если НоваяСтрока Тогда
		Элементы.Материалы.ТекущиеДанные.НесколькоСерий = Ложь;
	КонецЕсли; 
	
	//Синхронизация серий
	Если сабОбщегоНазначенияПовтИсп.ПолучитьСерийныйУчет() Тогда
		сабОперОбщегоНазначенияНаКлиенте.ЗаполнитьНомерИсходнойСтрокиДляСерии(Элемент.ТекущиеДанные);
	КонецЕсли;	

КонецПроцедуры


#Область КомандыИзменения

&НаКлиенте
Процедура ПоказатьИзмененияВерсий(ИмяКоманды)

	СсылкаНаОбъект = ЭтаФорма.ДокументБУ; 
	ПараметрыОтчета = Новый Структура;
	ПараметрыОтчета.Вставить("Ссылка",СсылкаНаОбъект);
	СтруктураКоличествВерсий = сабОбщегоНазначенияБУХ.ПолучитьКоличествоВерсий(СсылкаНаОбъект);
	КолВерсий = СтруктураКоличествВерсий.КоличествоИзмененныхВерсий;
	СравниваемыеВерсии = Новый СписокЗначений;  
	Пока КолВерсий > 0 Цикл
		СравниваемыеВерсии.Добавить(СтруктураКоличествВерсий.КоличествоВерсий, СтруктураКоличествВерсий.КоличествоВерсий);
		СтруктураКоличествВерсий.КоличествоВерсий = СтруктураКоличествВерсий.КоличествоВерсий - 1;
		КолВерсий = КолВерсий - 1;
	КонецЦикла;
	ПараметрыОтчета.Вставить("СравниваемыеВерсии",СравниваемыеВерсии); 
	
	ОткрытьФорму("РегистрСведений.ВерсииОбъектов.Форма.ОтчетПоВерсиямОбъекта", ПараметрыОтчета);

КонецПроцедуры

&НаКлиенте
Процедура ПерезаполнитьПоДокументу(ИмяКоманды)

	ПерезаполнитьДокументНаОснованиинаСервере();

КонецПроцедуры

&НаСервере
Процедура ПерезаполнитьДокументНаОснованиинаСервере()
	
	ТекОбъект = РеквизитФормыВЗначение("Объект");
	ТекОбъект.ОбработкаЗаполненияСФормы(ЭтаФорма.ДокументБУ, Неопределено, Истина);
	ЗначениеВРеквизитФормы(ТекОбъект, "Объект");
	
	//ОбновленнаяЗапись = РегистрыСведений.сабОбработкаДокументов.СоздатьМенеджерЗаписи();
	//ОбновленнаяЗапись.ДокументБУ = ЭтаФорма.ДокументБУ;
	//ОбновленнаяЗапись.ДокументУУ = Объект.Ссылка;
	//ОбновленнаяЗапись.ДатаОбработки = ТекущаяДата();
	//ОбновленнаяЗапись.Автор = ПараметрыСеанса.ТекущийПользователь;
	//ОбновленнаяЗапись.Модифицирован = Ложь;
	//ОбновленнаяЗапись.Записать();
	Элементы.ЭлементПерезаполнитьПоДокументу.Доступность = Ложь;
	
	ПриСозданииНаСервере(Ложь, Истина);
	
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	Оповестить("ОповеститьРегистрОбработанных", Новый Структура("ДокументУУ, ДокументБУ", Объект.Ссылка, ?(БюджетныйНаКлиенте.ЕстьСвойствоОбъекта(ЭтаФорма, "ДокументБУ"), ЭтаФорма.ДокументБУ, Неопределено)));	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ТекущийОбъект.ДополнительныеСвойства.Вставить("Модифицирован", Модифицированность ИЛИ НЕ ЗначениеЗаполнено(Объект.Ссылка));
	//ТекущийОбъект.ДополнительныеСвойства.Вставить("СрокОплаты", СрокОплаты);
КонецПроцедуры

&НаКлиенте
Процедура РаботыИРасценкиПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	Если НоваяСтрока И НЕ Элементы.ТабличнаяЧасть.ТекущиеДанные = Неопределено Тогда
		Элемент.ТекущиеДанные.УИДТЧ = Элементы.ТабличнаяЧасть.ТекущиеДанные.УИД;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РаботыИРасценкиКоличествоПриИзменении(Элемент)
	РассчитатьСумму(Элементы.РаботыИРасценки.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура РаботыИРасценкиЦенаПриИзменении(Элемент)
	РассчитатьСумму(Элементы.РаботыИРасценки.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСумму(СтрокаТабличнойЧасти) Экспорт
	СтрокаТабличнойЧасти.Сумма = СтрокаТабличнойЧасти.Количество * СтрокаТабличнойЧасти.Цена; 
КонецПроцедуры 

&НаКлиенте
Процедура МатериалыСерияНоменклатурыНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
	
		ТекДанные = Элементы.Материалы.ТекущиеДанные;
	//Если ТекДанные.НесколькоСерий Тогда
		МассивПараметрыВыбора = Новый Массив;
		НовыйПараметрДата = Новый ПараметрВыбора("ДатаОтгрузки",Объект.Дата);
		НовыйПараметрСчет = Новый ПараметрВыбора("Счет",ТекДанные.СчетУчета);  
		НовыйПараметрСклад = Новый ПараметрВыбора("Склад",?(ЗначениеЗаполнено(ТекДанные.Склад), ТекДанные.Склад, ?(ЗначениеЗаполнено(Объект.СкладМатериалов), Объект.СкладМатериалов, Объект.Склад)));
		НовыйПараметрПредприятие = Новый ПараметрВыбора("Предприятие",Объект.Предприятие);
		МассивПараметрыВыбора.Добавить(НовыйПараметрДата);   
		МассивПараметрыВыбора.Добавить(НовыйПараметрСчет);
		МассивПараметрыВыбора.Добавить(НовыйПараметрСклад);
		МассивПараметрыВыбора.Добавить(НовыйПараметрПредприятие);
		НовыеПараметры = Новый ФиксированныйМассив(МассивПараметрыВыбора);
		Если ТекДанные.НесколькоСерий Тогда
			СтандартнаяОбработка = Ложь; 
			ТекФорма = ПолучитьФорму("Документ.УЧ_Реализация.Форма.ФормаПодбораСерий"); 
			ТекФорма.Элементы.СерииНоменклатуры.ПодчиненныеЭлементы.СерииНоменклатурыСерияНоменклатуры.ПараметрыВыбора = НовыеПараметры;
			ТекФорма.Номенклатура = ТекДанные.Материал;
			ТекФорма.Количество = ТекДанные.Количество;
			ТекФорма.НомерСтрокиРеализации = ТекДанные.НомерСтроки;
			Для каждого ТекСтрока Из Объект.СерииНоменклатуры Цикл
				Если ТекСтрока.Номенклатура = ТекДанные.Материал И ТекСтрока.НомерСтрокиРеализации = ТекДанные.НомерСтроки Тогда
					НоваяСтрока = ТекФорма.СерииНоменклатуры.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрока);
				КонецЕсли;
			КонецЦикла;
			ТекФорма.РежимОткрытияОкна = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
			Оп = Новый ОписаниеОповещения("ВыполнитьПослеОкончанияПодбора", ЭтотОбъект, Новый Структура);
			ТекФорма.ОписаниеОповещенияОЗакрытии = Оп;
			ТекФорма.Открыть();
		Иначе
			Элемент.ПараметрыВыбора = НовыеПараметры;
		КонецЕсли;
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьПослеОкончанияПодбора(Результат, Параметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекДанные = Элементы.Материалы.ТекущиеДанные;
	МассивУдСерий = Новый Массив;
	Для каждого ТекСтрока Из Объект.СерииНоменклатуры Цикл
		Если ТекСтрока.Номенклатура = ТекДанные.Материал И ТекСтрока.НомерСтрокиРеализации = ТекДанные.НомерСтроки Тогда
			МассивУдСерий.Добавить(ТекСтрока);
		КонецЕсли;
	КонецЦикла;
	
	Для каждого ТекУд Из МассивУдСерий Цикл
		Объект.СерииНоменклатуры.Удалить(ТекУд);
	КонецЦикла;
	
	НовоеКоличество = 0;
	Для каждого ТекСтрока Из Результат.СерииНоменклатуры Цикл
		НоваяСтрока = Объект.СерииНоменклатуры.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрока);
		НоваяСтрока.НомерСтрокиРеализации = ТекДанные.НомерСтроки;
		НовоеКоличество = НовоеКоличество + ТекСтрока.Количество; 
		НоваяСтрока.ДатаПроизводства = сабОбщегоНазначенияБУХ.ПолучитьДатуПроизводстваДляСерииНоменклатуры(ТекСтрока.СерияНоменклатуры);
	КонецЦикла;
	
	ТекДанные.Количество = НовоеКоличество; 
	Объект.СерииНоменклатуры.Сортировать("НомерСтрокиРеализации");
	МатериалыКоличествоПриИзменении(Неопределено);

КонецПроцедуры

&НаКлиенте
Процедура МатериалыСерияНоменклатурыПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Материалы.ТекущиеДанные;
	сабОперОбщегоНазначенияНаКлиенте.ЗаполнитьТЧСерииПриИзмененииСерииВОсновнойТЧ(ТекущиеДанные,Объект.СерииНоменклатуры,"Материал");
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	ЗаполнитьДобавленныеКолонки();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДобавленныеКолонки()

	Для Каждого СтрокаТЧ Из Объект.Материалы Цикл
		//НайденныеСтроки = ТаблицаАртикулов.НайтиСтроки(Новый Структура("Ссылка", СтрокаТЧ.Номенклатура));
		//Для Каждого СтрокаСАртикулом Из НайденныеСтроки Цикл
		//	СтрокаТЧ.Артикул = СтрокаСАртикулом.Код;
		//	СтрокаТЧ.ЕдиницаИзмерения = СтрокаСАртикулом.ЕдиницаИзмерения;
		//КонецЦикла;
		
		Если ИспользоватьСерии Тогда
			НайденныеСерии = Объект.СерииНоменклатуры.НайтиСтроки(Новый Структура("Номенклатура, НомерСтрокиРеализации", СтрокаТЧ.Материал, СтрокаТЧ.НомерСтроки));
			Если НайденныеСерии.Количество() > 1 Тогда
				СтрокаТЧ.НесколькоСерий = Истина;
				СтрокаТЧ.СерияНоменклатуры = Неопределено;
			КонецЕсли;
		КонецЕсли;
	
	КонецЦикла;	

КонецПроцедуры

#Область ПодборТоваров

&НаКлиенте
Процедура Подобрать(Команда)
	
	ОписаниеОповещенияПослеПодбора = Новый ОписаниеОповещения("ЗаполнитьТоварыПоПодбору",ЭтотОбъект);
	СтруктураПараметров = Новый Структура("Склад,Предприятие,Заголовок",Объект.Склад,Объект.Предприятие, "Подбор товаров для документа " + Объект.Ссылка);
	ОткрытьФорму("Справочник.Номенклатура.Форма.ФормаДляПодбора",СтруктураПараметров,ЭтотОбъект,УникальныйИдентификатор,,,ОписаниеОповещенияПослеПодбора,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры 

&НаКлиенте
Процедура ЗаполнитьТоварыПоПодбору(Результат,ДопПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		Если ЭтоАдресВременногоХранилища(Результат) Тогда
			ЗаполнитьПоПодборуНаСервере(Результат);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоПодборуНаСервере(АдресВХ)
	
	ТЗДанныеПодбора = ПолучитьИзВременногоХранилища(АдресВХ);	
	Если ТипЗнч(ТЗДанныеПодбора) = Тип("ТаблицаЗначений") Тогда
		Для Каждого СтрокаТовара Из ТЗДанныеПодбора Цикл
			НайденныеСтроки = Объект.ТабличнаяЧасть.НайтиСтроки(Новый Структура("Номенклатура",СтрокаТовара.Номенклатура));
			Если НайденныеСтроки.Количество() > 0 Тогда 
				ТекДанные = НайденныеСтроки[0];
				//Если АльтернативнаяФорма Тогда
						ТекДанные.Количество = ТекДанные.Количество + СтрокаТовара.Количество; 
				//Иначе
				//	ТекДанные.КоличествоУпаковок = ТекДанные.КоличествоУпаковок + СтрокаТовара.Количество; 
				//	ТекДанные.Количество = ТекДанные.КоэффициентПересчетаУпаковок * ТекДанные.КоличествоУпаковок;
				//КонецЕсли;
				//ТекДанные.Сумма = ТекДанные.Количество * ТекДанные.Цена;
				//ТекРеквизиты = БюджетныйНаСервере.ВернутьРеквизиты(ТекДанные.СтавкаНДС, "Ставка");
				//Если НЕ ТекРеквизиты = Неопределено Тогда
				//	ТекДанные.СуммаНДС = ТекДанные.Сумма / ((100+ТекРеквизиты.Ставка)/100) * (ТекРеквизиты.Ставка/100);
				//КонецЕсли;
				//Если АльтернативнаяФорма Тогда
				//	Если ТипЗнч(ТекДанные.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения") Тогда
				//		СтруктураВозврата = ПолучитьКоличествоВУпаковкеПоУмолчаниюДляНоменклатуры(ТекДанные.Номенклатура);
				//		ТекДанные.КоэффициентПересчетаУпаковок = СтруктураВозврата.Коэффициент;
				//		ПредставлениеУпаковки = СтруктураВозврата.Упаковка;
				//		ПредставлениеЕдИзмерения = ТекДанные.ЕдиницаИзмерения; 
				//	Иначе
				//		ТекДанные.КоэффициентПересчетаУпаковок = ПолучитьКоэффициентПересчетаУпаковок(ТекДанные.Номенклатура, ТекДанные.ЕдиницаИзмерения);
				//		ПредставлениеУпаковки = ТекДанные.ЕдиницаИзмерения; 
				//		ПредставлениеЕдИзмерения = ПолучитьПредставлениеЕдиницыУпаковки(ТекДанные.Номенклатура,ТекДанные.ЕдиницаИзмерения);
				//	КонецЕсли;
				//	ТекДанные.КоличествоВУпаковке = ТекДанные.КоэффициентПересчетаУпаковок;
				//	ТекДанные.КоличествоУпаковок = Цел(?(ТекДанные.КоэффициентПересчетаУпаковок = 0,0,ТекДанные.Количество / ТекДанные.КоэффициентПересчетаУпаковок)); 
				//	Если ТекДанные.КоличествоВУпаковке = 0 ИЛИ ТекДанные.КоличествоВУпаковке = 1 Тогда
				//		КолУпаковок = 0;
				//		КолЕдиниц = ТекДанные.Количество;
				//		ТекДанные.КоличествоУпаковокПредставление = "" + КолУпаковок + " " + ПредставлениеУпаковки + ","  +
				//		КолЕдиниц + " " + ПредставлениеЕдИзмерения;
				//	Иначе
				//		КолУпаковок = Цел(ТекДанные.Количество / ТекДанные.КоличествоВУпаковке);
				//		КолЕдиниц = ТекДанные.Количество - (КолУпаковок * ТекДанные.КоличествоВУпаковке);
				//		ТекДанные.КоличествоУпаковокПредставление = "" + КолУпаковок + " " + ПредставлениеУпаковки + ", " +
				//		КолЕдиниц + " " + ПредставлениеЕдИзмерения;
				//	КонецЕсли;
				//	
				//КонецЕсли;
			Иначе
				НоваяСтрокаТовары = Объект.ТабличнаяЧасть.Добавить();
				НоваяСтрокаТовары.Номенклатура = СтрокаТовара.Номенклатура;
				//НоваяСтрокаТовары.Цена = СтрокаТовара.Цена;
				ТекДанные = НоваяСтрокаТовары; 
				//Установим единицу измерения по умолчанию
				//Если АльтернативнаяФорма Тогда
				//	ТекДанные.ЕдиницаИзмерения = НоваяСтрокаТовары.Номенклатура.ЕдиницаИзмерения;
				//Иначе
				//ТекДанные.ЕдиницаИзмерения = ПолучитьЕдИзмНоменклатуры(ТекДанные.Номенклатура);
				//КонецЕсли;
				//МассивЕдИзмНоменклатуры = ПолучитьМассивВозможныхЕдиницИзмеренияНоменклатуры(ТекДанные.Номенклатура);
				//Элементы.ТабличнаяЧастьЕдиницаИзмерения.СписокВыбора.Очистить();
				//Для Каждого ЭлементВыборкаЕдИзм Из МассивЕдИзмНоменклатуры Цикл
				//	Элементы.ТабличнаяЧастьЕдиницаИзмерения.СписокВыбора.Добавить(ЭлементВыборкаЕдИзм);
				//КонецЦикла;
				//ТекДанные.КоэффициентПересчетаУпаковок = ПолучитьКоэффициентПересчетаУпаковок(ТекДанные.Номенклатура, ТекДанные.ЕдиницаИзмерения);
				//Если АльтернативнаяФорма Тогда 
					ТекДанные.Количество = СтрокаТовара.Количество;
				//	ЗаполнитьПредставлениеУпаковок(ТекДанные);
				//Иначе 
				//	ТекДанные.КоэффициентПересчетаУпаковок = ПолучитьКоэффициентПересчетаУпаковок(ТекДанные.Номенклатура, ТекДанные.ЕдиницаИзмерения);
				//	ТекДанные.КоличествоУпаковок = СтрокаТовара.Количество; 
				//	ТекДанные.Количество = ТекДанные.КоэффициентПересчетаУпаковок * ТекДанные.КоличествоУпаковок;
				//КонецЕсли;  
				//ТекДанные.КоличествоВУпаковке = ТекДанные.КоэффициентПересчетаУпаковок;  
				//ТекДанные.Сумма = ТекДанные.Количество * ТекДанные.Цена;
				
				//Установим НДС и артикул
				//Если ЗначениеЗаполнено(ТекДанные.Номенклатура) Тогда
				//	ТекРеквизиты = БюджетныйНаСервере.ВернутьРеквизиты(ТекДанные.Номенклатура, "СтавкаНДС, Код, Счет10, ВидСтавкиНДС, ЕдиницаИзмерения, Кратность, МинимальнаяПартия", Ложь);
				//	ТекДанные.СтавкаНДС = сабОбщегоНазначенияБУХПовтИсп.СоотвВидовСтавокНДСБУХУУ().Получить(ТекРеквизиты.ВидСтавкиНДС);;
				//	//ТекДанные.Кратность = ТекРеквизиты.Кратность; 
				//	ТекРеквизиты = БюджетныйНаСервере.ВернутьРеквизиты(ТекДанные.СтавкаНДС, "Ставка");
				//	Если НЕ ТекРеквизиты = Неопределено Тогда
				//		ТекДанные.СуммаНДС = ТекДанные.Сумма / ((100+ТекРеквизиты.Ставка)/100) * (ТекРеквизиты.Ставка/100);
				//	КонецЕсли;
				//КонецЕсли;
				Если ЗначениеЗаполнено(Объект.Склад) Тогда
					ТекДанные.Склад = Объект.Склад;	
				КонецЕсли;
				СтруктураДанных =Новый Структура("Номенклатура, Склад, Количество", 
				ТекДанные.Номенклатура, ТекДанные.Склад, ТекДанные.Количество);
				//ЗаполнитьОстаткиИРезервы(Истина, СтруктураДанных);
				//ЗаполнитьКонтрольМинЦены(Истина, СтруктураДанных);
				ЗаполнитьЗначенияСвойств(ТекДанные, СтруктураДанных);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

&НаСервереБезКонтекста
Функция ПолучитьКоличествоВУпаковкеПоУмолчаниюДляНоменклатуры(Номенклатура) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УпаковкиНоменклатуры.Коэффициент КАК Коэффициент,
	|	УпаковкиНоменклатуры.ОсновнаяУпаковка КАК ОсновнаяУпаковка,
	|	УпаковкиНоменклатуры.Упаковка.Представление КАК Упаковка
	|ИЗ
	|	РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
	|ГДЕ
	|	УпаковкиНоменклатуры.Номенклатура = &Номенклатура";
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	СтруктураВозврата = Новый Структура("Упаковка,Коэффициент");
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Если Выборка.Количество() > 1 Тогда
		Пока Выборка.Следующий() Цикл
			Если Выборка.ОсновнаяУпаковка Тогда
				СтруктураВозврата.Упаковка = Выборка.Упаковка;
				СтруктураВозврата.Коэффициент = Выборка.Коэффициент;
				Возврат СтруктураВозврата; 
			КонецЕсли;
		КонецЦикла;
		Выборка.Сбросить();
		Выборка.Следующий(); 
		СтруктураВозврата.Упаковка = Выборка.Упаковка;
		СтруктураВозврата.Коэффициент = Выборка.Коэффициент;
		Возврат СтруктураВозврата; 
	Иначе
		Если Выборка.Следующий() Тогда
			СтруктураВозврата.Упаковка = Выборка.Упаковка;
			СтруктураВозврата.Коэффициент = Выборка.Коэффициент;
			Возврат СтруктураВозврата; 
		КонецЕсли;
	КонецЕсли; 
	СтруктураВозврата.Упаковка = "уп.";
	СтруктураВозврата.Коэффициент = 1;
	Возврат СтруктураВозврата; 
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьКоэффициентПересчетаУпаковок(Номенклатура, ЕдиницаИзмерения) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УпаковкиНоменклатуры.Коэффициент
	|ИЗ
	|	РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
	|ГДЕ
	|	УпаковкиНоменклатуры.Номенклатура = &Номенклатура
	|	И УпаковкиНоменклатуры.Упаковка = &Упаковка
	|	И УпаковкиНоменклатуры.ЕдиницаИзмерения = &ЕдиницаИзмерения";
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Упаковка", ЕдиницаИзмерения);
	Запрос.УстановитьПараметр("ЕдиницаИзмерения", Номенклатура.ЕдиницаИзмерения);
	
	Выборка = запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Коэффициент;		
	КонецЦикла;
	
	Возврат 1;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьПредставлениеЕдиницыУпаковки(Номенклатура = Неопределено, ЕдиницаИзмерения = Неопределено, ДляОднойНоменклатуры = Истина, ТЗДанные = Неопределено) Экспорт
	
	Если ДляОднойНоменклатуры Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	УпаковкиНоменклатуры.ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения 
		|ИЗ
		|	РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
		|ГДЕ
		|	УпаковкиНоменклатуры.Номенклатура = &Номенклатура
		|	И УпаковкиНоменклатуры.Упаковка = &Упаковка";
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Упаковка", ЕдиницаИзмерения);
		
		Выборка = запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			Возврат Выборка.ЕдиницаИзмерения;		
		КонецЦикла;
		
		Возврат ЕдиницаИзмерения.Наименование;
	Иначе
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТЗНоменклатураУпаковки.Номенклатура КАК Номенклатура,
		|	ТЗНоменклатураУпаковки.ЕдиницаИзмерения КАК Упаковка
		|ПОМЕСТИТЬ ВТНоменклатураУпаковка
		|ИЗ
		|	&ТЗНоменклатураУпаковки КАК ТЗНоменклатураУпаковки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(УпаковкиНоменклатуры.ЕдиницаИзмерения.Представление, ВТНоменклатураУпаковка.Упаковка) КАК ЕдиницаИзмерения, 
		|	ВТНоменклатураУпаковка.Упаковка КАК Упаковка,
		|	ВТНоменклатураУпаковка.Упаковка.Представление КАК УпаковкаПредставление,
		|	ВТНоменклатураУпаковка.Номенклатура КАК Номенклатура
		|ИЗ
		|	ВТНоменклатураУпаковка КАК ВТНоменклатураУпаковка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
		|		ПО ВТНоменклатураУпаковка.Номенклатура = УпаковкиНоменклатуры.Номенклатура
		|			И ВТНоменклатураУпаковка.Упаковка = УпаковкиНоменклатуры.Упаковка";
		Запрос.УстановитьПараметр("ТЗНоменклатураУпаковки",ТЗДанные);
		
		Выборка = запрос.Выполнить().Выбрать();
		Возврат Выборка;
	КонецЕсли;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьЕдИзмНоменклатуры(Номенклатура) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УпаковкиНоменклатуры.Упаковка
	|ИЗ
	|	РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
	|ГДЕ
	|	УпаковкиНоменклатуры.Номенклатура = &Номенклатура
	|	И УпаковкиНоменклатуры.ОсновнаяУпаковка";
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Упаковка;		
	КонецЦикла;	
	
	Возврат Номенклатура.ЕдиницаИзмерения;	
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьМассивВозможныхЕдиницИзмеренияНоменклатуры(Номенклатура) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УпаковкиНоменклатуры.Упаковка
	|ИЗ
	|	РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
	|ГДЕ
	|	УпаковкиНоменклатуры.Номенклатура = &Номенклатура"; 
	АльтернативнаяФорма = Справочники.сабМониторВнедрения.ПолучитьЗначениеНастройки("АльтернативнаяФормаЗаказов");
	Если АльтернативнаяФорма Тогда
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	УпаковкиНоменклатуры.ЕдиницаИзмерения КАК Упаковка
		|ИЗ
		|	РегистрСведений.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
		|ГДЕ
		|	УпаковкиНоменклатуры.Номенклатура = &Номенклатура
		|	И УпаковкиНоменклатуры.ЕдиницаИзмерения <> &ЕдиницаИзмерения"; 
		Запрос.УстановитьПараметр("ЕдиницаИзмерения", Номенклатура.ЕдиницаИзмерения);
	КонецЕсли;
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	АльтернативнаяФорма = Справочники.сабМониторВнедрения.ПолучитьЗначениеНастройки("АльтернативнаяФормаЗаказов");
	ТаблицаУпаковок = Запрос.Выполнить().Выгрузить();
	ТаблицаУпаковок.Свернуть("Упаковка");
	МассивУпаковок = ТаблицаУпаковок.ВыгрузитьКолонку("Упаковка");
	МассивУпаковок.Вставить(0, Номенклатура.ЕдиницаИзмерения);
	Возврат МассивУпаковок;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Процедура ЗаполнитьПредставлениеУпаковок(ТекДанные)
	
	Если ТипЗнч(ТекДанные.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения") Тогда
		СтруктураВозврата =ПолучитьКоличествоВУпаковкеПоУмолчаниюДляНоменклатуры(ТекДанные.Номенклатура);
		ТекДанные.КоэффициентПересчетаУпаковок = СтруктураВозврата.Коэффициент;
		ПредставлениеУпаковки = СтруктураВозврата.Упаковка;
		ПредставлениеЕдИзмерения = ТекДанные.ЕдиницаИзмерения; 
	Иначе
		ТекДанные.КоэффициентПересчетаУпаковок = ПолучитьКоэффициентПересчетаУпаковок(ТекДанные.Номенклатура, ТекДанные.ЕдиницаИзмерения);
		ПредставлениеУпаковки = ТекДанные.ЕдиницаИзмерения; 
		ПредставлениеЕдИзмерения = ПолучитьПредставлениеЕдиницыУпаковки(ТекДанные.Номенклатура,ТекДанные.ЕдиницаИзмерения);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекДанные.ЕдиницаИзмерения) И ЗначениеЗаполнено(ТекДанные.КоэффициентПересчетаУпаковок) Тогда
		ТекДанные.КоличествоВУпаковкеПредставление = "(" +  Строка(ТекДанные.КоэффициентПересчетаУпаковок) + " " + ПредставлениеЕдИзмерения +")";
	Иначе
		ТекДанные.КоличествоВУпаковкеПредставление = Строка(ТекДанные.КоэффициентПересчетаУпаковок);
	КонецЕсли;
	Если ТекДанные.КоэффициентПересчетаУпаковок = 0 ИЛИ ТекДанные.КоэффициентПересчетаУпаковок = 1 Тогда
		КолУпаковок = 0;
		КолЕдиниц = ТекДанные.Количество;
		ТекДанные.КоличествоУпаковокПредставление = "" + КолУпаковок + " "  + ПредставлениеУпаковки + "," +
		КолЕдиниц + " " + ПредставлениеЕдИзмерения;
	Иначе
		КолУпаковок = Цел(ТекДанные.Количество / ТекДанные.КоэффициентПересчетаУпаковок);
		КолЕдиниц = ТекДанные.Количество - (КолУпаковок * ТекДанные.КоэффициентПересчетаУпаковок);
		ТекДанные.КоличествоУпаковокПредставление = "" + КолУпаковок + " " + ПредставлениеУпаковки + ", " +
		КолЕдиниц + " " + ПредставлениеЕдИзмерения;
	КонецЕсли; 
	ТекДанные.КоличествоУпаковок = Цел(?(ТекДанные.КоэффициентПересчетаУпаковок = 0,0,ТекДанные.Количество / ТекДанные.КоэффициентПересчетаУпаковок)); 
    ТекДанные.КоличествоВУпаковке = ТекДанные.КоэффициентПересчетаУпаковок;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьСерииПоФИФО(Команда)
	ЗаполнитьСерииПоФИФОНаСервере(Команда.Имя);
	Модифицированность = Истина;
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСерииПоФИФОНаСервере(КомандаИмя)
	
	ДокОбъект = РеквизитФормыВЗначение("Объект");
	
	СтруктураИмен = УЧ_Сервер.СформироватьСтруктуруИмен(ДокОбъект);
	
	СтруктураСоответствий = УЧ_Сервер.ПоучитьСоответствияСчетовНоменклатуры(ДокОбъект, СтруктураИмен);
	СоответствиеСчета = СтруктураСоответствий.Соответствия;
	СоответствиеУчетаПоПодразделениям = СтруктураСоответствий.СоответствияУчетаПодразделений;
	
	ТаблицаОстатков = УЧ_Сервер.ПолучитьТаблицуОстатков(ДокОбъект, СтруктураИмен, СтруктураСоответствий,,Истина);
	РезультатОстатки = ТаблицаОстатков.РезультатОстатки;
	
	РезультатОстатки.Свернуть("Номенклатура, Склад, СерияНоменклатуры, Подразделение, Предприятия", "Количество, Сумма"); 
	
	РезультатОстатки.Колонки.Добавить("ДатаПроизводства", Новый ОписаниеТипов("Дата",,,));
	
	Серии = Новый Массив;
	МассивУдаленных = Новый Массив;
	Для каждого ТекСтрока Из РезультатОстатки Цикл
		Если ТекСтрока.Количество > 0 И ЗначениеЗаполнено(ТекСтрока.СерияНоменклатуры) И Серии.Найти(ТекСтрока.СерияНоменклатуры) = Неопределено Тогда
			Серии.Добавить(ТекСтрока.СерияНоменклатуры);
		Иначе
			МассивУдаленных.Добавить(ТекСтрока);
		КонецЕсли;
	КонецЦикла;
	
	Для каждого ТекУд Из МассивУдаленных Цикл
		РезультатОстатки.Удалить(ТекУд);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СерииНоменклатуры.Ссылка КАК СерияНоменклатуры,
	               |	СерииНоменклатуры.ДатаПроизводства КАК ДатаПроизводства,
	               |	СерииНоменклатуры.ГоденДо КАК ГоденДо
	               |ИЗ
	               |	Справочник.СерииНоменклатуры КАК СерииНоменклатуры
	               |ГДЕ
	               |	СерииНоменклатуры.Ссылка В(&Серии)
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ДатаПроизводства
	               |АВТОУПОРЯДОЧИВАНИЕ";
	
	Запрос.УстановитьПараметр("Серии", Серии);
	
	Результат = Запрос.Выполнить();
	ВыборкаСерии = Результат.Выгрузить();
	
	Для каждого ТекСтрока Из РезультатОстатки Цикл
		НайденныйСтроки = ВыборкаСерии.НайтиСтроки(Новый Структура("СерияНоменклатуры", ТекСтрока.СерияНоменклатуры));
		Для каждого ТекНайд Из НайденныйСтроки Цикл
			ТекСтрока.ДатаПроизводства = ТекНайд.ДатаПроизводства;		
		КонецЦикла;
	КонецЦикла;
	
	РезультатОстатки.Сортировать("ДатаПроизводства");
	
	Если КомандаИмя = "ЗаполнитьСерииПоФИФО1" Тогда
		Объект.СерииНоменклатуры.Очистить();	
	КонецЕсли;
	
	СерииРезультат = Объект.СерииНоменклатуры.Выгрузить();
	
	Для каждого ТекСтрока Из Объект.Материалы Цикл
		
		Если КомандаИмя = "ЗаполнитьСерииПоФИФО1" Тогда
			ТекСтрока.СерияНоменклатуры = Неопределено;
			ТекСтрока.НесколькоСерий = Ложь;	
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ТекСтрока.СерияНоменклатуры) ИЛИ ТекСтрока.НесколькоСерий Тогда
			Продолжить;		
		КонецЕсли;
		
		СерииРезультат.Очистить();
		
		НайденныйСтроки = РезультатОстатки.НайтиСтроки(Новый Структура("Номенклатура", ТекСтрока.Материал));
		
		КоличествоНужно = ТекСтрока.Количество;
		Для каждого ТекНайд Из НайденныйСтроки Цикл
			Если Не ТекНайд.Количество ИЛИ ТекНайд.Количество < 0 Тогда
				Продолжить;			
			КонецЕсли;
			Если ТекНайд.Количество >= КоличествоНужно Тогда
				ТекНайд.Количество = ТекНайд.Количество - ТекСтрока.Количество;
				ТекСтрока.СерияНоменклатуры = ТекНайд.СерияНоменклатуры;	
				НоваяСтрока = СерииРезультат.Добавить();
				НоваяСтрока.Номенклатура = ТекСтрока.Материал;
				НоваяСтрока.СерияНоменклатуры = ТекНайд.СерияНоменклатуры;
				НоваяСтрока.ИдентификаторСтрокиРеализации = ТекСтрока.НомерСтроки;
				НоваяСтрока.Количество = КоличествоНужно;
				КоличествоНужно = 0;
				Прервать;
			Иначе
				НоваяСтрока = СерииРезультат.Добавить();
				НоваяСтрока.Номенклатура = ТекСтрока.Материал;
				НоваяСтрока.СерияНоменклатуры = ТекНайд.СерияНоменклатуры;
				НоваяСтрока.ИдентификаторСтрокиРеализации = ТекСтрока.НомерСтроки;
				НоваяСтрока.Количество = ТекНайд.Количество;
				КоличествоНужно = КоличествоНужно - ТекНайд.Количество;
				ТекНайд.Количество = 0;
			КонецЕсли;
		КонецЦикла;
		
		Если КоличествоНужно Тогда
			НоваяСтрока = СерииРезультат.Добавить();
			НоваяСтрока.Номенклатура = ТекСтрока.Материал;
			НоваяСтрока.СерияНоменклатуры = Справочники.СерииНоменклатуры.ПустаяСсылка();
			НоваяСтрока.ИдентификаторСтрокиРеализации = ТекСтрока.НомерСтроки;
			НоваяСтрока.Количество = КоличествоНужно;
		КонецЕсли;
		
		Если СерииРезультат.Количество() Тогда
			
			ТекСтрока.НесколькоСерий = СерииРезультат.Количество() > 1;
			
			МассивУдСерий = Новый Массив;
			Для каждого ТекСтрокаОб Из Объект.СерииНоменклатуры Цикл
				Если ТекСтрокаОб.Номенклатура = ТекСтрока.Материал И ТекСтрокаОб.НомерСтрокиРеализации = ТекСтрока.НомерСтроки Тогда
					МассивУдСерий.Добавить(ТекСтрокаОб);
				КонецЕсли;
			КонецЦикла;
			
			Для каждого ТекУд Из МассивУдСерий Цикл
				Объект.СерииНоменклатуры.Удалить(ТекУд);
			КонецЦикла;
			
			НовоеКоличество = 0;
			Для каждого ТекСтрокаОб Из СерииРезультат Цикл
				НоваяСтрока = Объект.СерииНоменклатуры.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрокаОб);
				НоваяСтрока.НомерСтрокиРеализации = ТекСтрока.НомерСтроки;
				НовоеКоличество = НовоеКоличество + ТекСтрокаОб.Количество; 
				НоваяСтрока.ДатаПроизводства = сабОбщегоНазначенияБУХ.ПолучитьДатуПроизводстваДляСерииНоменклатуры(ТекСтрокаОб.СерияНоменклатуры);
			КонецЦикла;
			
			Объект.СерииНоменклатуры.Сортировать("НомерСтрокиРеализации");
			
		КонецЕсли;
		
		
	КонецЦикла;
	
	
	
	
КонецПроцедуры


&НаКлиенте
Процедура ТабличнаяЧастьСерияНоменклатурыНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
		ТекДанные = Элементы.ТабличнаяЧасть.ТекущиеДанные;
		МассивПараметрыВыбора = Новый Массив;
		НовыйПараметрДата = Новый ПараметрВыбора("ДатаОтгрузки",Объект.Дата);
		НовыйПараметрСчет = Новый ПараметрВыбора("Счет",ТекДанные.СчетУчета);  
		НовыйПараметрСклад = Новый ПараметрВыбора("Склад",?(ЗначениеЗаполнено(ТекДанные.Склад), ТекДанные.Склад, Объект.Склад));
		НовыйПараметрПредприятие = Новый ПараметрВыбора("Предприятие",Объект.Предприятие);
		МассивПараметрыВыбора.Добавить(НовыйПараметрДата);   
		МассивПараметрыВыбора.Добавить(НовыйПараметрСчет);
		МассивПараметрыВыбора.Добавить(НовыйПараметрСклад);
		МассивПараметрыВыбора.Добавить(НовыйПараметрПредприятие);
		НовыеПараметры = Новый ФиксированныйМассив(МассивПараметрыВыбора);
		Элементы.ТабличнаяЧастьСерияНоменклатуры.ПараметрыВыбора = НовыеПараметры;
КонецПроцедуры

