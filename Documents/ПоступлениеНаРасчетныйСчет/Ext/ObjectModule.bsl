
&Перед("ПередЗаписью")
Процедура УУ_ПередЗаписью1(Отказ, РежимЗаписи, РежимПроведения) 

	Если Модифицированность() Тогда
		Если ДополнительныеСвойства.Свойство("НеДобавлятьЗаписьВРегистрИзмененных") Тогда
			Если Не ДополнительныеСвойства.НеДобавлятьЗаписьВРегистрИзмененных Тогда
				сабОбщегоНазначенияБУХ.УстановитьМодифицированностьБУДокумента(ЭтотОбъект, Ссылка, РежимЗаписи);
			КонецЕсли;
		Иначе
			сабОбщегоНазначенияБУХ.УстановитьМодифицированностьБУДокумента(ЭтотОбъект, Ссылка, РежимЗаписи);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&После("ОбработкаПроведения")
Процедура УУ_ОбработкаПроведения(Отказ, РежимПроведения)
	
	Для каждого ТекСтрока Из ЭтотОбъект.РасшифровкаПлатежа Цикл
		Если ЗначениеЗаполнено(ТекСтрока.СчетНаОплату) И ТипЗнч(ТекСтрока.СчетНаОплату) = Тип("ДокументСсылка.СчетНаОплатуПокупателю") Тогда
			
						
			НаборЗаписей = РегистрыСведений.сабГрафикПлатежей.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Документ.Установить(ТекСтрока.СчетНаОплату);
			НаборЗаписей.Прочитать();
			
			ТекСумма = 0;
			Если НаборЗаписей.Количество() Тогда
				
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ
				|	ЕСТЬNULL(СУММА(ПоступлениеНаРасчетныйСчетРасшифровкаПлатежа.СуммаПлатежа), 0) КАК СуммаПлатежа
				|ИЗ
				|	Документ.ПоступлениеНаРасчетныйСчет.РасшифровкаПлатежа КАК ПоступлениеНаРасчетныйСчетРасшифровкаПлатежа
				|ГДЕ
				|	НЕ ПоступлениеНаРасчетныйСчетРасшифровкаПлатежа.Ссылка = &Ссылка
				|	И ПоступлениеНаРасчетныйСчетРасшифровкаПлатежа.СчетНаОплату = &СчетНаОплату";
				
				Запрос.УстановитьПараметр("Ссылка", Ссылка);
				Запрос.УстановитьПараметр("СчетНаОплату", ТекСтрока.СчетНаОплату);
				
				Результат = Запрос.Выполнить();
				Выборка = Результат.Выбрать();
				
				Пока Выборка.Следующий() Цикл
					СуммаУжеОплачено = Выборка.СуммаПлатежа;			
				КонецЦикла;
				
				ТекСумма = ТекСтрока.СчетНаОплату.СуммаДокумента - ЭтотОбъект.СуммаДокумента - СуммаУжеОплачено;
				Если ТекСумма > 0 Тогда
					Для каждого ТекЗапись Из НаборЗаписей Цикл
						ТекЗапись.Сумма = ТекСумма; 
					КонецЦикла;
				Иначе	
					НаборЗаписей.Очистить();
				КонецЕсли;
				НаборЗаписей.Записать();
				
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ТекСтрока.СчетНаОплату.Заказ) И 
				(ТекСтрока.СчетНаОплату.Заказ.СтатусОплаты = Перечисления.СтатусыОплатыЗаказовКлиентов.НеОплачен 
					ИЛИ Не ЗначениеЗаполнено(ТекСтрока.СчетНаОплату.Заказ.СтатусОплаты)) Тогда
				ТекОбЗаказ = ТекСтрока.СчетНаОплату.Заказ.ПолучитьОбъект();
				Если ТекОбЗаказ.СуммаДокумента <= ЭтотОбъект.СуммаДокумента Тогда
					ТекОбЗаказ.СтатусОплаты = Перечисления.СтатусыОплатыЗаказовКлиентов.Оплачен;
					ТекОбЗаказ.Записать();
				ИначеЕсли ТекСумма Тогда 
					ТекОбЗаказ.СтатусОплаты = Перечисления.СтатусыОплатыЗаказовКлиентов.ОплаченЧастично;
					ТекОбЗаказ.Записать();
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
