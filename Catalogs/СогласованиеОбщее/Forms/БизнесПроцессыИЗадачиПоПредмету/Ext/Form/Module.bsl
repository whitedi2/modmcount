
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//ИспользоватьДатуИВремяВСрокахЗадач = РаботаСБизнесПроцессами.ПолучитьИспользованиеДатыИВремениВСрокахЗадач();
	//Элементы.ДеревоЗадачСрокИсполнения.Формат = ?(ИспользоватьДатуИВремяВСрокахЗадач, "ДФ='дд.ММ.гггг ЧЧ:мм'", "ДЛФ=D");
	
	Если ТипЗнч(Параметры.Предмет) = Тип("СправочникСсылка.Задача") Тогда
		Параметры.Предмет = Параметры.Предмет.Заявка;	
	КонецЕсли;
	
	Если Параметры.Свойство("НезависимоеОкно") Тогда
		Заголовок = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Процессы и Справочники по предмету ""%1""'"), Строка(Параметры.Предмет));
	КонецЕсли;	
	
	ЗаполнитьДеревоЗадач();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ЗадачаИзменена" ИЛИ ИмяСобытия = "ЗадачаВыполнена" ИЛИ ИмяСобытия = "БизнесПроцессИзменен" Тогда 
		ЗаполнитьДеревоЗадач();
		Для каждого Строка ИЗ ДеревоЗадач.ПолучитьЭлементы() Цикл
			Элементы.ДеревоЗадач.Развернуть(Строка.ПолучитьИдентификатор(), Истина);
		КонецЦикла;
	КонецЕсли;
	
	Для каждого Строка ИЗ ДеревоЗадач.ПолучитьЭлементы() Цикл
		Элементы.ДеревоЗадач.Развернуть(Строка.ПолучитьИдентификатор(), Истина);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоЗадач()
	
	Дерево = РеквизитФормыВЗначение("ДеревоЗадач");
	Дерево.Строки.Очистить();
	
	ДобавитьСправочникиПоПредмету(Дерево, Параметры.Предмет);
	
	ЗначениеВДанныеФормы(Дерево, ДеревоЗадач);
	
	УстановитьТекущуюСтроку(ДеревоЗадач.ПолучитьЭлементы());
	
КонецПроцедуры	

&НаСервере
Процедура УстановитьТекущуюСтроку(ЭлементыДерева)
	
	Если Элементы.Количество() > 0 Тогда
		Для каждого Эл Из ЭлементыДерева Цикл
			Если Эл.Ссылка = ТекущаяСтрокаВДереве Тогда
				Элементы.ДеревоЗадач.ТекущаяСтрока = Эл.ПолучитьИдентификатор();
				Возврат;
			Иначе	
				УстановитьТекущуюСтроку(Эл.ПолучитьЭлементы());
			КонецЕсли;	
		КонецЦикла;	
	КонецЕсли;
	
КонецПроцедуры	

&НаСервере
Процедура ДобавитьСправочникиПоПредмету(Дерево, Предмет)
	
	Для каждого МетаданныеБизнесПроцесса Из Метаданные.Справочники Цикл
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	Справочники.Ссылка,
			|	Справочники.Представление КАК Наименование,
			|	Справочники.Завершен,
			|	1 Важность
			|ИЗ
			|	%БизнесПроцесс% КАК Справочники
			|ГДЕ
			|   Справочники.Заявка = &Предмет
			|	И Справочники.ВедущаяЗадача = ЗНАЧЕНИЕ(Справочник.Задача.ПустаяСсылка)
			|   И Справочники.ПометкаУдаления = Ложь
			|
			|УПОРЯДОЧИТЬ ПО
			|	Справочники.Дата";
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%БизнесПроцесс%", МетаданныеБизнесПроцесса.ПолноеИмя());
		Запрос.УстановитьПараметр("Предмет", Предмет);

		Результат = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = Результат.Выбрать();

		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
			Строка = Дерево.Строки.Добавить();
			
			Строка.Наименование = ВыборкаДетальныеЗаписи.Наименование;
			Строка.Важность = ВыборкаДетальныеЗаписи.Важность;
			Строка.Ссылка = ВыборкаДетальныеЗаписи.Ссылка;
			Строка.Выполнена = ВыборкаДетальныеЗаписи.Завершен;
			Строка.Тип = 0;
			
			ДобавитьСправочникиПодчиненногоБизнесПроцесса(Дерево, ВыборкаДетальныеЗаписи.Ссылка);
			
		КонецЦикла;
		
	КонецЦикла;	
	
КонецПроцедуры	

&НаСервере
Процедура ДобавитьПодчиненныеСправочники(Дерево, ЗадачаСсылка)
	
	Ветвь = Дерево.Строки.Найти(ЗадачаСсылка, "Ссылка", Истина);
	
	Для каждого МетаданныеБизнесПроцесса Из Метаданные.Справочники Цикл
		
		РеквизитГлавнаяЗадача = МетаданныеБизнесПроцесса.Реквизиты.Найти("ГлавнаяЗадача");
		Если РеквизитГлавнаяЗадача = Неопределено Тогда
			Продолжить;
		КонецЕсли;	
			
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	Справочники.Ссылка,
			|	Справочники.Представление как наименование,
			|	Справочники.Завершен,
			|	0 КАК Важность
			|ИЗ
			|	%БизнесПроцесс% КАК Справочники
			|ГДЕ
			|   Справочники.ВедущаяЗадача = &Задача
			|   И Справочники.ПометкаУдаления = Ложь";
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%БизнесПроцесс%", МетаданныеБизнесПроцесса.ПолноеИмя());
		Запрос.УстановитьПараметр("Задача", ЗадачаСсылка);

		Результат = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = Результат.Выбрать();

		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
			Строка = Неопределено;
			Если Ветвь = Неопределено Тогда
				Строка = Дерево.Строки.Добавить();
			Иначе	
				Строка = Ветвь.Строки.Добавить();
			КонецЕсли;
			
			Строка.Наименование = ВыборкаДетальныеЗаписи.Наименование;
			Строка.Важность = ВыборкаДетальныеЗаписи.Важность;
			Строка.Ссылка = ВыборкаДетальныеЗаписи.Ссылка;
			Строка.Выполнена = ВыборкаДетальныеЗаписи.Завершен;
			Строка.ПринятаКИсполнению = Истина;
			Строка.Тип = 0;
			
			ДобавитьСправочникиПодчиненногоБизнесПроцесса(Дерево, ВыборкаДетальныеЗаписи.Ссылка);
			
		КонецЦикла;
		
	КонецЦикла;	

КонецПроцедуры

&НаСервере
Процедура ДобавитьСправочникиПодчиненногоБизнесПроцесса(Дерево, БизнесПроцессСсылка)
	
	Ветвь = Дерево.Строки.Найти(БизнесПроцессСсылка, "Ссылка", Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Справочники.Ссылка,
		|	Справочники.Представление КАК Наименование,
		|	Справочники.Исполнитель,
		|	Справочники.СрокВыполнения,
		|	Справочники.ДатаИсполнения,
		|	Справочники.Выполнена,
		|	1 КАК Важность,
		|	Справочники.Комментарии,
		|	Справочники.ВРаботе
		|ИЗ
		|	Справочник.Задача КАК Справочники
		|ГДЕ
		|	Справочники.БизнесПроцесс = &БизнесПроцесс
		|	И Справочники.ПометкаУдаления = ЛОЖЬ
		|
		|УПОРЯДОЧИТЬ ПО
		|	Справочники.Дата";
		
	Запрос.УстановитьПараметр("БизнесПроцесс", БизнесПроцессСсылка);

	Результат = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Строка = Неопределено;
		Если Ветвь = Неопределено Тогда
			Строка = Дерево.Строки.Добавить();
		Иначе	
			Строка = Ветвь.Строки.Добавить();
		КонецЕсли;
        ВедомыйБизнесПроцесс = Новый Структура();
		Если НЕ ЭтоВедущаяЗадача(ВыборкаДетальныеЗаписи.Ссылка, ВедомыйБизнесПроцесс) Тогда			
			Строка.Наименование = ВыборкаДетальныеЗаписи.Наименование;
			Строка.Важность = ВыборкаДетальныеЗаписи.Важность;
			Строка.Комментарии = ВыборкаДетальныеЗаписи.Комментарии;
			Строка.ВРаботе = ВыборкаДетальныеЗаписи.ВРаботе;
			Строка.Тип = 1;
			Строка.Ссылка = ВыборкаДетальныеЗаписи.Ссылка;
			Строка.СрокИсполнения = ВыборкаДетальныеЗаписи.СрокВыполнения;
			Строка.ДатаИсполнения = ВыборкаДетальныеЗаписи.ДатаИсполнения;
			Строка.Выполнена = ВыборкаДетальныеЗаписи.Выполнена;
			Строка.Просрочена = Ложь;
			Если ВыборкаДетальныеЗаписи.СрокВыполнения <> '00010101000000' 
				И ВыборкаДетальныеЗаписи.СрокВыполнения < ТекущаяДата() Тогда
				Строка.Просрочена = Истина;
			КонецЕсли;				
			Если ВыборкаДетальныеЗаписи.Исполнитель.Пустая() Тогда
				Строка.Исполнитель = ВыборкаДетальныеЗаписи.РольИсполнителя;
			Иначе	
				Строка.Исполнитель = ВыборкаДетальныеЗаписи.Исполнитель;
			КонецЕсли;	
			
			ДобавитьПодчиненныеСправочники(Дерево, ВыборкаДетальныеЗаписи.Ссылка);
		Иначе
			Строка.Наименование = ВедомыйБизнесПроцесс.Наименование;
			Строка.Важность = ВедомыйБизнесПроцесс.Важность;
			Строка.Ссылка = ВедомыйБизнесПроцесс.Ссылка;
			Строка.Выполнена = ВедомыйБизнесПроцесс.Завершен;
			Строка.Тип = 0;
			ДобавитьСправочникиПодчиненногоБизнесПроцесса(Дерево, Строка.Ссылка);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ЭтоВедущаяЗадача(ЗадачаСсылка, ДанныеВедомогоПроцесса)
	
	Запрос = Новый Запрос;
	Для каждого МетаданныеБизнесПроцесса Из Метаданные.Справочники Цикл
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	Справочники.Ссылка,
			|	Справочники.Представление как Наименование,
			|	Справочники.Завершен,
			|	1 КАК Важность
			|ИЗ
			|	%БизнесПроцесс% КАК Справочники
			|ГДЕ
			|   Справочники.ВедущаяЗадача = &Задача";
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%БизнесПроцесс%", МетаданныеБизнесПроцесса.ПолноеИмя());
		Запрос.УстановитьПараметр("Задача", ЗадачаСсылка);

		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			ДанныеВедомогоПроцесса.Вставить("Наименование", Выборка.Наименование);
			ДанныеВедомогоПроцесса.Вставить("Важность", Выборка.Важность);
			ДанныеВедомогоПроцесса.Вставить("Ссылка", Выборка.Ссылка);
			ДанныеВедомогоПроцесса.Вставить("Завершен", Выборка.Завершен);
			Возврат Истина;
		КонецЦикла;
	КонецЦикла;

	Возврат Ложь;
	
КонецФункции


&НаКлиенте
Процедура Обновить(Команда)
	
	ЗаполнитьДеревоЗадач();
	Для каждого Строка ИЗ ДеревоЗадач.ПолучитьЭлементы() Цикл
		Элементы.ДеревоЗадач.Развернуть(Строка.ПолучитьИдентификатор(), Истина);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура Изменить(Команда)
	
	ОткрытьТекущуюСтрокуДереваЗадач();
	
КонецПроцедуры

&НаКлиенте
Процедура ДеревоЗадачВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ОткрытьТекущуюСтрокуДереваЗадач();
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьТекущуюСтрокуДереваЗадач()
	
	Если Элементы.ДеревоЗадач.ТекущиеДанные <> Неопределено Тогда
		Если ТипЗнч(Элементы.ДеревоЗадач.ТекущиеДанные.Ссылка) = Тип("СправочникСсылка.Задача") Тогда
			//СправочникиИСправочникиКлиент.ОткрытьФормуВыполненияСправочники(Элементы.ДеревоЗадач.ТекущиеДанные.Ссылка);
		Иначе	
			ОткрытьЗначение(Элементы.ДеревоЗадач.ТекущиеДанные.Ссылка);
		КонецЕсли;	
	КонецЕсли;	

КонецПроцедуры

&НаКлиенте
Процедура ДеревоЗадачПриАктивизацииСтроки(Элемент)
	
	Если Элементы.ДеревоЗадач.ТекущиеДанные <> Неопределено Тогда
		ТекущаяСтрокаВДереве = Элементы.ДеревоЗадач.ТекущиеДанные.Ссылка;	
	КонецЕсли;	
	
КонецПроцедуры

