&НаСервере
Функция ОпределитьКвартал(НомерМесяца)
	Если НомерМесяца / 3 <= 1 Тогда
		Возврат 1;
	ИначеЕсли НомерМесяца / 3 > 1 И НомерМесяца / 3 <= 2 Тогда 
		Возврат 2;
	ИначеЕсли  НомерМесяца / 3 > 2 И НомерМесяца / 3 <= 3 Тогда
		Возврат 3;
	ИначеЕсли НомерМесяца / 3 > 3 И НомерМесяца / 3 <= 4 Тогда
		Возврат 4;	
	КонецЕсли; 
КонецФункции // ()

&НаКлиенте
Процедура ВыделитьВсе(Команда)

		ЗаполнитьПометкиВДереве(1);
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПометкиСервер(ЗначениеЗаполнения)
	
	Для Каждого ЭлПр Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
		
		ЭлПр.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);
		
		Для Каждого ЭлПодр Из ЭлПр.ПолучитьЭлементы() Цикл
			ЭлПодр.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьФлажки(Команда)

		ЗаполнитьПометкиВДереве(0);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьСценарий(НомерСценария)
	Если НомерСценария = 1 тогда
		возврат Константы.Д_СценарийПланаПервоначальный.Получить();
	иначе
		возврат Справочники.СценарииПланирования.Факт;
	конецесли;
КонецФункции // ()

&НаСервере
Процедура ЗаполнитьТаблицуДеятельность(ВидОтчета)
	
	
	//при выборе сценария факта в одном из полей Сценарий
	ПланСчетов1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, ПланыСчетов.Учетный, ПланыСчетов.Учетный);
	ПланСчетов2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, ПланыСчетов.Учетный, ПланыСчетов.Учетный);
	Регистр1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, "Учетный", "Бюджетный");
	Регистр2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, "Учетный", "Бюджетный");
	ПС_Сц1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, "ПланСчетов.Учетный", "ПланСчетов.Учетный");
	ПС_Сц2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, "ПланСчетов.Учетный", "ПланСчетов.Учетный"); 
	
	//определяем таблицу значений, в которую будем вносить все значения
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Шрифт"); //1) 1-обычный, 2 - жирный, 3 - курсив
	
	ТЗ.Колонки.Добавить("Порядок");//2) для структурирования дальнейшего вывода
	ТЗ.Колонки.Добавить("Признак");//3) для уникальности строки
	//порядок и признак выступают уникальным идентификтором строки
	
	ТЗ.Колонки.Добавить("Предприятие");//4) для обозначения разных предприятий
	
	ТЗ.Колонки.Добавить("Значение");//5)
	ТЗ.Колонки.Добавить("Резерв1");
	ТЗ.Колонки.Добавить("Резерв2");
	ТЗ.Колонки.Добавить("Резерв3");
	ТЗ.Колонки.Добавить("Резерв4");
	ТЗ.Колонки.Добавить("Резерв5");
	НаборИмен = ""; ИндексКолонки = 10;
	Для Кол = 1 По 300 Цикл // добавляем заранее все колонки в ТЗ с индекса 9
		ИмяКол = "Колонка" + строка(Кол);
		НаборИмен = НаборИмен + ИмяКол + ",";
		ТЗ.Колонки.Добавить(ИмяКол);
	КонецЦикла; 
	
	Попытка
	    ЭтотОбъект2 = ВнешниеОтчеты.Создать("Д_ФРПроектов");	
	Исключение
		ЭтотОбъект2 = Отчеты.Д_ФРПроектов;
	КонецПопытки;
	
	Если НЕ ПустаяСтрока(Отчет.Сценарий1) и  НЕ ПустаяСтрока(Отчет.Сценарий2) Тогда
		ИмяМакета = "МакетДеятельностиПланФакт" + ?(ТочностьДва, "Дробь", "");
		Макет = ЭтотОбъект2.ПолучитьМакет(ИмяМакета);
	иначе
		ИмяМакета = "МакетДеятельности" + ?(ТочностьДва, "Дробь", "");
		Макет = ЭтотОбъект2.ПолучитьМакет(ИмяМакета);
	КонецЕсли; 
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка|СтолбецНачало");
	ОбластьШапкаСтолбцы = Макет.ПолучитьОбласть("Шапка|ДанныеСтолбца");
	
	ТабДок.Очистить();
	ВставлятьРазделительСтраниц = Ложь;
	
	
	Интервал = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, 1, 
	?(Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, 3, 12));
	
	КлючПериод = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, "Месяц", ?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, "Квартал", "Год"));
	
	НачалоПериода = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, Месяц(Отчет.Период.ДатаНачала),?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, ОпределитьКвартал(Месяц(Отчет.Период.ДатаНачала)), Год(Отчет.Период.ДатаНачала)));
	
	КонецПериода = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, Месяц(Отчет.Период.ДатаОкончания),?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, ОпределитьКвартал(Месяц(Отчет.Период.ДатаОкончания)), Год(Отчет.Период.ДатаОкончания)));
	
	// #большегода {
	Если Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно Тогда
		мнИнтервала = 86400 * 30
	ИначеЕсли Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально Тогда
		мнИнтервала = 86400 * 30 * 3
	Иначе
		мнИнтервала = 86400 * 30 * 3 * 4
	КонецЕсли;
	
	ВсегоПериодов = Окр((КонецДня(Отчет.Период.ДатаОкончания)+1 - НачалоДня( Отчет.Период.ДатаНачала)) / мнИнтервала, 0, РежимОкругления.Окр15как10);
	//}
	
	ПредприятияМассив = Новый Массив;
	ПодразделенияМассив = Новый Массив;  
	// di 23.05.13
	ПодразделенияМассив.Добавить(Справочники.СтруктураПредприятия.ПустаяСсылка());
	
	Если Не РежимВыбораПредприятий = "Предприятие" Тогда
		
		Для каждого ТекТип Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
			
			Для Каждого Т Из ТекТип.ПолучитьЭлементы() Цикл
			
				Если Т.Пометка Тогда
			
					ПредприятияМассив.Добавить(Т.Значение);
					
					ТекПодразделения = Справочники.СтруктураПредприятия.Выбрать(,Т.Значение);
				
					Пока ТекПодразделения.Следующий() Цикл
					
						ПодразделенияМассив.Добавить(ТекПодразделения.Ссылка);
					
					КонецЦикла;	
					
				КонецЕсли;
						
			КонецЦикла; 	
			
		КонецЦикла;
		
	Иначе
	
		Для каждого Т Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
		
			Если Т.Пометка Тогда
			
				ПредприятияМассив.Добавить(Т.Значение);
			
				Если ПоПодразделениям Тогда
				
					Для Каждого СтрПодр Из Т.ПолучитьЭлементы() Цикл
				
						Если СтрПодр.Пометка Тогда
							ПодразделенияМассив.Добавить(СтрПодр.Значение);
						КонецЕсли;
					
					КонецЦикла;
				
				Иначе
				
					ТекПодразделения = Справочники.СтруктураПредприятия.Выбрать(,Т.Значение);
				
					Пока ТекПодразделения.Следующий() Цикл
					
						ПодразделенияМассив.Добавить(ТекПодразделения.Ссылка);
					
					КонецЦикла;
				
				КонецЕсли;	
				
			КонецЕсли;		
						
		КонецЦикла; 	
		
	КонецЕсли;
			
	//Предпр = Т.Значение;
	ДатаНач = Отчет.Период.ДатаНачала;
	ДатаКон = Отчет.Период.ДатаОкончания;
	СчетчикМесяцев = 0;
	СчетчикНоменклатур = 0;
	КоэффициентОтступа = 0;
	
		//90.3
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0) КАК Сумма1,
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0) КАК Сумма2,
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ КАК Период,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ КАК ПериодДата,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1 Иначе  ДанныеСценарий2.Субконто2 конец
		|		ИНАЧЕ выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1 Иначе  ДанныеСценарий1.Субконто2 конец
		|	КОНЕЦ КАК Статья,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1.Родитель Иначе  ДанныеСценарий2.Субконто2.Родитель конец
		|		ИНАЧЕ выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1.Родитель Иначе ДанныеСценарий1.Субконто2.Родитель конец
		|	КОНЕЦ КАК Родитель1,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL
		|        	ТОГДА  ДанныеСценарий2.Предприятия
		|        ИНАЧЕ ДанныеСценарий1.Предприятия
		|    КОНЕЦ  КАК Предприятие,
		| ВЫБОР
		|  КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL 
		|   ТОГДА ВЫБОР
		|     КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL
		|      ТОГДА (ВЫБОР
		|         КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|          ТОГДА ДанныеСценарий2.Предприятия
		|         ИНАЧЕ ДанныеСценарий1.Предприятия
		|        КОНЕЦ).ВидДеятельности
		|      ИНАЧЕ ДанныеСценарий2.Подразделение
		|      КОНЕЦ 
		|   ИНАЧЕ ДанныеСценарий1.Подразделение
		| КОНЕЦ КАК Деятельность
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет В (&Счет),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|			И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет В (&Счет2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|			    И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И (" + КлючПериод + "(ДанныеСценарий1.Период) = " + КлючПериод + "(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|			И ДанныеСценарий1.Подразделение = ДанныеСценарий2.Подразделение
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0),
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ,
		| ВЫБОР
		|  КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL 
		|   ТОГДА ВЫБОР
		|     КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL
		|      ТОГДА (ВЫБОР
		|         КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|          ТОГДА ДанныеСценарий2.Предприятия
		|         ИНАЧЕ ДанныеСценарий1.Предприятия
		|        КОНЕЦ).ВидДеятельности
		|      ИНАЧЕ ДанныеСценарий2.Подразделение
		|      КОНЕЦ 
		|   ИНАЧЕ ДанныеСценарий1.Подразделение
		| КОНЕЦ
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет В (&СчетаДоход),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет В (&СчетаДоход2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И (" + КлючПериод + "(ДанныеСценарий1.Период) = " + КлючПериод + "(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|			И ДанныеСценарий1.Подразделение = ДанныеСценарий2.Подразделение 
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0),
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ,
		| ВЫБОР
		|  КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL 
		|   ТОГДА ВЫБОР
		|     КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL
		|      ТОГДА (ВЫБОР
		|         КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|          ТОГДА ДанныеСценарий2.Предприятия
		|         ИНАЧЕ ДанныеСценарий1.Предприятия
		|        КОНЕЦ).ВидДеятельности
		|      ИНАЧЕ ДанныеСценарий2.Подразделение
		|      КОНЕЦ 
		|   ИНАЧЕ ДанныеСценарий1.Подразделение
		| КОНЕЦ
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет В (&Счет91Сц1),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|				И СценарийПлана = &Сценарий1 И " + ?(Регистр1 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет В (&Счет91Сц2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|					И СценарийПлана = &Сценарий2 И " + ?(Регистр2 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И (" + КлючПериод + "(ДанныеСценарий1.Период) = " + КлючПериод + "(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|			И ДанныеСценарий1.Подразделение = ДанныеСценарий2.Подразделение 
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СтатьиЗатрат.Ссылка КАК Статья,
		|	СтатьиЗатрат.ЭтоГруппа,
		|	ЕСТЬNULL(Данные.Сумма1, 0) КАК Сумма1,
		|	ЕСТЬNULL(Данные.Сумма2, 0) КАК Сумма2,
		|	ЕСТЬNULL(Данные.Период, 0) КАК Период,
		|	Данные.ПериодДата,
		|	Данные.Предприятие,
		|	Данные.Деятельность КАК Деятельность
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		|		ПОЛНОЕ СОЕДИНЕНИЕ Данные КАК Данные
		|		ПО (СтатьиЗатрат.Ссылка = Данные.Статья
		|				ИЛИ СтатьиЗатрат.Ссылка = Данные.Родитель1)
		|
		|УПОРЯДОЧИТЬ ПО
		|	СтатьиЗатрат.Код";
	
	Запрос.УстановитьПараметр("Предприятия", ПредприятияМассив);
	Запрос.УстановитьПараметр("Подразделения", ПодразделенияМассив);
	Запрос.УстановитьПараметр("Сценарий1", Отчет.Сценарий1);
	Запрос.УстановитьПараметр("Сценарий2", Отчет.Сценарий2);
	Запрос.УстановитьПараметр("Дата1", ДатаНач);
	Запрос.УстановитьПараметр("Дата2", ДатаКон);
	МассивСчетов90_Сц1 = Новый Массив;
	МассивСчетов90_Сц1.Добавить(ПланСчетов1.Себестоимость);
	МассивСчетов90_Сц1.Добавить(ПланСчетов1.РасходыПоРеал);
	Запрос.УстановитьПараметр("Счет", МассивСчетов90_Сц1);
	Запрос.УстановитьПараметр("Счет90_2_Сц1", ПланСчетов1.Себестоимость);
	МассивСчетов90_Сц2 = Новый Массив;
	МассивСчетов90_Сц2.Добавить(ПланСчетов2.Себестоимость);
	МассивСчетов90_Сц2.Добавить(ПланСчетов2.РасходыПоРеал);
	Запрос.УстановитьПараметр("Счет2", МассивСчетов90_Сц2);
	Запрос.УстановитьПараметр("Счет90_2_Сц2", ПланСчетов2.Себестоимость);
	СчетаДоход = Новый Массив;
	СчетаДоход.Добавить(ПланСчетов1.ВыручкаОтРеал);
	СчетаДоход.Добавить(ПланСчетов1.РеалОС);
	СчетаДоход2 = Новый Массив;
	СчетаДоход2.Добавить(ПланСчетов2.ВыручкаОтРеал);
	СчетаДоход2.Добавить(ПланСчетов2.РеалОС);
	Запрос.УстановитьПараметр("СчетаДоход", СчетаДоход);
	Запрос.УстановитьПараметр("СчетаДоход2", СчетаДоход2);
	Запрос.УстановитьПараметр("Счет91Сц1", ПланСчетов1.ДоходыИРасходы);
	Запрос.УстановитьПараметр("Счет91Сц2", ПланСчетов2.ДоходыИРасходы);

	РезультатЗатраты = Запрос.Выполнить();
	
	
	//91 счет
	Запрос = Новый Запрос;
		
		Запрос.Текст = "ВЫБРАТЬ
					   |	ВЫБОР
					   |		КОГДА " + КлючПериод + "(Прочие1.Период) ЕСТЬ NULL 
					   |			ТОГДА " + КлючПериод + "(Прочие2.Период)
					   |		ИНАЧЕ " + КлючПериод + "(Прочие1.Период)
					   |	КОНЕЦ КАК Период,
					   |	ВЫБОР
					   |		КОГДА Прочие1.Период ЕСТЬ NULL 
					   |			ТОГДА Прочие2.Период
					   |		ИНАЧЕ Прочие1.Период
					   |	КОНЕЦ КАК ПериодДата,
					   |	ВЫБОР					   
					   |		КОГДА Прочие1.Субконто1 ЕСТЬ NULL 
					   |			ТОГДА Прочие2.Субконто1
					   |		ИНАЧЕ Прочие1.Субконто1
					   |	КОНЕЦ КАК Статья,
		               |	-ЕСТЬNULL(Прочие1.СуммаОборот, 0) КАК Сумма1,
					   |	-ЕСТЬNULL(Прочие2.СуммаОборот, 0) КАК Сумма2,
					   |	ВЫБОР
		               |		КОГДА Прочие1.Предприятия ЕСТЬ NULL
					   |        	ТОГДА  Прочие2.Предприятия
					   |        ИНАЧЕ Прочие1.Предприятия
					   |    КОНЕЦ  КАК Предприятие,
					   |	ВЫБОР					   
					   |		КОГДА Прочие1.Подразделение ЕСТЬ NULL 
					   |			ТОГДА Прочие2.Подразделение
					   |		ИНАЧЕ Прочие1.Подразделение
					   |	КОНЕЦ КАК Деятельность
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			" + КлючПериод + ",
		               |			Счет = &СчетДт2,
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
					   |			И Подразделение В (&Подразделения)
		               |				И СценарийПлана = &Сценарий1
		               |			,
		               |			) КАК Прочие1
					   | ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			" + КлючПериод + ",
		               |			Счет = &СчетДт3,
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
					   |				И Подразделение В (&Подразделения)
		               |				И СценарийПлана = &Сценарий2
		               |			,
		               |			) КАК Прочие2
		               |			ПО (" + КлючПериод + "(Прочие1.Период) = " + КлючПериод + "(Прочие2.Период))
					   |			И Прочие1.Субконто1 = Прочие2.Субконто1
					   |			И Прочие1.Предприятия = Прочие2.Предприятия
					   |			И Прочие1.Подразделение = Прочие2.Подразделение
		               |УПОРЯДОЧИТЬ ПО
		               |	Статья";
		
	
	Запрос.УстановитьПараметр("Предприятия", ПредприятияМассив);
	Запрос.УстановитьПараметр("Подразделения", ПодразделенияМассив);
	Запрос.УстановитьПараметр("Сценарий1", Отчет.Сценарий1);
	Запрос.УстановитьПараметр("Сценарий2", Отчет.Сценарий2);
	Запрос.УстановитьПараметр("Дата1", ДатаНач);
	Запрос.УстановитьПараметр("Дата2", ДатаКон);
	Запрос.УстановитьПараметр("СчетДт2", ПланСчетов1.ДоходыИРасходы);
	Запрос.УстановитьПараметр("СчетДт3", ПланСчетов2.ДоходыИРасходы);

	РезультатПрочиеЗатраты = Запрос.Выполнить();
	
	// закомментированно di 14.05.13
		
	УслугиУКГруппа = Справочники.СтатьиЗатрат.УслугиУКГруппа;
	УслугиУКЭлем = Справочники.СтатьиЗатрат.УслугиУК;
	
	//Деятельность.Добавить("Итого:");
	
	Для каждого Предприятие  Из ПредприятияМассив Цикл
		
		//очищаем массив и присваиваем числовой тип
		ТекущиеЗатраты1 = Новый Массив(300);
		ТекущиеЗатраты2 = Новый Массив(300);
		ТекущиеДоходы1 = Новый Массив(300);
		ТекущиеДоходы2 = Новый Массив(300);
		ПрочиеЗатраты1 = Новый Массив(300);
		ПрочиеЗатраты2 = Новый Массив(300);
		УслугиУК = Новый Массив(300);
		УслугиУК2 = Новый Массив(300);
		//Деятельность = Новый Массив;
		Для т = 0 По 299 Цикл
			ТекущиеЗатраты1[т] = 0;
			ТекущиеЗатраты2[т] = 0;
			ТекущиеДоходы1[т] = 0;
			ТекущиеДоходы2[т] = 0;	
			ПрочиеЗатраты1[т] = 0;
			ПрочиеЗатраты2[т] = 0;
			УслугиУК[т] = 0;
			УслугиУК2[т] = 0;
		КонецЦикла;
		
		// di 14.05.13
		ТЗ.Очистить();
		Деятельность = Новый Массив;
        Деятельность.Добавить("Итого:");
		НачИндекс = 1;
		МаксИндекс = НачИндекс;
		КолонкиПодразделений = Новый Соответствие;
		КолонкиПодразделений.Вставить("Итого:", НачИндекс);
		//
		
		// если нет резервных колонок, вставляем их для совместимости индексов
		Если ТЗ.Колонки.Найти("Резерв1") = Неопределено Тогда
					
			ТЗ.Колонки.Вставить(5, "Резерв1"); 
			ТЗ.Колонки.Вставить(6, "Резерв2");		
			ТЗ.Колонки.Вставить(7, "Резерв3");
			ТЗ.Колонки.Вставить(8, "Резерв4");
			ТЗ.Колонки.Вставить(9, "Резерв5");
			
		КонецЕсли;
		
		//опрос 90.3
		СтруктураПоиска = Новый Структура("Предприятие", Предприятие);
		Выборка = РезультатЗатраты.Выбрать();
		Пока Выборка.НайтиСледующий(СтруктураПоиска) цикл
			
			НоваяСтрока = ТЗ.Добавить();
			НоваяСтрока[0] = 1;
			НоваяСтрока[1] = 0;
			НоваяСтрока[2] = Строка("Ном") + строка("Объем производства");
			НоваяСтрока[3] = Выборка.Предприятие;
			НоваяСтрока[4] = "Объем производства " + Строка("Ном");
			//di 15.05.13
			НоваяСтрока[11] = 0;
			НоваяСтрока[13] = 0;
			//
			
			Если ЗначениеЗаполнено(Выборка.Предприятие) Тогда
				НоваяСтрокаД = ТЗ.Добавить();
				НоваяСтрокаД[0] = 0;
				НоваяСтрокаД[1] = 0;
				НоваяСтрокаД[2] = Строка("Ном") + "Доходы";
				НоваяСтрокаД[3] = Выборка.Предприятие;
				НоваяСтрокаД[4] = "Доходы";
			КонецЕсли;	
				
			НоваяСтрокаР = ТЗ.Добавить();
			НоваяСтрокаР[0] = 0;
			НоваяСтрокаР[1] = 0;
			НоваяСтрокаР[2] = Строка("Ном") + "Расходы";
			НоваяСтрокаР[3] = Выборка.Предприятие;
			НоваяСтрокаР[4] = "Расходы";
			НоваяСтрокаР[11] = 0;
			НоваяСтрокаР[13] = 0;
			
			ВидДеятельности = ?(ПустаяСтрока(Выборка.Деятельность), "Общий", Строка(Выборка.Деятельность));
			
			// закомментированно di 14.05.13
			//СчетчикМесяцев = Деятельность.Найти(ВидДеятельности);
			//
			//Если СчетчикМесяцев = Неопределено Тогда				
			//	Деятельность.Добавить(ВидДеятельности);
			//	СчетчикМесяцев = Деятельность.Количество();
			//иначе
			//	СчетчикМесяцев = СчетчикМесяцев + 1;
			//КонецЕсли;
			
			// di 14.05.13
			
			ТекПодр = Деятельность.Найти(ВидДеятельности);
			
			// 22.09.2015 обращение 3858 чтобы не выводились лишние подразделения
			Если ПодразделенияМассив.Найти(Выборка.Деятельность) = Неопределено Тогда
				Если Деятельность.Найти(ВидДеятельности) <> Неопределено Тогда
					Деятельность.Удалить(Деятельность.Найти(ВидДеятельности));
				КонецЕсли;
				Продолжить;
			КонецЕсли;
			//
			
			Если ТекПодр = Неопределено Тогда
				Деятельность.Добавить(ВидДеятельности);
				НачИндекс = НачИндекс + 2;
				КолонкиПодразделений.Вставить(ВидДеятельности, НачИндекс);
				СчетчикМесяцев = НачИндекс;
				
				Если НачИндекс > МаксИндекс Тогда
					МаксИндекс = НачИндекс
				КонецЕсли;
				
			Иначе
				СчетчикМесяцев = КолонкиПодразделений.Получить(ВидДеятельности);
			КонецЕсли;
			
			//			
			Если Не ЗначениеЗаполнено(Выборка.Статья) Тогда	
				НоваяСтрокаД[СчетчикМесяцев*2 + 9] = Выборка.Сумма1;
				НоваяСтрокаД[СчетчикМесяцев*2 + 11] = Выборка.Сумма2;
				ТекущиеДоходы1[СчетчикМесяцев] = ТекущиеДоходы1[СчетчикМесяцев] + Выборка.Сумма1;
				ТекущиеДоходы1[1] = ТекущиеДоходы1[1] + Выборка.Сумма1;
				ТекущиеДоходы2[СчетчикМесяцев] = ТекущиеДоходы2[СчетчикМесяцев] + Выборка.Сумма2;
				ТекущиеДоходы2[1] = ТекущиеДоходы2[1] + Выборка.Сумма2;
				Продолжить;
			КонецЕсли;	
			
			Если НЕ Выборка.Статья = УслугиУКГруппа И НЕ Выборка.Статья.ПринадлежитЭлементу(УслугиУКГруппа) Тогда
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 1 - Выборка.ЭтоГруппа;			
				//di 15.05.13
				НоваяСтрока[11] = 0;
				НоваяСтрока[13] = 0;
				//
				
				Если НЕ Выборка.ЭтоГруппа Тогда
					ТекущиеЗатраты1[СчетчикМесяцев] = ТекущиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1; 
					ТекущиеЗатраты1[1] = ТекущиеЗатраты1[1] + Выборка.Сумма1; 
					ТекущиеЗатраты2[СчетчикМесяцев] = ТекущиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2; 
					ТекущиеЗатраты2[1] = ТекущиеЗатраты2[1] + Выборка.Сумма2; 
				КонецЕсли;
				
				
				НоваяСтрока[1] = 0;                            
				НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = Выборка.Статья;
				//НоваяСтрока[11] = Выборка.Сумма1;
				НоваяСтрока[СчетчикМесяцев * 2 + 9] = -Выборка.Сумма1;
				НоваяСтрока[СчетчикМесяцев * 2+ 11] = -Выборка.Сумма2;
				
			Иначе
				Если Выборка.Статья = УслугиУКГруппа Тогда
					УслугиУК[СчетчикМесяцев] = УслугиУК[СчетчикМесяцев] + Выборка.Сумма1; 
					УслугиУК[1] = УслугиУК[1] + Выборка.Сумма1;
					УслугиУК2[СчетчикМесяцев] = УслугиУК2[СчетчикМесяцев] + Выборка.Сумма2; 
					УслугиУК2[1] = УслугиУК2[1] + Выборка.Сумма2;
					
				
				КонецЕсли; 
			КонецЕсли;
			
			
		КонецЦикла;
		
		//итого по тек.деятельности
		
		Для СчетчикМесяцев = 1 По МаксИндекс Цикл
			Если ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты2[СчетчикМесяцев] Тогда
				
				СтрокаРасходов = ТЗ.НайтиСтроки(Новый Структура("Значение, Предприятие", "Расходы", Выборка.Предприятие));
				СтрокаРасходов[0][СчетчикМесяцев * 2 + 9] = -ТекущиеЗатраты1[СчетчикМесяцев];
				СтрокаРасходов[0][СчетчикМесяцев * 2+ 11] = -ТекущиеЗатраты2[СчетчикМесяцев]; 
				
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка("Прибыль по текущей деятельности");
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = "Прибыль по текущей деятельности";
				НоваяСтрока[СчетчикМесяцев * 2 + 9] = ТекущиеДоходы1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев];
				НоваяСтрока[СчетчикМесяцев * 2 + 11] = ТекущиеДоходы2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев];
				//di 15.05.13
				НоваяСтрока[11] = 0;
				НоваяСтрока[13] = 0;
				//
			КонецЕсли;
			
		КонецЦикла;
		
		//итого по тек.деятельности с учетом хозрасчета
		
		Для СчетчикМесяцев = 1 По МаксИндекс Цикл
			Если ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ УслугиУК[СчетчикМесяцев] Тогда
				
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 1;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка(УслугиУКЭлем);
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = УслугиУКЭлем;
				НоваяСтрока[СчетчикМесяцев * 2 + 9] = УслугиУК[СчетчикМесяцев];
				НоваяСтрока[СчетчикМесяцев * 2 + 11] = УслугиУК2[СчетчикМесяцев];
				//di 15.05.13
				НоваяСтрока[11] = 0;
				НоваяСтрока[13] = 0;
				//
				
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка("Прибыль по основной деятельности");
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = "Прибыль по основной деятельности";
				НоваяСтрока[СчетчикМесяцев * 2 + 9] = ТекущиеДоходы1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев] + УслугиУК[СчетчикМесяцев];
				НоваяСтрока[СчетчикМесяцев * 2 + 11] = ТекущиеДоходы2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев] + УслугиУК2[СчетчикМесяцев];
				//di 15.05.13
				НоваяСтрока[11] = 0;
				НоваяСтрока[13] = 0;
				//
			КонецЕсли;
			
		КонецЦикла;
		
		//опрос 91
		СтруктураПоиска = Новый Структура("Предприятие", Предприятие);
		Выборка = РезультатПрочиеЗатраты.Выбрать();
		Пока Выборка.НайтиСледующий(СтруктураПоиска) цикл
			
			ВидДеятельности = ?(ПустаяСтрока(Выборка.Деятельность), "Общий", Строка(Выборка.Деятельность));
						
			// di 14.05.13
			
			ТекПодр = Деятельность.Найти(ВидДеятельности);
			                                                                          
			Если ТекПодр = Неопределено Тогда
				Деятельность.Добавить(ВидДеятельности);
				НачИндекс = НачИндекс + 2;
				КолонкиПодразделений.Вставить(ВидДеятельности, НачИндекс);
				СчетчикМесяцев = НачИндекс;
				
				Если НачИндекс > МаксИндекс Тогда
					МаксИндекс = НачИндекс
				КонецЕсли;
				
			Иначе
				СчетчикМесяцев = КолонкиПодразделений.Получить(ВидДеятельности);
			КонецЕсли;
			
			//
			
			НоваяСтрока = ТЗ.Добавить();
			НоваяСтрока[0] = 1;	
			НоваяСтрока[1] = 0;
			НоваяСтрока[2] = Строка(Выборка.Предприятие) + Строка(Выборка.Статья);
			НоваяСтрока[3] = Выборка.Предприятие;
			НоваяСтрока[4] = Выборка.Статья;
			//НоваяСтрока[11] = Выборка.Сумма1;   // закомментированно di 13.05.13
			НоваяСтрока[СчетчикМесяцев * 2 + 9] = -Выборка.Сумма1;
			НоваяСтрока[СчетчикМесяцев * 2 + 11] = -Выборка.Сумма2;
			ПрочиеЗатраты1[СчетчикМесяцев] = ПрочиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1;
			ПрочиеЗатраты1[1] = ПрочиеЗатраты1[1] + Выборка.Сумма1;
			ПрочиеЗатраты2[СчетчикМесяцев] = ПрочиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;
			ПрочиеЗатраты2[1] = ПрочиеЗатраты2[1] + Выборка.Сумма2;
			//di 15.05.13
			НоваяСтрока[11] = 0;
			НоваяСтрока[13] = 0;
			//
		КонецЦикла;
				
		Для СчетчикМесяцев = 1 По МаксИндекс Цикл  
			Если ТекущиеДоходы1[СчетчикМесяцев] ИЛИ ТекущиеДоходы2[СчетчикМесяцев] ИЛИ ПрочиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ УслугиУК[СчетчикМесяцев] ИЛИ ПрочиеЗатраты2[СчетчикМесяцев] ИЛИ ТекущиеЗатраты2[СчетчикМесяцев] ИЛИ УслугиУК2[СчетчикМесяцев] Тогда
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0;	
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка(Предприятие) + "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
				НоваяСтрока[3] = Предприятие;
				НоваяСтрока[4] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
				НоваяСтрока[СчетчикМесяцев * 2 + 9] = ТекущиеДоходы1[СчетчикМесяцев] + ПрочиеЗатраты1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев] + УслугиУК[СчетчикМесяцев];
				НоваяСтрока[СчетчикМесяцев * 2 + 11] = ТекущиеДоходы2[СчетчикМесяцев] + ПрочиеЗатраты2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев] + УслугиУК2[СчетчикМесяцев];
				//di 15.05.13
				НоваяСтрока[11] = 0;
				НоваяСтрока[13] = 0;
				//
			Иначе
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0;	
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка(Предприятие) + "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
				НоваяСтрока[3] = Предприятие;
				НоваяСтрока[4] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
				НоваяСтрока[СчетчикМесяцев * 2 + 9] = 0;
				НоваяСтрока[СчетчикМесяцев * 2 + 11] = 0;
				//di 15.05.13
				НоваяСтрока[11] = 0;
				НоваяСтрока[13] = 0;
				//
			КонецЕсли;
		КонецЦикла;
		
		
		// di 15.05.13
	//КолСтр = ТЗ.Количество();	
	//Для ОбрИнд = 1 По КолСтр Цикл	
	//	Если ТипЗнч(ТЗ[КолСтр - ОбрИнд].Предприятие) = Тип("Число") Тогда
	//		ТЗ.Удалить(КолСтр - ОбрИнд);
	//	КонецЕсли;
	//КонецЦикла;
			//сворачиваем таблицу значений и выводим на печать		
	ТЗ.Свернуть("Шрифт, Порядок, Признак, Предприятие, Значение", НаборИмен);	
	ПросуммироватьТЗПоКолонкам(ТЗ);
	
	ТабДок.НачатьАвтогруппировкуСтрок();
	

	ОбластьШапка.Параметры.Предприятие = Предприятие;
	ОбластьШапка.Параметры.Месяц = ПредставлениеПериода(Отчет.Период.ДатаНачала, Отчет.Период.ДатаОкончания);
	ТабДок.Вывести(ОбластьШапка);
	Период = 0;
	
	Для Колонка = 1 По Деятельность.Количество() Цикл
		ОбластьШапкаСтолбцы.Параметры.Деятельность = Деятельность[Колонка - 1];	
		Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
			ОбластьШапкаСтолбцы.Параметры.Сценарий1 = Отчет.Сценарий1;
			ОбластьШапкаСтолбцы.Параметры.Сценарий2 = Отчет.Сценарий2;
		КонецЕсли;
		ТабДок.Присоединить(ОбластьШапкаСтолбцы);
	КонецЦикла;
	
	Для Строчка = 0 По ТЗ.Количество()-1 Цикл
		
		Если Лев(ТЗ[Строчка][4], 18) = "Объем производства" Тогда // выводим шапку			
			//ОбластьШапка.Параметры.Номенклатура = Сред(ТЗ[Строчка][4], 20, СтрДлина(ТЗ[Строчка][4]));
			Продолжить;
		КонецЕсли;
		
		//получаем шрифт
		ОбластьДанные = Макет.ПолучитьОбласть("Строка" + строка(ТЗ[Строчка][0]) + "|СтолбецНачало");
		ОбластьДанныеСтолбцы = Макет.ПолучитьОбласть("Строка" + строка(ТЗ[Строчка][0]) + "|ДанныеСтолбца");			
		
		//получаем данные
		ОбластьДанные.Параметры.Статья = ТЗ[Строчка][4];
		
		Если (Лев(ТЗ[Строчка][4], 6) = "Доходы" И СтрДлина(ТЗ[Строчка][4]) = 6) ИЛИ (Лев(ТЗ[Строчка][4], 7) = "Расходы" И СтрДлина(ТЗ[Строчка][4]) = 7) Тогда
			ТекУровень = 1
		ИначеЕсли ТипЗнч(ТЗ[Строчка][4]) = Тип("СправочникСсылка.СтатьиЗатрат") ИЛИ ТипЗнч(ТЗ[Строчка][4]) = Тип("СправочникСсылка.СтатьиДоходовРасходов") Тогда
			ТекУровень = ?(ТЗ[Строчка][4].ЭтоГруппа ИЛИ ЗначениеЗаполнено(ТЗ[Строчка][4].Родитель) = Ложь, 2, 3);
		Иначе
			ТекУровень = ?(ТЗ[Строчка][0] = 4, 4, 0);
		КонецЕсли;
		
		ТабДок.Вывести(ОбластьДанные, ТекУровень);
		Период = 0;
		Для Каждого ТекПодразделение Из Деятельность Цикл
			Период = Период + 1;
			
			ОбластьДанныеСтолбцы.Параметры.Сумма1 =  ТЗ[Строчка][КолонкиПодразделений.Получить(ТекПодразделение)*2 + 4];
			
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьДанныеСтолбцы.Параметры.Сумма2 = ТЗ[Строчка][КолонкиПодразделений.Получить(ТекПодразделение)*2 + 6];
				ОбластьДанныеСтолбцы.Параметры.Сумма3 = ОбластьДанныеСтолбцы.Параметры.Сумма2 - ОбластьДанныеСтолбцы.Параметры.Сумма1;
				//Колонка = Колонка + 1;
			КонецЕсли;
			
			СтруктураРасшифровки = Новый Структура;
			СтруктураРасшифровки.Вставить("Отчет", "Отчеты.Д_Расшифровка");
			СтруктураРасшифровки.Вставить("Счет", ПланСчетов1.ЗатратыНаПрво);
			СтруктураРасшифровки.Вставить("Предприятие", ТЗ[Строчка][3]);
			СтруктураРасшифровки.Вставить("Субконто1", ТЗ[Строчка][4]);
			СтруктураРасшифровки.Вставить("Субконто2", ТекПодразделение);
			СтруктураРасшифровки.Вставить("Дата1", Отчет.Период.ДатаНачала);
			СтруктураРасшифровки.Вставить("Дата2", Отчет.Период.ДатаОкончания);
			СтруктураРасшифровки.Вставить("ВидимостьШапки", 0);
			СтруктураРасшифровки.Вставить("Сценарий1", Отчет.Сценарий1);
			
			ОбластьДанныеСтолбцы.Параметры.Расшифровка = СтруктураРасшифровки;
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				СтруктураРасшифровки2 = Новый Структура;
				СтруктураРасшифровки2.Вставить("Отчет", "Отчеты.Д_Расшифровка");
				СтруктураРасшифровки2.Вставить("Счет", ПланСчетов2.ЗатратыНаПрво);
				СтруктураРасшифровки2.Вставить("Предприятие", ТЗ[Строчка][3]);
				СтруктураРасшифровки2.Вставить("Субконто1", ТЗ[Строчка][4]);
				СтруктураРасшифровки2.Вставить("Дата1", ?(ВсегоПериодов > 1, НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), Отчет.Период.ДатаНачала));
				СтруктураРасшифровки2.Вставить("Дата2", ?(ВсегоПериодов > 1, КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)), Отчет.Период.ДатаОкончания));
				СтруктураРасшифровки2.Вставить("ВидимостьШапки", 0);
				СтруктураРасшифровки2.Вставить("Сценарий1", Отчет.Сценарий2);
				ОбластьДанныеСтолбцы.Параметры.Расшифровка2 = СтруктураРасшифровки2;
			КонецЕсли;
			
			ТабДок.Присоединить(ОбластьДанныеСтолбцы, ТекУровень);
			
			//Колонка = Колонка + 1;
		КонецЦикла;
	КонецЦикла;
	
			
	ТабДок.ЗакончитьАвтогруппировкуСтрок();

		
	// di 15.05.13
		
		
	КонецЦикла;
	
	
	
	////сворачиваем таблицу значений и выводим на печать		
	//ТЗ.Свернуть("Шрифт, Порядок, Признак, Предприятие, Значение", НаборИмен);
	//
	//ПросуммироватьТЗПоКолонкам(ТЗ);
	//
	//ТабДок.НачатьАвтогруппировкуСтрок();
	//Для Строчка = 0 По ТЗ.Количество()-1 Цикл
	//	
	//	Если Лев(ТЗ[Строчка][4], 18) = "Объем производства" Тогда // выводим шапку
	//		
	//		//ОбластьШапка.Параметры.Номенклатура = Сред(ТЗ[Строчка][4], 20, СтрДлина(ТЗ[Строчка][4]));
	//		ОбластьШапка.Параметры.Предприятие = ТЗ[Строчка][3];
	//		ОбластьШапка.Параметры.Месяц = ПредставлениеПериода(Отчет.Период.ДатаНачала, Отчет.Период.ДатаОкончания);;
	//		ТабДок.Вывести(ОбластьШапка);
	//		Период = 0;
	//		Для Колонка = 1 По Деятельность.Количество() Цикл
	//			ОбластьШапкаСтолбцы.Параметры.Деятельность = Деятельность[Колонка - 1];	
	//			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
	//				ОбластьШапкаСтолбцы.Параметры.Сценарий1 = Отчет.Сценарий1;
	//				ОбластьШапкаСтолбцы.Параметры.Сценарий2 = Отчет.Сценарий2;
	//			КонецЕсли;
	//			ТабДок.Присоединить(ОбластьШапкаСтолбцы);
	//		КонецЦикла;
	//		Продолжить;
	//	КонецЕсли;
	//	
	//	//получаем шрифт
	//	ОбластьДанные = Макет.ПолучитьОбласть("Строка" + строка(ТЗ[Строчка][0]) + "|СтолбецНачало");
	//	ОбластьДанныеСтолбцы = Макет.ПолучитьОбласть("Строка" + строка(ТЗ[Строчка][0]) + "|ДанныеСтолбца");			
	//	
	//	//получаем данные
	//	ОбластьДанные.Параметры.Статья = ТЗ[Строчка][4];
	//	
	//	
	//	ТабДок.Вывести(ОбластьДанные, строка(ТЗ[Строчка][0]));
	//	Период = 0;
	//	Для Каждого ТекПодразделение Из Деятельность Цикл
	//		Период = Период + 1;
	//		
	//		ОбластьДанныеСтолбцы.Параметры.Сумма1 =  ТЗ[Строчка][КолонкиПодразделений.Получить(ТекПодразделение)*2 + 4];
	//		
	//		Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
	//			ОбластьДанныеСтолбцы.Параметры.Сумма2 = ТЗ[Строчка][КолонкиПодразделений.Получить(ТекПодразделение)*2 + 6];
	//			ОбластьДанныеСтолбцы.Параметры.Сумма3 = ОбластьДанныеСтолбцы.Параметры.Сумма2 - ОбластьДанныеСтолбцы.Параметры.Сумма1;
	//			//Колонка = Колонка + 1;
	//		КонецЕсли;
	//		
	//		СтруктураРасшифровки = Новый Структура;
	//		СтруктураРасшифровки.Вставить("Отчет", "Отчеты.Д_Расшифровка");
	//		СтруктураРасшифровки.Вставить("Счет", ПланСчетов1.ЗатратыНаПрво);
	//		СтруктураРасшифровки.Вставить("Предприятие", ТЗ[Строчка][3]);
	//		СтруктураРасшифровки.Вставить("Субконто1", ТЗ[Строчка][4]);
	//		СтруктураРасшифровки.Вставить("Субконто2", ТекПодразделение);
	//		СтруктураРасшифровки.Вставить("Дата1", Отчет.Период.ДатаНачала);
	//		СтруктураРасшифровки.Вставить("Дата2", Отчет.Период.ДатаОкончания);
	//		СтруктураРасшифровки.Вставить("ВидимостьШапки", 0);
	//		СтруктураРасшифровки.Вставить("Сценарий1", Отчет.Сценарий1);
	//		
	//		ОбластьДанныеСтолбцы.Параметры.Расшифровка = СтруктураРасшифровки;
	//		Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
	//			СтруктураРасшифровки2 = Новый Структура;
	//			СтруктураРасшифровки2.Вставить("Отчет", "Отчеты.Д_Расшифровка");
	//			СтруктураРасшифровки2.Вставить("Счет", ПланСчетов2.ЗатратыНаПрво);
	//			СтруктураРасшифровки2.Вставить("Предприятие", ТЗ[Строчка][3]);
	//			СтруктураРасшифровки2.Вставить("Субконто1", ТЗ[Строчка][4]);
	//			СтруктураРасшифровки2.Вставить("Дата1", ?(ВсегоПериодов > 1, НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), Отчет.Период.ДатаНачала));
	//			СтруктураРасшифровки2.Вставить("Дата2", ?(ВсегоПериодов > 1, КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)), Отчет.Период.ДатаОкончания));
	//			СтруктураРасшифровки2.Вставить("ВидимостьШапки", 0);
	//			СтруктураРасшифровки2.Вставить("Сценарий1", Отчет.Сценарий2);
	//			ОбластьДанныеСтолбцы.Параметры.Расшифровка2 = СтруктураРасшифровки2;
	//		КонецЕсли;
	//		
	//		ТабДок.Присоединить(ОбластьДанныеСтолбцы, строка(ТЗ[Строчка][0]));
	//		
	//		//Колонка = Колонка + 1;
	//	КонецЦикла;
	//КонецЦикла;
	//
	//		
	//ТабДок.ЗакончитьАвтогруппировкуСтрок();
	
	
	//таблицу на экран
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.Защита = Ложь;
	ТабДок.ТолькоПросмотр = Истина;
	ТабДок.ОтображатьЗаголовки = Ложь;
	//ТабДок.Показать();
	Элементы.ТабДок.Видимость = Истина;
	
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТаблицу(ВидОтчета)
	
	
	//при выборе сценария факта в одном из полей Сценарий
	ПланСчетов1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, ПланыСчетов.Учетный, ПланыСчетов.Учетный);
	ПланСчетов2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, ПланыСчетов.Учетный, ПланыСчетов.Учетный);
	Регистр1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, "Учетный", "Бюджетный");
	Регистр2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, "Учетный", "Бюджетный");
	ПС_Сц1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, "ПланСчетов.Учетный", "ПланСчетов.Учетный");
	ПС_Сц2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, "ПланСчетов.Учетный", "ПланСчетов.Учетный"); 
	
	
	//определяем таблицу значений, в которую будем вносить все значения
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Шрифт"); //1) 1-обычный, 2 - жирный, 3 - курсив
	
	ТЗ.Колонки.Добавить("Порядок");//2) для структурирования дальнейшего вывода
	ТЗ.Колонки.Добавить("Признак");//3) для уникальности строки
	//порядок и признак выступают уникальным идентификтором строки
	
	ТЗ.Колонки.Добавить("Предприятие");//4) для обозначения разных предприятий
	ТЗ.Колонки.Добавить("Подразделение"); // 23.05.13
	
	ТЗ.Колонки.Добавить("Значение");//5)
	ТЗ.Колонки.Добавить("Резерв1");
	ТЗ.Колонки.Добавить("Резерв2");
	ТЗ.Колонки.Добавить("Резерв3");
	ТЗ.Колонки.Добавить("Резерв4");
	ТЗ.Колонки.Добавить("Резерв5");
	НаборИмен = ""; ИндексКолонки = 11;
	Для Кол = 1 По 100 Цикл // добавляем заранее все колонки в ТЗ с индекса 9
		ИмяКол = "Колонка" + строка(Кол);
		НаборИмен = НаборИмен + ИмяКол + ",";
		ТЗ.Колонки.Добавить(ИмяКол);
	КонецЦикла; 
	
	Попытка
	    ЭтотОбъект2 = ВнешниеОтчеты.Создать("Д_ФРПроектов");	
	Исключение
		ЭтотОбъект2 = Отчеты.Д_ФРПроектов;
	КонецПопытки;

	
	Если НЕ ПустаяСтрока(Отчет.Сценарий1) и  НЕ ПустаяСтрока(Отчет.Сценарий2) Тогда
		ИмяМакета = "МакетПланФакт" + ?(ТочностьДва, "Дробь", "");
		Макет = ЭтотОбъект2.ПолучитьМакет("МакетПланФакт");
	иначе
		ИмяМакета = "Макет" + ?(ТочностьДва, "Дробь", "");
		Макет = ЭтотОбъект2.ПолучитьМакет(ИмяМакета);
	КонецЕсли; 
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка|СтолбецНачало");
	
	ОбластьШапкаПредпр = Макет.ПолучитьОбласть("ШапкаПредприятие|СтолбецНачало");
	ОбластьШапкаПредпрСтолбцы = Макет.ПолучитьОбласть("ШапкаПредприятие|ДанныеСтолбца");
	
	Если ПоПодразделениям Тогда
		ОбластьШапкаПодразделение = Макет.ПолучитьОбласть("ШапкаПодразделение|СтолбецНачало");
		ОбластьШапкаПодразделениеСтолбцы = Макет.ПолучитьОбласть("ШапкаПодразделение|ДанныеСтолбца");
	КонецЕсли;	
		
	ОбластьИтогоПредприятие = Макет.ПолучитьОбласть("ИтогоПоПредприятию|СтолбецНачало");
	ОбластьИтогоПредприятиеСтолбцы = Макет.ПолучитьОбласть("ИтогоПоПредприятию|ДанныеСтолбца");
	
	ТабДок.Очистить();
	ВставлятьРазделительСтраниц = Ложь;
	
	
	Интервал = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, 1, 
	?(Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, 3, 12));
	
	КлючПериод = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, "Месяц", ?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, "Квартал", "Год"));
	
	НачалоПериода = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, Месяц(Отчет.Период.ДатаНачала),?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, ОпределитьКвартал(Месяц(Отчет.Период.ДатаНачала)), Год(Отчет.Период.ДатаНачала)));
	
	КонецПериода = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, Месяц(Отчет.Период.ДатаОкончания),?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, ОпределитьКвартал(Месяц(Отчет.Период.ДатаОкончания)), Год(Отчет.Период.ДатаОкончания)));
		
	// #большегода {
	Если Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно Тогда
		мнИнтервала = 86400 * 30
	ИначеЕсли Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально Тогда
		мнИнтервала = 86400 * 30 * 3
	Иначе
		мнИнтервала = 86400 * 30 * 3 * 4
	КонецЕсли;
	
	ВсегоПериодов = Окр((КонецДня(Отчет.Период.ДатаОкончания)+1 - НачалоДня( Отчет.Период.ДатаНачала)) / мнИнтервала, 0, РежимОкругления.Окр15как10);
	//}
		
	ПредприятияМассив = Новый Массив;
	ПодразделенияМассив = Новый Массив;
	// di 23.05.13
	ПодразделенияМассив.Добавить(Справочники.СтруктураПредприятия.ПустаяСсылка());
	
	Для каждого Т Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
		
		Если Т.Пометка Тогда
			
			ПредприятияМассив.Добавить(Т.Значение);
			
			Если ПоПодразделениям Тогда
				
				Для Каждого СтрПодр Из Т.ПолучитьЭлементы() Цикл
				
					Если СтрПодр.Пометка Тогда
						ПодразделенияМассив.Добавить(СтрПодр.Значение);
					КонецЕсли;
				
				КонецЦикла;
				
			Иначе
				
				ТекПодразделения = Справочники.СтруктураПредприятия.Выбрать(,Т.Значение);
				
				Пока ТекПодразделения.Следующий() Цикл
					
					ПодразделенияМассив.Добавить(ТекПодразделения.Ссылка);
					
				КонецЦикла;
				
			КонецЕсли;	
				
		КонецЕсли;		
			
	КонецЦикла; 
	
	//Предпр = Т.Значение;
	ДатаНач = Отчет.Период.ДатаНачала;
	ДатаКон = Отчет.Период.ДатаОкончания;
	СчетчикМесяцев = 0;
	СчетчикНоменклатур = 0;
	КоэффициентОтступа = 0;
	
	Если Отчет.ВидОтчета = 1 ИЛИ Отчет.ВидОтчета = 0 Тогда
		//90.3
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0) КАК Сумма1,
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0) КАК Сумма2,
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ КАК Период,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ КАК ПериодДата,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1 Иначе  ДанныеСценарий2.Субконто2 конец
		|		ИНАЧЕ выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1 Иначе  ДанныеСценарий1.Субконто2 конец
		|	КОНЕЦ КАК Статья,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1.Родитель Иначе  ДанныеСценарий2.Субконто2.Родитель конец
		|		ИНАЧЕ выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1.Родитель Иначе ДанныеСценарий1.Субконто2.Родитель конец
		|	КОНЕЦ КАК Родитель1,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ КАК Предприятие,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL 
		|			ТОГДА ВЫБОР
		|					КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL
		|						ТОГДА (ВЫБОР
		|									КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|										ТОГДА ДанныеСценарий2.Предприятия
		|									ИНАЧЕ ДанныеСценарий1.Предприятия
		|								КОНЕЦ).ВидДеятельности
		|						ИНАЧЕ ДанныеСценарий2.Подразделение
		|				  КОНЕЦ	
		|			ИНАЧЕ ДанныеСценарий1.Подразделение
		|	КОНЕЦ КАК Подразделение
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет В (&Счет),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет В (&Счет2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И (" + КлючПериод + "(ДанныеСценарий1.Период) = " + КлючПериод + "(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|			И ДанныеСценарий1.Подразделение = ДанныеСценарий2.Подразделение
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0),
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL 
		|			ТОГДА ВЫБОР
		|					КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL
		|						ТОГДА (ВЫБОР
		|									КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|										ТОГДА ДанныеСценарий2.Предприятия
		|									ИНАЧЕ ДанныеСценарий1.Предприятия
		|								КОНЕЦ).ВидДеятельности
		|						ИНАЧЕ ДанныеСценарий2.Подразделение
		|				  КОНЕЦ	
		|			ИНАЧЕ ДанныеСценарий1.Подразделение
		|	КОНЕЦ
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет В (&СчетаДоход),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И Подразделение В (&Подразделения)
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет В (&СчетаДоход2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И (" + КлючПериод + "(ДанныеСценарий1.Период) = " + КлючПериод + "(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|			И ДанныеСценарий1.Подразделение = ДанныеСценарий2.Подразделение
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0),
		|	ВЫБОР
		|		КОГДА "+ КлючПериод +"(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА "+ КлючПериод +"(ДанныеСценарий2.Период)
		|		ИНАЧЕ "+ КлючПериод +"(ДанныеСценарий1.Период)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL 
		|			ТОГДА ВЫБОР
		|					КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL
		|						ТОГДА (ВЫБОР
		|									КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|										ТОГДА ДанныеСценарий2.Предприятия
		|									ИНАЧЕ ДанныеСценарий1.Предприятия
		|								КОНЕЦ).ВидДеятельности
		|						ИНАЧЕ ДанныеСценарий2.Подразделение
		|				  КОНЕЦ	
		|			ИНАЧЕ ДанныеСценарий1.Подразделение
		|	КОНЕЦ
		|ИЗ
		|	РегистрБухгалтерии."+ Регистр1 +".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			"+ КлючПериод +",
		|			Счет В (&Счет91Сц1),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1
		|				И " + ?(Регистр1 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии."+ Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				"+ КлючПериод +",
		|				Счет В (&Счет91Сц2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2
		|					И " + ?(Регистр2 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И ("+ КлючПериод +"(ДанныеСценарий1.Период) = "+ КлючПериод +"(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|			И ДанныеСценарий1.Подразделение = ДанныеСценарий2.Подразделение
		|;					   
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СтатьиЗатрат.Ссылка КАК Статья,
		|	СтатьиЗатрат.ЭтоГруппа,
		|	ЕСТЬNULL(Данные.Сумма1, 0) КАК Сумма1,
		|	ЕСТЬNULL(Данные.Сумма2, 0) КАК Сумма2,
		|	ЕСТЬNULL(Данные.Период, 0) КАК Период,
		|	Данные.ПериодДата,
		|	Данные.Предприятие,
		|	Данные.Подразделение
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		|		ПОЛНОЕ СОЕДИНЕНИЕ Данные КАК Данные
		|		ПО (СтатьиЗатрат.Ссылка = Данные.Статья
		|				ИЛИ СтатьиЗатрат.Ссылка = Данные.Родитель1)
		|
		|УПОРЯДОЧИТЬ ПО
		|	СтатьиЗатрат.Код";
		
	ИначеЕсли Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 тогда
		
		//90.3
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	СУММА(-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0)) КАК Сумма1,
		               |	СУММА(0) КАК Сумма2,
		               |	" + КлючПериод + "(ДанныеСценарий1.Период) КАК Период,
					   |	ДанныеСценарий1.Период КАК ПериодДата,
					   |	выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1 Иначе ДанныеСценарий1.Субконто2 конец КАК Статья,
					   |	выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1.Родитель Иначе ДанныеСценарий1.Субконто2.Родитель конец КАК Родитель1,
		               |	ДанныеСценарий1.Предприятия КАК Предприятие,
		               |	ВЫБОР КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий1.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий1.Подразделение КОНЕЦ КАК Подразделение,
		               |	БюджетныйДвиженияССубконто1.Содержание КАК Содержание
		               |ПОМЕСТИТЬ Данные
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет В (&Счет),
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И Подразделение В (&Подразделения)
		               |				И СценарийПлана = &Сценарий1,
		               |			,
		               |			) КАК ДанныеСценарий1
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И Подразделение В (&Подразделения)
		               |					И СценарийПлана = &Сценарий1,
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто1
		               |		ПО ДанныеСценарий1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		               |			И ДанныеСценарий1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	" + КлючПериод + "(ДанныеСценарий1.Период),
					   |	ДанныеСценарий1.Период,
 					   |	ДанныеСценарий1.Субконто2,
					   |	ДанныеСценарий1.Субконто2.Родитель,
		               |	ДанныеСценарий1.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий1.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий1.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто1.Содержание
		               |
		               |ОБЪЕДИНИТЬ
		               |
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	СУММА(0),
		               |	СУММА(-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0)),
		               |	" + КлючПериод + "(ДанныеСценарий2.Период),
					   |	ДанныеСценарий2.Период,
					   |	выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1 Иначе ДанныеСценарий2.Субконто2 конец,
					   |	выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1.Родитель Иначе ДанныеСценарий2.Субконто2.Родитель конец,
		               |	ДанныеСценарий2.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий2.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий2.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто2.Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр2 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет В (&Счет2),
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		               |				И СценарийПлана = &Сценарий2,
		               |			,
		               |			) КАК ДанныеСценарий2
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		               |					И СценарийПлана = &Сценарий2,
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто2
		               |		ПО ДанныеСценарий2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		               |			И ДанныеСценарий2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	" + КлючПериод + "(ДанныеСценарий2.Период),
					   |	ДанныеСценарий2.Период,
					   |	ДанныеСценарий2.Субконто2,
			    	   |	ДанныеСценарий2.Субконто2.Родитель,
		               |	ДанныеСценарий2.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий2.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий2.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто2.Содержание
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	СУММА(-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0)),
		               |	СУММА(0),
		               |	" + КлючПериод + "(ДанныеСценарий1.Период),
					   |	ДанныеСценарий1.Период,
		               |	""Выручка от реализации"",
		               |	""Доходы"",
		               |	ДанныеСценарий1.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий1.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий1.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто1.Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет В (&СчетаДоход),
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		               |				И СценарийПлана = &Сценарий1,
		               |			,
		               |			) КАК ДанныеСценарий1
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		               |					И СценарийПлана = &Сценарий1,
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто1
		               |		ПО ДанныеСценарий1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		               |			И ДанныеСценарий1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	" + КлючПериод + "(ДанныеСценарий1.Период),
					   |	ДанныеСценарий1.Период,
		               |	ДанныеСценарий1.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий1.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий1.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто1.Содержание
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	СУММА(0),
					   |	СУММА(-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0)),
		               |	" + КлючПериод + "(ДанныеСценарий2.Период),
					   |	ДанныеСценарий2.Период,
		               |	""Выручка от реализации"",
		               |	""Доходы"",
		               |	ДанныеСценарий2.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий2.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий2.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто2.Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр2 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет В (&СчетаДоход2),
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		               |				И СценарийПлана = &Сценарий2,
		               |			,
		               |			) КАК ДанныеСценарий2
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И Выбор Когда Подразделение ЕСТЬ NULL Тогда Истина Иначе Подразделение В (&Подразделения) Конец
		               |					И СценарийПлана = &Сценарий2,
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто2
		               |		ПО ДанныеСценарий2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		               |			И ДанныеСценарий2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	" + КлючПериод + "(ДанныеСценарий2.Период),
					   |	ДанныеСценарий2.Период,
		               |	ДанныеСценарий2.Предприятия,
					   |	ВЫБОР КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий2.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий2.Подразделение КОНЕЦ,
					   |	БюджетныйДвиженияССубконто2.Содержание
					   |
					   |ОБЪЕДИНИТЬ ВСЕ
					   |ВЫБРАТЬ
					   |	СУММА(-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0)),
					   |	СУММА(0),
					   |	"+ КлючПериод +"(ДанныеСценарий1.Период),
					   |	ДанныеСценарий1.Период,
					   |	""Выручка от реализации"",
					   |	""Доходы"",
					   |	ДанныеСценарий1.Предприятия,
					   |	ВЫБОР КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий1.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий1.Подразделение КОНЕЦ,
					   |	БюджетныйДвиженияССубконто1.Содержание
					   |ИЗ
					   |	РегистрБухгалтерии." + Регистр1 + ".Обороты(
					   |			&Дата1,
					   |			&Дата2,
					   |			Запись,
					   |			Счет В (&Счет91Сц1),
					   |			,
					   |			Предприятия В ИЕРАРХИИ (&Предприятия)
					   |				И СценарийПлана = &Сценарий1
					   |				И " + ?(Регистр1 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
					   |			,
					   |			) КАК ДанныеСценарий1
					   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
					   |				&Дата1,
					   |				&Дата2,
					   |				Предприятия В ИЕРАРХИИ (&Предприятия)
					   |					И СценарийПлана = &Сценарий1,
					   |				,
					   |				) КАК БюджетныйДвиженияССубконто1
					   |		ПО ДанныеСценарий1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
					   |			И ДанныеСценарий1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
					   |
					   |СГРУППИРОВАТЬ ПО
		               |	" + КлючПериод + "(ДанныеСценарий1.Период),
					   |	ДанныеСценарий1.Период,
		               |	ДанныеСценарий1.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий1.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий1.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий1.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто1.Содержание
					   |
					   |ОБЪЕДИНИТЬ ВСЕ
					   |ВЫБРАТЬ
					   |	СУММА(0),
					   |	СУММА(-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0)),
					   |	"+ КлючПериод +"(ДанныеСценарий2.Период),
					   |	ДанныеСценарий2.Период,
					   |	""Выручка от реализации"",
					   |	""Доходы"",
					   |	ДанныеСценарий2.Предприятия,
					   |	ВЫБОР КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий2.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий2.Подразделение КОНЕЦ,
					   |	БюджетныйДвиженияССубконто2.Содержание
					   |ИЗ
					   |	РегистрБухгалтерии." + Регистр2 + ".Обороты(
					   |			&Дата1,
					   |			&Дата2,
					   |			Запись,
					   |			Счет В (&Счет91Сц2),
					   |			,
					   |			Предприятия В ИЕРАРХИИ (&Предприятия)
					   |				И СценарийПлана = &Сценарий2
					   |				И " + ?(Регистр2 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
					   |			,
					   |			) КАК ДанныеСценарий2
					   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
					   |				&Дата1,
					   |				&Дата2,
					   |				Предприятия В ИЕРАРХИИ (&Предприятия)
					   |					И СценарийПлана = &Сценарий2,
					   |				,
					   |				) КАК БюджетныйДвиженияССубконто2
					   |		ПО ДанныеСценарий2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
					   |			И ДанныеСценарий2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
					   |
					   |СГРУППИРОВАТЬ ПО
		               |	" + КлючПериод + "(ДанныеСценарий2.Период),
					   |	ДанныеСценарий2.Период,
		               |	ДанныеСценарий2.Предприятия,
		               |	ВЫБОР КОГДА ДанныеСценарий2.Подразделение ЕСТЬ NULL ТОГДА ДанныеСценарий2.Предприятия.ВидДеятельности ИНАЧЕ ДанныеСценарий2.Подразделение КОНЕЦ,
		               |	БюджетныйДвиженияССубконто2.Содержание
					   |;
					   |
					   |////////////////////////////////////////////////////////////////////////////////
					   |ВЫБРАТЬ
					   |	СтатьиЗатрат.Ссылка КАК Статья,
					   |	СтатьиЗатрат.ЭтоГруппа,
					   |	ЕСТЬNULL(Данные.Сумма1, 0) КАК Сумма1,
		               |	ЕСТЬNULL(Данные.Сумма2, 0) КАК Сумма2,
		               |	ЕСТЬNULL(Данные.Период, 0) КАК Период,
					   |	Данные.ПериодДата,
		               |	Данные.Предприятие,
		               |	Данные.Подразделение,
		               |	Данные.Содержание
		               |ИЗ
		               |	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		               |		ПОЛНОЕ СОЕДИНЕНИЕ Данные КАК Данные
		               |		ПО (СтатьиЗатрат.Ссылка = Данные.Статья
		               |				ИЛИ СтатьиЗатрат.Ссылка = Данные.Родитель1)
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	СтатьиЗатрат.Код";
		
	ИначеЕсли Отчет.ВидОтчета = 3 Тогда		
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Предприятия", ПредприятияМассив);
	Запрос.УстановитьПараметр("Подразделения", ПодразделенияМассив);
	Запрос.УстановитьПараметр("Сценарий1", Отчет.Сценарий1);
	Запрос.УстановитьПараметр("Сценарий2", Отчет.Сценарий2);
	Запрос.УстановитьПараметр("Дата1", ДатаНач);
	Запрос.УстановитьПараметр("Дата2", ДатаКон);
	МассивСчетов90_Сц1 = Новый Массив;
	МассивСчетов90_Сц1.Добавить(ПланСчетов1.Себестоимость);
	МассивСчетов90_Сц1.Добавить(ПланСчетов1.РасходыПоРеал);
	Запрос.УстановитьПараметр("Счет", МассивСчетов90_Сц1);
	Запрос.УстановитьПараметр("Счет90_2_Сц1", ПланСчетов1.Себестоимость);
	МассивСчетов90_Сц2 = Новый Массив;
	МассивСчетов90_Сц2.Добавить(ПланСчетов2.Себестоимость);
	МассивСчетов90_Сц2.Добавить(ПланСчетов2.РасходыПоРеал);
	Запрос.УстановитьПараметр("Счет2", МассивСчетов90_Сц2);
	Запрос.УстановитьПараметр("Счет90_2_Сц2", ПланСчетов2.Себестоимость);
	СчетаДоход = Новый Массив;
	СчетаДоход.Добавить(ПланСчетов1.ВыручкаОтРеал);
	СчетаДоход.Добавить(ПланСчетов1.РеалОС);
	СчетаДоход2 = Новый Массив;
	СчетаДоход2.Добавить(ПланСчетов2.ВыручкаОтРеал);
	СчетаДоход2.Добавить(ПланСчетов2.РеалОС);
	Запрос.УстановитьПараметр("СчетаДоход", СчетаДоход);
	Запрос.УстановитьПараметр("СчетаДоход2", СчетаДоход2);
	Запрос.УстановитьПараметр("Счет91Сц1", ПланСчетов1.ДоходыИРасходы);
	Запрос.УстановитьПараметр("Счет91Сц2", ПланСчетов2.ДоходыИРасходы);

	РезультатЗатраты = Запрос.Выполнить();
	
	//91 счет
	Запрос = Новый Запрос;
	Если Отчет.ВидОтчета = 1 ИЛИ Отчет.ВидОтчета = 0 Тогда
		
		Запрос.Текст = "ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(Прочие1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(Прочие2.Период)
		|		ИНАЧЕ " + КлючПериод + "(Прочие1.Период)
		|	КОНЕЦ КАК Период,
		|	ВЫБОР
		|		КОГДА Прочие1.Период ЕСТЬ NULL 
		|			ТОГДА Прочие2.Период
		|		ИНАЧЕ Прочие1.Период
		|	КОНЕЦ КАК ПериодДата,
		|	ВЫБОР
		|		КОГДА Прочие1.Субконто1 ЕСТЬ NULL 
		|			ТОГДА Прочие2.Субконто1
		|		ИНАЧЕ Прочие1.Субконто1
		|	КОНЕЦ КАК Статья,
		|	-ЕСТЬNULL(Прочие1.СуммаОборот, 0) КАК Сумма1,
		|	-ЕСТЬNULL(Прочие2.СуммаОборот, 0) КАК Сумма2,
		|	ВЫБОР
		|		КОГДА Прочие1.Предприятия ЕСТЬ NULL 
		|			ТОГДА Прочие2.Предприятия
		|		ИНАЧЕ Прочие1.Предприятия
		|	КОНЕЦ КАК Предприятие,
		|	ВЫБОР
		|		КОГДА Прочие1.Подразделение ЕСТЬ NULL 
		|			ТОГДА Прочие2.Подразделение
		|		ИНАЧЕ Прочие1.Подразделение
		|	КОНЕЦ КАК Подразделение,
		|	ВЫБОР
		|		КОГДА Прочие1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА Прочие2.Субконто2
		|		ИНАЧЕ Прочие1.Субконто2
		|	КОНЕЦ КАК Деятельность,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСубконто1 ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСубконто1
		|		ИНАЧЕ Прочие1.КорСубконто1
		|	КОНЕЦ КАК Статья25,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСубконто1 ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСубконто1.Код
		|		ИНАЧЕ Прочие1.КорСубконто1.Код
		|	КОНЕЦ КАК Статья25Код,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСубконто1.Родитель ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСубконто1.Родитель
		|		ИНАЧЕ Прочие1.КорСубконто1.Родитель
		|	КОНЕЦ КАК КорРодитель,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСчет ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСчет
		|		ИНАЧЕ Прочие1.КорСчет
		|	КОНЕЦ КАК КорСчет
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет = &СчетДт2,
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия) И
		|			Подразделение В (&Подразделения)
		|				И СценарийПлана = &Сценарий1
        |			,
		|			) КАК Прочие1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет = &СчетДт3,
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия) И
		|				Подразделение В (&Подразделения)
		|					И СценарийПлана = &Сценарий2
		|			,
		|				) КАК Прочие2
		|		ПО (" + КлючПериод + "(Прочие1.Период) = " + КлючПериод + "(Прочие2.Период))
		|			И Прочие1.Субконто1 = Прочие2.Субконто1
		|			И Прочие1.Предприятия = Прочие2.Предприятия
		|			И Прочие1.Подразделение = Прочие2.Подразделение
		|			И Прочие1.Субконто2 = Прочие2.Субконто2
		|			И Прочие1.КорСчет = Прочие2.КорСчет
		|			И Прочие1.КорСубконто1 = Прочие2.КорСубконто1
		|
		|УПОРЯДОЧИТЬ ПО
		|	Статья,Статья25Код";
		
	ИначеЕсли Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 тогда
		Запрос.Текст = "ВЫБРАТЬ
		               |	" +КлючПериод+ "(Прочие1.Период) КАК Период,
					   |	Прочие1.Период КАК ПериодДата,
		               |	Прочие1.Субконто1 КАК Статья,
		               |	СУММА(-ЕСТЬNULL(Прочие1.СуммаОборот, 0)) КАК Сумма1,
		               |	СУММА(0) КАК Сумма2,
		               |	Прочие1.Предприятия КАК Предприятие,
		               |	Прочие1.Подразделение КАК Подразделение,
		               |	Прочие1.Субконто2 КАК Деятельность,
					   |	Прочие1.КорСубконто1 КАК Статья25,
		               |	Прочие1.КорСубконто1.Код КАК Статья25Код,
		               |	Прочие1.КорСубконто1.Родитель КАК КорРодитель,
		               |	Прочие1.КорСчет КАК КорСчет,
		               |	БюджетныйДвиженияССубконто1.Содержание КАК Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." +Регистр1+ ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет = &СчетДт2,
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И Подразделение В (&Подразделения)
		               |				И СценарийПлана = &Сценарий1
		               |			,
		               |			) КАК Прочие1
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." +Регистр1+ ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И Подразделение В (&Подразделения)
		               |					И СценарийПлана = &Сценарий1
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто1
		               |		ПО Прочие1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		               |			И Прочие1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	" +КлючПериод+ "(Прочие1.Период),
					   |	Прочие1.Период КАК ПериодДата,
		               |	Прочие1.Субконто1,
		               |	Прочие1.Предприятия,
		               |	Прочие1.Подразделение,
		               |	Прочие1.Субконто2,
					   |	Прочие1.КорСубконто1,
		               |	Прочие1.КорСубконто1.Код,
		               |	Прочие1.КорСубконто1.Родитель,
		               |	Прочие1.КорСчет,
		               |	БюджетныйДвиженияССубконто1.Содержание
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	" +КлючПериод+ "(Прочие2.Период),
					   |	Прочие2.Период,
		               |	Прочие2.Субконто1,
		               |	СУММА(0),
		               |	СУММА(-ЕСТЬNULL(Прочие2.СуммаОборот, 0)),
		               |	Прочие2.Предприятия,
		               |	Прочие2.Подразделение,
		               |	Прочие2.Субконто2,
					   |	Прочие2.КорСубконто1,
		               |	Прочие2.КорСубконто1.Код,
		               |	Прочие2.КорСубконто1.Родитель,
		               |	Прочие2.КорСчет,
		               |	БюджетныйДвиженияССубконто2.Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." +Регистр2+ ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет = &СчетДт3,
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И Подразделение В (&Подразделения)
		               |				И СценарийПлана = &Сценарий2 
		               |			,
		               |			) КАК Прочие2
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." +Регистр2+ ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И Подразделение В (&Подразделения)
		               |					И СценарийПлана = &Сценарий2 
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто2
		               |		ПО Прочие2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		               |			И Прочие2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	" +КлючПериод+ "(Прочие2.Период),
					   |	Прочие2.Период,
		               |	Прочие2.Субконто1,
		               |	Прочие2.Предприятия,
		               |	Прочие2.Подразделение,
		               |	Прочие2.Субконто2,
					   |	Прочие2.КорСубконто1,
		               |	Прочие2.КорСубконто1.Код,
		               |	Прочие2.КорСубконто1.Родитель,
		               |	Прочие2.КорСчет,
		               |	БюджетныйДвиженияССубконто2.Содержание
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	Статья, Статья25Код";
	ИначеЕсли Отчет.ВидОтчета = 3 Тогда
		
	КонецЕсли;
		
	
	Запрос.УстановитьПараметр("Предприятия", ПредприятияМассив);
	Запрос.УстановитьПараметр("Подразделения", ПодразделенияМассив);
	Запрос.УстановитьПараметр("Сценарий1", Отчет.Сценарий1);
	Запрос.УстановитьПараметр("Сценарий2", Отчет.Сценарий2);
	Запрос.УстановитьПараметр("Дата1", ДатаНач);
	Запрос.УстановитьПараметр("Дата2", ДатаКон);
	Запрос.УстановитьПараметр("СчетДт2", ПланСчетов1.ДоходыИРасходы);
	Запрос.УстановитьПараметр("СчетДт3", ПланСчетов2.ДоходыИРасходы);

	РезультатПрочиеЗатраты = Запрос.Выполнить();
	  
	
	
	// 16.05.13 di
		
	Для каждого Предприятие  Из ПредприятияМассив Цикл
		
		Для Каждого Подразделение Из ПодразделенияМассив Цикл
			
			Если Подразделение <> Справочники.СтруктураПредприятия.ПустаяСсылка() И Подразделение.Владелец <> Предприятие Тогда
				Продолжить;
			КонецЕсли;
			
			КолвоСтрокПодр = 0;
			
			//очищаем массив и присваиваем числовой тип
			ТекущиеДоходы1 = Новый Массив(50);
			ТекущиеДоходы2 = Новый Массив(50);
			ТекущиеЗатраты1 = Новый Массив(50);
			ТекущиеЗатраты2 = Новый Массив(50);
			ПрочиеЗатраты1 = Новый Массив(50);
			ПрочиеЗатраты2 = Новый Массив(50);
			Для т = 0 По 49 Цикл
				ТекущиеДоходы1[т] = 0;
				ТекущиеДоходы2[т] = 0;
				ТекущиеЗатраты1[т] = 0;
				ТекущиеЗатраты2[т] = 0;
				ПрочиеЗатраты1[т] = 0;
				ПрочиеЗатраты2[т] = 0;
			КонецЦикла;
				
			//опрос 90.3
			СтруктураПоиска = Новый Структура("Предприятие, Подразделение", Предприятие, Подразделение);
			Выборка = РезультатЗатраты.Выбрать();
			Пока Выборка.НайтиСледующий(СтруктураПоиска) цикл
			
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка("Объем производства");
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = Выборка.Подразделение;
				НоваяСтрока[5] = "Объем производства " + Строка("Ном");
			
				СчетчикМесяцев = Окр((Выборка.ПериодДата - ДатаНач) / мнИнтервала, 0, РежимОкругления.Окр15Как10) + 1; // #большегода
				КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
				
				НоваяСтрокаД = ТЗ.Добавить();
				НоваяСтрокаД[0] = 0;
				НоваяСтрокаД[1] = 0;
				НоваяСтрокаД[2] = Строка("Ном") + "Доходы";
				НоваяСтрокаД[3] = Выборка.Предприятие;
				НоваяСтрокаД[4] = Выборка.Подразделение;
				НоваяСтрокаД[5] = "Доходы";
							
				Если Не ЗначениеЗаполнено(Выборка.Статья) Тогда	
					НоваяСтрокаД[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = Выборка.Сумма1;
					НоваяСтрокаД[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = Выборка.Сумма2;
					ТекущиеДоходы1[СчетчикМесяцев] = ТекущиеДоходы1[СчетчикМесяцев] + Выборка.Сумма1; 
					ТекущиеДоходы2[СчетчикМесяцев] = ТекущиеДоходы2[СчетчикМесяцев] + Выборка.Сумма2;
					Если Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 Тогда
						НоваяСтрока = ТЗ.Добавить();
						НоваяСтрока[0] = 4;
						НоваяСтрока[1] = 0;
						НоваяСтрока[2] = Строка("НомДоход");
						НоваяСтрока[3] = Выборка.Предприятие;
						НоваяСтрока[4] = Выборка.Подразделение;
						НоваяСтрока[5] = Выборка.Содержание;
						НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = Выборка.Сумма1;
						НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = Выборка.Сумма2;
					КонецЕсли;	
					Продолжить;
				КонецЕсли;	
				
				НоваяСтрокаР = ТЗ.Добавить();
				НоваяСтрокаР[0] = 0;
				НоваяСтрокаР[1] = 0;
				НоваяСтрокаР[2] = Строка("Ном") + "Расходы";
				НоваяСтрокаР[3] = Выборка.Предприятие;
				НоваяСтрокаР[4] = Выборка.Подразделение;
				НоваяСтрокаР[5] = "Расходы";
				НоваяСтрокаР[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = 0;
				НоваяСтрокаР[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = 0;
				
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 1 - Выборка.ЭтоГруппа;
			
				Если НЕ Выборка.ЭтоГруппа Тогда
					ТекущиеЗатраты1[СчетчикМесяцев] = ТекущиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1; 
					ТекущиеЗатраты2[СчетчикМесяцев] = ТекущиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;									
				КонецЕсли;
			
			
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = Выборка.Подразделение;
				НоваяСтрока[5] = Выборка.Статья;
				НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = - Выборка.Сумма1;
				НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = - Выборка.Сумма2;
			
				Если НЕ Выборка.ЭтоГруппа И (Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4) Тогда
					НоваяСтрока = ТЗ.Добавить();
					НоваяСтрока[0] = 4;
					НоваяСтрока[1] = 0;
					НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
					НоваяСтрока[3] = Выборка.Предприятие;
					НоваяСтрока[4] = Выборка.Подразделение;
					НоваяСтрока[5] = Выборка.Содержание;
					НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = - Выборка.Сумма1;
					НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = - Выборка.Сумма2;
				КонецЕсли;
				КолвоСтрокПодр = КолвоСтрокПодр + 1;
			КонецЦикла;
		
			//итого по тек.деятельности
		
			Для СчетчикМесяцев = 1 По ВсегоПериодов Цикл
				Если ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты2[СчетчикМесяцев] Тогда
					КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
					СтрокаРасходов = ТЗ.НайтиСтроки(Новый Структура("Значение, Предприятие, Подразделение", "Расходы", Выборка.Предприятие, Выборка.Подразделение));
					СтрокаРасходов[0][СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = -ТекущиеЗатраты1[СчетчикМесяцев];
					СтрокаРасходов[0][СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = -ТекущиеЗатраты2[СчетчикМесяцев]; 

					НоваяСтрока = ТЗ.Добавить();
					НоваяСтрока[0] = 0; // 29.10.12
					НоваяСтрока[1] = 0;
					НоваяСтрока[2] = Строка("Ном") + строка("Прибыль по основной деятельности");
					НоваяСтрока[3] = Выборка.Предприятие;
					НоваяСтрока[4] = Выборка.Подразделение;
					НоваяСтрока[5] = "Прибыль по основной деятельности";
					НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = ТекущиеДоходы1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев];
					НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = ТекущиеДоходы2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев];
				КонецЕсли;
			
			КонецЦикла;
		
			//опрос 91
			СтруктураПоиска = Новый Структура("Предприятие, Подразделение", Предприятие, Подразделение);
			Выборка = РезультатПрочиеЗатраты.Выбрать();
			Пока Выборка.НайтиСледующий(СтруктураПоиска) цикл
			
				СчетчикМесяцев = Окр((Выборка.ПериодДата - ДатаНач) / мнИнтервала, 0, РежимОкругления.Окр15Как10) + 1; // #большегода
				КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
			
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 1;	
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка(Выборка.Подразделение) + Строка(Выборка.Статья);
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = Выборка.Подразделение;
				НоваяСтрока[5] = Выборка.Статья;
				НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = - Выборка.Сумма1;
				НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = - Выборка.Сумма2;
				ПрочиеЗатраты1[СчетчикМесяцев] = ПрочиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1;
				ПрочиеЗатраты2[СчетчикМесяцев] = ПрочиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;
			
				Если Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 Тогда
					НоваяСтрока = ТЗ.Добавить();
					НоваяСтрока[0] = 4;
					НоваяСтрока[1] = 0;
					НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
					НоваяСтрока[3] = Выборка.Предприятие;
					НоваяСтрока[4] = Выборка.Подразделение;
					НоваяСтрока[5] = Выборка.Содержание;
					НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = - Выборка.Сумма1;
					НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = - Выборка.Сумма2;
				КонецЕсли;
			
				Если Выборка.Статья = Справочники.СтатьиДоходовРасходов.Простой ИЛИ Выборка.Статья = Справочники.СтатьиДоходовРасходов.ПереносОстатков Тогда
					//КорСтатьи
					НоваяСтрокаГ = ТЗ.Добавить();
					НоваяСтрокаГ[0] = 2;	
					НоваяСтрокаГ[1] = 0;
					НоваяСтрокаГ[3] = Выборка.Предприятие;
					НоваяСтрокаГ[4] = Выборка.Подразделение;
					Если Выборка.КорСчет = ПланыСчетов.Учетный.Счет25() ИЛИ Выборка.КорСчет = ПланыСчетов.Учетный.Счет25() Тогда
						НоваяСтрокаГ[2] = Строка(Выборка.Подразделение) + Строка(Выборка.КорРодитель);
						НоваяСтрокаГ[5] = Выборка.КорРодитель;
						НоваяСтрока = ТЗ.Добавить();
						НоваяСтрока[0] = 4;	
						НоваяСтрока[1] = 0;
						НоваяСтрока[2] = Строка(Выборка.Подразделение) + Строка(Выборка.Статья25);
						НоваяСтрока[3] = Выборка.Предприятие;
						НоваяСтрока[4] = Выборка.Подразделение;
						НоваяСтрока[5] = Выборка.Статья25;
						НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = - Выборка.Сумма1;
						НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = - Выборка.Сумма2;
						//ПрочиеЗатраты1[СчетчикМесяцев] = ПрочиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1;
						//ПрочиеЗатраты2[СчетчикМесяцев] = ПрочиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;        23.05.13
					Иначе
						НоваяСтрокаГ[2] = Строка(Выборка.Подразделение) + "ПРОЧИЕ";
						НоваяСтрокаГ[5] = "ПРОЧИЕ";
					КонецЕсли;
					НоваяСтрокаГ[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = - Выборка.Сумма1;
					НоваяСтрокаГ[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = - Выборка.Сумма2;				
				КонецЕсли;
				КолвоСтрокПодр = КолвоСтрокПодр + 1;
			КонецЦикла;
		
			Для СчетчикМесяцев = 1 По ВсегоПериодов Цикл
				КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
				Если ТекущиеДоходы1[СчетчикМесяцев] ИЛИ ТекущиеДоходы2[СчетчикМесяцев] ИЛИ ПрочиеЗатраты1[СчетчикМесяцев] ИЛИ ПрочиеЗатраты2[СчетчикМесяцев] ИЛИ ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты2[СчетчикМесяцев] Тогда
					НоваяСтрока = ТЗ.Добавить();
					НоваяСтрока[0] = 0; // 29.10.12	
					НоваяСтрока[1] = 0;
					НоваяСтрока[2] = Строка(Подразделение) + "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
					НоваяСтрока[3] = Предприятие;
					НоваяСтрока[4] = Подразделение;
					НоваяСтрока[5] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
					НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = ТекущиеДоходы1[СчетчикМесяцев] + ПрочиеЗатраты1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев];
					НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = ТекущиеДоходы2[СчетчикМесяцев] + ПрочиеЗатраты2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев]
				Иначе
					Если КолвоСтрокПодр > 0 тогда
						НоваяСтрока = ТЗ.Добавить();
						НоваяСтрока[0] = 0; // 29.10.12	
						НоваяСтрока[1] = 0;
						НоваяСтрока[2] = Строка(Подразделение) + "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
						НоваяСтрока[3] = Предприятие;
						НоваяСтрока[4] = Подразделение;
						НоваяСтрока[5] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
						НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = 0;
						НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = 0
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		
		КонецЦикла;	
		
		// итого по предприятию
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока[0] = 0; // 29.10.12	
		НоваяСтрока[1] = 0;
		НоваяСтрока[2] = Строка(Выборка.Предприятие) + "ИТОГО ПО ПРЕДПРИЯТИЮ";
		НоваяСтрока[3] = Предприятие;
		НоваяСтрока[4] = Предприятие;
		НоваяСтрока[5] = "ИТОГО ПО ПРЕДПРИЯТИЮ";
		
		Для СчетчикМесяцев = 1 По ВсегоПериодов Цикл
			
			КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
						
			СуммаПредпр1 = 0;
			СуммаПредпр2 = 0;
			
			Для ИндСтр = 0 По ТЗ.Количество() - 2 Цикл
				
				Если ТипЗнч(ТЗ[ИндСтр][СчетчикМесяцев * 2 + 10 + КоэффициентОтступа]) = Тип("Число") И ТЗ[ИндСтр][5] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ" И ТЗ[ИндСтр][3] = Предприятие Тогда
					СуммаПредпр1 = СуммаПредпр1 + ТЗ[ИндСтр][СчетчикМесяцев * 2 + 10 + КоэффициентОтступа];
				КонецЕсли;
				
				Если ТипЗнч(ТЗ[ИндСтр][СчетчикМесяцев * 2 + 12 + КоэффициентОтступа]) = Тип("Число") И ТЗ[ИндСтр][5] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ" И ТЗ[ИндСтр][3] = Предприятие Тогда
					СуммаПредпр2 = СуммаПредпр2 + ТЗ[ИндСтр][СчетчикМесяцев * 2 + 12 + КоэффициентОтступа];
				КонецЕсли;
				
			КонецЦикла;
			
			НоваяСтрока[СчетчикМесяцев * 2 + 10 + КоэффициентОтступа] = СуммаПредпр1;
			НоваяСтрока[СчетчикМесяцев * 2+ 12 + КоэффициентОтступа] = СуммаПредпр2;
			
		КонецЦикла;
		
	КонецЦикла;
	
	// квартал помесячно год поквартально 
	ТекПериод = Отчет.Период;
	ТекИнтервал = Отчет.Помесячно;
	ИнтервалМеньше = БюджетныйНаСервере.ИнтервалМеньшеПериода(ТекПериод, ТекИнтервал);
	
	//сворачиваем таблицу значений и выводим на печать		
	ТЗ.Свернуть("Шрифт, Порядок, Признак, Предприятие, Подразделение, Значение", НаборИмен);
	
	//ПросуммироватьТЗ(ТЗ);
	
	ТабДок.НачатьАвтогруппировкуСтрок();
	
	ОбластьШапка.Параметры.Месяц = ПредставлениеПериода(Отчет.Период.ДатаНачала, Отчет.Период.ДатаОкончания);
	ТабДок.Вывести(ОбластьШапка);
	
	СтруктураПоискаПредприятий = Новый Структура("Значение", "ИТОГО ПО ПРЕДПРИЯТИЮ");
	МассивПредприятий = ТЗ.НайтиСтроки(СтруктураПоискаПредприятий);
		
	Для Каждого Эл Из МассивПредприятий Цикл
		
		// шапка по каждому предприятию
		ОбластьШапкаПредпр.Параметры.Предприятие = Эл.Предприятие;		                                                                                                            
		ТабДок.Вывести(ОбластьШапкаПредпр, 1);
		Период = 0;
		
		Для Колонка = 1 По ВсегоПериодов * ?(ПустаяСтрока(Отчет.Сценарий2), 1, 2) Цикл
			Период = Период + Интервал;
			ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий1 = Отчет.Сценарий1;
			
			Если ВсегоПериодов > 1 Тогда
				ОбластьШапкаПредпрСтолбцы.Параметры.Месяц = ПредставлениеПериода(НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)));	
			иначе
				ОбластьШапкаПредпрСтолбцы.Параметры.Месяц = ПредставлениеПериода(Отчет.Период.ДатаНачала, Отчет.Период.ДатаОкончания);	
			КонецЕсли; 
				
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий2 = Отчет.Сценарий2;
				Колонка = Колонка + 1;
			КонецЕсли;
			ТабДок.Присоединить(ОбластьШапкаПредпрСтолбцы, 1);
		КонецЦикла;
		
		Если ИнтервалМеньше Тогда
			ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий1 = Отчет.Сценарий1;
			ОбластьШапкаПредпрСтолбцы.Параметры.Месяц = "Итого";					
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий2 = Отчет.Сценарий2;
			КонецЕсли;
			ТабДок.Присоединить(ОбластьШапкаПредпрСтолбцы, 1);
		КонецЕсли;
		
		СтруктураПоискаПодразделений = Новый Структура("Значение", "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ");
		МассивПодразделений = ТЗ.НайтиСтроки(СтруктураПоискаПодразделений);
		
		Для Каждого ЭлПодр Из МассивПодразделений Цикл
			
			Если ЭлПодр.Предприятие <> Эл.Предприятие Тогда
				Продолжить;
			КонецЕсли;
			
			// шапка по каждому подразделению
			ОбластьШапкаПодразделение.Параметры.Подразделение = ?(ЗначениеЗаполнено(ЭлПодр.Подразделение), ЭлПодр.Подразделение, "Общий");		                                                                                                            
			ТабДок.Вывести(ОбластьШапкаПодразделение, 2);
			Период = 0;
			
			ИтогоСуммаПодр1 = 0;
			ИтогоСуммаПодр2 = 0;
			
			Для Колонка = 1 По ВсегоПериодов * ?(ПустаяСтрока(Отчет.Сценарий2), 1, 2) Цикл
				Период = Период + Интервал;
				ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр1 = ЭлПодр[Колонка * 2 + 5];
				ИтогоСуммаПодр1 = ИтогоСуммаПодр1 + ЭлПодр[Колонка * 2 + 5];			
				Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
					ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр2 = ЭлПодр[Колонка * 2 + 7];
					ИтогоСуммаПодр2 = ИтогоСуммаПодр2 + ЭлПодр[Колонка * 2 + 7];
					ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр3 = ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр2 - ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр1;
					Колонка = Колонка + 1;
				КонецЕсли;
				ТабДок.Присоединить(ОбластьШапкаПодразделениеСтолбцы, 2);
			КонецЦикла;
			
			Если ИнтервалМеньше Тогда
				ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр1 = ИтогоСуммаПодр1;							
				Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
					ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр2 = ИтогоСуммаПодр2;
					ОбластьШапкаПодразделениеСтолбцы.Параметры.СуммаПодр3 = ИтогоСуммаПодр2 - ИтогоСуммаПодр1;
				КонецЕсли;
				ТабДок.Присоединить(ОбластьШапкаПодразделениеСтолбцы, 2);
			КонецЕсли;
			
			СтруктураПоискаСтатей = Новый Структура("Подразделение", ЭлПодр.Подразделение);
			МассивСтатей = ТЗ.НайтиСтроки(СтруктураПоискаСтатей);
						
			Для Каждого ЭлСт Из МассивСтатей Цикл
				
				Если ЭлСт.Значение = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ" ИЛИ ЭлСт.Значение = "Объем производства Ном" Тогда
					Продолжить;
				КонецЕсли;
				
				//получаем шрифт
				ОбластьДанные = Макет.ПолучитьОбласть("Строка" + строка(ЭлСт[0]) + "|СтолбецНачало");
				ОбластьДанныеСтолбцы = Макет.ПолучитьОбласть("Строка" + строка(ЭлСт[0]) + "|ДанныеСтолбца");			
		
				//получаем данные
				ОбластьДанные.Параметры.Статья = ЭлСт[5];		
				
				Если (Лев(ЭлСт[5], 6) = "Доходы" И СтрДлина(ЭлСт[5]) = 6) ИЛИ (Лев(ЭлСт[5], 7) = "Расходы" И СтрДлина(ЭлСт[5]) = 7) Тогда
					ТекУровень = ЭлСт[0] + 3
				ИначеЕсли ТипЗнч(ЭлСт[5]) = Тип("СправочникСсылка.СтатьиЗатрат") ИЛИ ТипЗнч(ЭлСт[5]) = Тип("СправочникСсылка.СтатьиДоходовРасходов") Тогда
					Если ЭлСт[5].ЭтоГруппа = Ложь И Не ЗначениеЗаполнено(ЭлСт[5].Родитель) Тогда
						ТекУровень = ЭлСт[0] + 3;
					Иначе
						ТекУровень = ?(ЭлСт[5].ЭтоГруппа ИЛИ ЗначениеЗаполнено(ЭлСт[5].Родитель) = Ложь, ЭлСт[0] + 4, ЭлСт[0] + 5);
					КонецЕсли;	
				Иначе
					ТекУровень = ?(ЭлСт[0] = 4, ЭлСт[0] + 6, ЭлСт[0]);
				КонецЕсли;
				
				ТабДок.Вывести(ОбластьДанные, ТекУровень);
				Период = 0;
				
				ИтогоСумма1 = 0;
				ИтогоСумма2 = 0;
				
				Для Колонка = 1 По ВсегоПериодов * ?(ПустаяСтрока(Отчет.Сценарий2), 1, 2) Цикл
					
					Период = Период + Интервал;
					ОбластьДанныеСтолбцы.Параметры.Сумма1 = ЭлСт[Колонка * 2 + 5];
					ИтогоСумма1 = ИтогоСумма1 + ЭлСт[Колонка * 2 + 5];
					
					Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
						ОбластьДанныеСтолбцы.Параметры.Сумма2 = ЭлСт[Колонка * 2 + 7];
						ИтогоСумма2 = ИтогоСумма2 + ЭлСт[Колонка * 2 + 7];
						ОбластьДанныеСтолбцы.Параметры.Сумма3 = ОбластьДанныеСтолбцы.Параметры.Сумма2 - ОбластьДанныеСтолбцы.Параметры.Сумма1;
						Колонка = Колонка + 1;
					КонецЕсли;
			
					СтруктураРасшифровки = Новый Структура;
					СтруктураРасшифровки.Вставить("Отчет", "Отчеты.Д_Расшифровка");
					СтруктураРасшифровки.Вставить("Счет", ПланСчетов1.ЗатратыНаПрво);
					СтруктураРасшифровки.Вставить("Предприятие", ЭлСт[3]);
					СтруктураРасшифровки.Вставить("Подразделение", ЭлСт[4]);
					СтруктураРасшифровки.Вставить("Субконто1", ЭлСт[5]);
					СтруктураРасшифровки.Вставить("Дата1", ?(ВсегоПериодов > 1, НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), Отчет.Период.ДатаНачала));
					СтруктураРасшифровки.Вставить("Дата2", ?(ВсегоПериодов > 1, КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)), Отчет.Период.ДатаОкончания));
					СтруктураРасшифровки.Вставить("ВидимостьШапки", 0);
					СтруктураРасшифровки.Вставить("Сценарий1", Отчет.Сценарий1);
			
					ОбластьДанныеСтолбцы.Параметры.Расшифровка = СтруктураРасшифровки;
					
					Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
						СтруктураРасшифровки2 = Новый Структура;
						СтруктураРасшифровки2.Вставить("Отчет", "Отчеты.Д_Расшифровка");
						СтруктураРасшифровки2.Вставить("Счет", ПланСчетов2.ЗатратыНаПрво);
						СтруктураРасшифровки2.Вставить("Предприятие", ЭлСт[3]);
						СтруктураРасшифровки2.Вставить("Подразделение", ЭлСт[4]);
						СтруктураРасшифровки2.Вставить("Субконто1", ЭлСт[5]);
						СтруктураРасшифровки2.Вставить("Дата1", ?(ВсегоПериодов > 1, НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), Отчет.Период.ДатаНачала));
						СтруктураРасшифровки2.Вставить("Дата2", ?(ВсегоПериодов > 1, КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)), Отчет.Период.ДатаОкончания));
						СтруктураРасшифровки2.Вставить("ВидимостьШапки", 0);
						СтруктураРасшифровки2.Вставить("Сценарий1", Отчет.Сценарий2);
						ОбластьДанныеСтолбцы.Параметры.Расшифровка2 = СтруктураРасшифровки2;
					КонецЕсли;
			
					ТабДок.Присоединить(ОбластьДанныеСтолбцы, ТекУровень);
					
				КонецЦикла;
				
				Если ИнтервалМеньше Тогда
					
					ОбластьДанныеСтолбцы.Параметры.Сумма1 = ИтогоСумма1;					
					Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
						ОбластьДанныеСтолбцы.Параметры.Сумма2 = ИтогоСумма2;
						ОбластьДанныеСтолбцы.Параметры.Сумма3 = ИтогоСумма2 - ИтогоСумма1;
					КонецЕсли;
			
					СтруктураРасшифровки = Новый Структура;
					СтруктураРасшифровки.Вставить("Отчет", "Отчеты.Д_Расшифровка");
					СтруктураРасшифровки.Вставить("Счет", ПланСчетов1.ЗатратыНаПрво);
					СтруктураРасшифровки.Вставить("Предприятие", ЭлСт[3]);
					СтруктураРасшифровки.Вставить("Подразделение", ЭлСт[4]);
					СтруктураРасшифровки.Вставить("Субконто1", ЭлСт[5]);
					СтруктураРасшифровки.Вставить("Дата1", Отчет.Период.ДатаНачала);
					СтруктураРасшифровки.Вставить("Дата2", Отчет.Период.ДатаОкончания);
					СтруктураРасшифровки.Вставить("ВидимостьШапки", 0);
					СтруктураРасшифровки.Вставить("Сценарий1", Отчет.Сценарий1);
			
					ОбластьДанныеСтолбцы.Параметры.Расшифровка = СтруктураРасшифровки;
					
					Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
						СтруктураРасшифровки2 = Новый Структура;
						СтруктураРасшифровки2.Вставить("Отчет", "Отчеты.Д_Расшифровка");
						СтруктураРасшифровки2.Вставить("Счет", ПланСчетов2.ЗатратыНаПрво);
						СтруктураРасшифровки2.Вставить("Предприятие", ЭлСт[3]);
						СтруктураРасшифровки2.Вставить("Подразделение", ЭлСт[4]);
						СтруктураРасшифровки2.Вставить("Субконто1", ЭлСт[5]);
						СтруктураРасшифровки2.Вставить("Дата1", Отчет.Период.ДатаНачала);
						СтруктураРасшифровки2.Вставить("Дата2", Отчет.Период.ДатаОкончания);
						СтруктураРасшифровки2.Вставить("ВидимостьШапки", 0);
						СтруктураРасшифровки2.Вставить("Сценарий1", Отчет.Сценарий2);
						ОбластьДанныеСтолбцы.Параметры.Расшифровка2 = СтруктураРасшифровки2;
					КонецЕсли;
			
					ТабДок.Присоединить(ОбластьДанныеСтолбцы, ТекУровень);
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
	
		// итого по каждому предприятию		                                                                                                            
		ТабДок.Вывести(ОбластьИтогоПредприятие, 1);
		Период = 0;
		
		ИтогоСуммаПредприятие1 = 0;
		ИтогоСуммаПредприятие2 = 0;
		
		Для Колонка = 1 По ВсегоПериодов * ?(ПустаяСтрока(Отчет.Сценарий2), 1, 2) Цикл
			
			Период = Период + Интервал;
			ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр1 = Эл[Колонка * 2 + 5];
			ИтогоСуммаПредприятие1 = ИтогоСуммаПредприятие1 + Эл[Колонка * 2 + 5];
			
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр2 = Эл[Колонка * 2 + 7];
				ИтогоСуммаПредприятие2 = ИтогоСуммаПредприятие2 + Эл[Колонка * 2 + 7];
				ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр3 = ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр2 - ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр1;
				Колонка = Колонка + 1;
			КонецЕсли;
			ТабДок.Присоединить(ОбластьИтогоПредприятиеСтолбцы);
			
		КонецЦикла;
		
		Если ИнтервалМеньше тогда
			ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр1 = ИтогоСуммаПредприятие1;			
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр2 = ИтогоСуммаПредприятие2;
				ОбластьИтогоПредприятиеСтолбцы.Параметры.СуммаПредпр3 = ИтогоСуммаПредприятие2 - ИтогоСуммаПредприятие1;
			КонецЕсли;
			ТабДок.Присоединить(ОбластьИтогоПредприятиеСтолбцы);
		КонецЕсли;	
			
	КонецЦикла;
	
		
	ТабДок.ЗакончитьАвтогруппировкуСтрок();	
	
	//таблицу на экран
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.Защита = Ложь;
	ТабДок.ТолькоПросмотр = Истина;
	ТабДок.ОтображатьЗаголовки = Ложь;
	//ТабДок.Показать();
	Элементы.ТабДок.Видимость = Истина;
		
КонецПроцедуры


&НаСервере
Процедура ЗаполнитьТаблицуПредприятия(ВидОтчета)
	
		
	//при выборе сценария факта в одном из полей Сценарий
	ПланСчетов1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, ПланыСчетов.Учетный, ПланыСчетов.Учетный);
	ПланСчетов2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, ПланыСчетов.Учетный, ПланыСчетов.Учетный);
	Регистр1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, "Учетный", "Бюджетный");
	Регистр2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, "Учетный", "Бюджетный");
	ПС_Сц1 = ?(Отчет.Сценарий1 = Справочники.СценарииПланирования.Факт, "ПланСчетов.Учетный", "ПланСчетов.Учетный");
	ПС_Сц2 = ?(Отчет.Сценарий2 = Справочники.СценарииПланирования.Факт, "ПланСчетов.Учетный", "ПланСчетов.Учетный"); 
	
	//определяем таблицу значений, в которую будем вносить все значения
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Шрифт"); //1) 1-обычный, 2 - жирный, 3 - курсив
	
	ТЗ.Колонки.Добавить("Порядок");//2) для структурирования дальнейшего вывода
	ТЗ.Колонки.Добавить("Признак");//3) для уникальности строки
	//порядок и признак выступают уникальным идентификтором строки
	
	ТЗ.Колонки.Добавить("Предприятие");//4) для обозначения разных предприятий
	
	ТЗ.Колонки.Добавить("Значение");//5)
	ТЗ.Колонки.Добавить("Резерв1");
	ТЗ.Колонки.Добавить("Резерв2");
	ТЗ.Колонки.Добавить("Резерв3");
	ТЗ.Колонки.Добавить("Резерв4");
	ТЗ.Колонки.Добавить("Резерв5");
	НаборИмен = ""; ИндексКолонки = 10;
	Для Кол = 1 По 100 Цикл // добавляем заранее все колонки в ТЗ с индекса 9
		ИмяКол = "Колонка" + строка(Кол);
		НаборИмен = НаборИмен + ИмяКол + ",";
		ТЗ.Колонки.Добавить(ИмяКол);
	КонецЦикла; 
	
	Попытка
	    ЭтотОбъект2 = ВнешниеОтчеты.Создать("Д_ФРПроектов");	
	Исключение
		ЭтотОбъект2 = Отчеты.Д_ФРПроектов;
	КонецПопытки;

	
	Если НЕ ПустаяСтрока(Отчет.Сценарий1) и  НЕ ПустаяСтрока(Отчет.Сценарий2) Тогда
		ИмяМакета = "МакетПланФакт" + ?(ТочностьДва, "Дробь", "");
		Макет = ЭтотОбъект2.ПолучитьМакет(ИмяМакета);
	иначе
		ИмяМакета = "Макет" + ?(ТочностьДва, "Дробь", "");
		Макет = ЭтотОбъект2.ПолучитьМакет(ИмяМакета);
	КонецЕсли; 
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка|СтолбецНачало");
	
	ОбластьШапкаПредпр = Макет.ПолучитьОбласть("ШапкаПредприятие|СтолбецНачало");
	ОбластьШапкаПредпрСтолбцы = Макет.ПолучитьОбласть("ШапкаПредприятие|ДанныеСтолбца");
			
	ОбластьИтогоПредприятие = Макет.ПолучитьОбласть("ИтогоПоПредприятию|СтолбецНачало");
	ОбластьИтогоПредприятиеСтолбцы = Макет.ПолучитьОбласть("ИтогоПоПредприятию|ДанныеСтолбца");
	
	ТабДок.Очистить();
	ВставлятьРазделительСтраниц = Ложь;
	
	
	Интервал = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, 1, 
	?(Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, 3, 12));
	
	КлючПериод = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, "Месяц", ?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, "Квартал", "Год"));
	
	НачалоПериода = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, Месяц(Отчет.Период.ДатаНачала),?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, ОпределитьКвартал(Месяц(Отчет.Период.ДатаНачала)), Год(Отчет.Период.ДатаНачала)));
	
	КонецПериода = ?(Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно, Месяц(Отчет.Период.ДатаОкончания),?(
	Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально, ОпределитьКвартал(Месяц(Отчет.Период.ДатаОкончания)), Год(Отчет.Период.ДатаОкончания)));
	
	
	//ВсегоПериодов = КонецПериода - НачалоПериода + 1;    разность
	// #большегода {
	Если Отчет.Помесячно = Перечисления.Д_Интервал.Помесячно Тогда
		мнИнтервала = 86400 * 30
	ИначеЕсли Отчет.Помесячно = Перечисления.Д_Интервал.Поквартально Тогда
		мнИнтервала = 86400 * 30 * 3
	Иначе
		мнИнтервала = 86400 * 30 * 3 * 4
	КонецЕсли;
	
	ВсегоПериодов = Окр((КонецДня(Отчет.Период.ДатаОкончания)+1 - НачалоДня( Отчет.Период.ДатаНачала)) / мнИнтервала, 0, РежимОкругления.Окр15как10);
	//}
	
	ПредприятияМассив = Новый Массив;	                                     
	
	Если Не РежимВыбораПредприятий = "Предприятие" Тогда
		
		Для каждого ТекТип Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
			
			Для Каждого Т Из ТекТип.ПолучитьЭлементы() Цикл
				
				Если Т.Пометка Тогда
			
					ПредприятияМассив.Добавить(Т.Значение);
							
				КонецЕсли;		
				
			КонецЦикла;
			
		КонецЦикла;
		
	Иначе
	
		Для каждого Т Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
		
			Если Т.Пометка Тогда
			
				ПредприятияМассив.Добавить(Т.Значение);
							
			КонецЕсли;		
			
		КонецЦикла; 
		
	КонецЕсли;
	
	//Предпр = Т.Значение;
	ДатаНач = Отчет.Период.ДатаНачала;
	ДатаКон = Отчет.Период.ДатаОкончания;
	СчетчикМесяцев = 0;
	СчетчикНоменклатур = 0;
	КоэффициентОтступа = 0;

	
	Если Отчет.ВидОтчета = 1 ИЛИ Отчет.ВидОтчета = 0 Тогда
		//90.3
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0) КАК Сумма1,
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0) КАК Сумма2,
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ КАК Период,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ КАК ПериодДата,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1 Иначе  ДанныеСценарий2.Субконто2 конец
		|		ИНАЧЕ выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1 Иначе  ДанныеСценарий1.Субконто2 конец
		|	КОНЕЦ КАК Статья,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1.Родитель Иначе  ДанныеСценарий2.Субконто2.Родитель конец
		|		ИНАЧЕ выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1.Родитель Иначе ДанныеСценарий1.Субконто2.Родитель конец
		|	КОНЕЦ КАК Родитель1,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ КАК Предприятие
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет В (&Счет),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет В (&Счет2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И (" + КлючПериод + "(ДанныеСценарий1.Период) = " + КлючПериод + "(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0),
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(ДанныеСценарий2.Период)
		|		ИНАЧЕ " + КлючПериод + "(ДанныеСценарий1.Период)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ
		|ИЗ
		|	РегистрБухгалтерии."+ Регистр1 +".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			"+ КлючПериод +",
		|			Счет В (&СчетаДоход),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии."+ Регистр2 +".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				"+ КлючПериод +",
		|				Счет В (&СчетаДоход2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И ("+ КлючПериод +"(ДанныеСценарий1.Период) = "+ КлючПериод +"(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0),
		|	ВЫБОР
		|		КОГДА "+ КлючПериод +"(ДанныеСценарий1.Период) ЕСТЬ NULL 
		|			ТОГДА "+ КлючПериод +"(ДанныеСценарий2.Период)
		|		ИНАЧЕ "+ КлючПериод +"(ДанныеСценарий1.Период)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Период ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Период
		|		ИНАЧЕ ДанныеСценарий1.Период
		|	КОНЕЦ,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ВЫБОР
		|		КОГДА ДанныеСценарий1.Предприятия ЕСТЬ NULL 
		|			ТОГДА ДанныеСценарий2.Предприятия
		|		ИНАЧЕ ДанныеСценарий1.Предприятия
		|	КОНЕЦ
		|ИЗ
		|	РегистрБухгалтерии."+ Регистр1 +".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			"+ КлючПериод +",
		|			Счет В (&Счет91Сц1),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1
		|				И " + ?(Регистр1 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|			,
		|			) КАК ДанныеСценарий1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии."+ Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				"+ КлючПериод +",
		|				Счет В (&Счет91Сц2),
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2
		|					И " + ?(Регистр2 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|				,
		|				) КАК ДанныеСценарий2
		|		ПО ДанныеСценарий1.Субконто2 = ДанныеСценарий2.Субконто2
		|			И ("+ КлючПериод +"(ДанныеСценарий1.Период) = "+ КлючПериод +"(ДанныеСценарий2.Период))
		|			И ДанныеСценарий1.Субконто1 = ДанныеСценарий2.Субконто1
		|			И ДанныеСценарий1.Предприятия = ДанныеСценарий2.Предприятия
		|;
		|
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СтатьиЗатрат.Ссылка КАК Статья,
		|	СтатьиЗатрат.ЭтоГруппа,
		|	ЕСТЬNULL(Данные.Сумма1, 0) КАК Сумма1,
		|	ЕСТЬNULL(Данные.Сумма2, 0) КАК Сумма2,
		|	ЕСТЬNULL(Данные.Период, 0) КАК Период,
		|   Данные.ПериодДата,
		|	Данные.Предприятие
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		|		ПОЛНОЕ СОЕДИНЕНИЕ Данные КАК Данные
		|		ПО (СтатьиЗатрат.Ссылка = Данные.Статья
		|				ИЛИ СтатьиЗатрат.Ссылка = Данные.Родитель1)
		|
		|УПОРЯДОЧИТЬ ПО
		|	СтатьиЗатрат.Код";
	ИначеЕсли Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 тогда
		
		//90.3
		Запрос = Новый Запрос;							   
		Запрос.Текст = "ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0) КАК Сумма1,
		|	"+ КлючПериод +"(ДанныеСценарий1.Период) КАК Период,
		|	ДанныеСценарий1.Период КАК ПериодДата,
		|	выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1 Иначе ДанныеСценарий1.Субконто2 конец КАК Статья,
		|	выбор когда ДанныеСценарий1.Счет = &Счет90_2_Сц1 Тогда ДанныеСценарий1.КорСубконто1.Родитель Иначе ДанныеСценарий1.Субконто2.Родитель конец КАК Родитель1,
		|	ДанныеСценарий1.Предприятия КАК Предприятие,
		|	БюджетныйДвиженияССубконто1.Содержание КАК Содержание,
		|	0 КАК Сумма2
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			Запись,
		|			Счет В (&Счет),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
		|				&Дата1,
		|				&Дата2,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий1,
		|				,
		|				) КАК БюджетныйДвиженияССубконто1
		|		ПО ДанныеСценарий1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		|			И ДанныеСценарий1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	0,
		|	"+ КлючПериод +"(ДанныеСценарий2.Период),
		|	ДанныеСценарий2.Период,
 		|	выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1 Иначе ДанныеСценарий2.Субконто2 конец КАК Статья,
		|	выбор когда ДанныеСценарий2.Счет = &Счет90_2_Сц2 Тогда ДанныеСценарий2.КорСубконто1.Родитель Иначе ДанныеСценарий2.Субконто2.Родитель конец КАК Родитель1,
		|	ДанныеСценарий2.Предприятия,
		|	БюджетныйДвиженияССубконто2.Содержание,
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0)
		|ИЗ
		|	РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			Запись,
		|			Счет В (&Счет2),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий2,
		|			,
		|			) КАК ДанныеСценарий2
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
		|				&Дата1,
		|				&Дата2,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК БюджетныйДвиженияССубконто2
		|		ПО ДанныеСценарий2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		|			И ДанныеСценарий2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	"+ КлючПериод +"(ДанныеСценарий1.Период),
		|	ДанныеСценарий1.Период,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ДанныеСценарий1.Предприятия,
		|	БюджетныйДвиженияССубконто1.Содержание,
		|	0
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			Запись,
		|			Счет В (&СчетаДоход),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1,
		|			,
		|			) КАК ДанныеСценарий1
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
		|				&Дата1,
		|				&Дата2,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий1,
		|				,
		|				) КАК БюджетныйДвиженияССубконто1
		|		ПО ДанныеСценарий1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		|			И ДанныеСценарий1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	0,
		|	"+ КлючПериод +"(ДанныеСценарий2.Период),
		|	ДанныеСценарий2.Период,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ДанныеСценарий2.Предприятия,
		|	БюджетныйДвиженияССубконто2.Содержание,
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0)
		|ИЗ
		|	РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			Запись,
		|			Счет В (&СчетаДоход2),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий2,
		|			,
		|			) КАК ДанныеСценарий2
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
		|				&Дата1,
		|				&Дата2,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК БюджетныйДвиженияССубконто2
		|		ПО ДанныеСценарий2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		|			И ДанныеСценарий2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		|
		|   ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	-ЕСТЬNULL(ДанныеСценарий1.СуммаОборот, 0),
		|	"+ КлючПериод +"(ДанныеСценарий1.Период),
		|	ДанныеСценарий1.Период,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ДанныеСценарий1.Предприятия,
		|	БюджетныйДвиженияССубконто1.Содержание,
		|	0
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			Запись,
		|			Счет В (&Счет91Сц1),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1
		|				И " + ?(Регистр1 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|			,
		|			) КАК ДанныеСценарий1
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
		|				&Дата1,
		|				&Дата2,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий1,
		|				,
		|				) КАК БюджетныйДвиженияССубконто1
		|		ПО ДанныеСценарий1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		|			И ДанныеСценарий1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	0,
		|	"+ КлючПериод +"(ДанныеСценарий2.Период),
		|	ДанныеСценарий2.Период,
		|	""Выручка от реализации"",
		|	""Доходы"",
		|	ДанныеСценарий2.Предприятия,
		|	БюджетныйДвиженияССубконто2.Содержание,
		|	-ЕСТЬNULL(ДанныеСценарий2.СуммаОборот, 0)
		|ИЗ
		|	РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			Запись,
		|			Счет В (&Счет91Сц2),
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий2
		|				И " + ?(Регистр2 = "Бюджетный", "Субконто3.Доход = ИСТИНА,", "Ложь,") + "
		|			,
		|			) КАК ДанныеСценарий2
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
		|				&Дата1,
		|				&Дата2,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2,
		|				,
		|				) КАК БюджетныйДвиженияССубконто2
		|		ПО ДанныеСценарий2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		|			И ДанныеСценарий2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СтатьиЗатрат.Ссылка КАК Статья,
		|	СтатьиЗатрат.ЭтоГруппа,
		|	ЕСТЬNULL(Данные.Период, 0) КАК Период,
		|	Данные.ПериодДата,
		|	Данные.Предприятие,
		|	Данные.Содержание,
		|	Данные.Сумма1,
		|	Данные.Сумма2
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		|		ПОЛНОЕ СОЕДИНЕНИЕ Данные КАК Данные
		|		ПО (СтатьиЗатрат.Ссылка = Данные.Статья
		|				ИЛИ СтатьиЗатрат.Ссылка = Данные.Родитель1)
		|
		|УПОРЯДОЧИТЬ ПО
		|	СтатьиЗатрат.Код";
		
	ИначеЕсли Отчет.ВидОтчета = 3 Тогда
						
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Предприятия", ПредприятияМассив);
	Запрос.УстановитьПараметр("Сценарий1", Отчет.Сценарий1);
	Запрос.УстановитьПараметр("Сценарий2", Отчет.Сценарий2);
	Запрос.УстановитьПараметр("Дата1", ДатаНач);
	Запрос.УстановитьПараметр("Дата2", ДатаКон);
	МассивСчетов90_Сц1 = Новый Массив;
	МассивСчетов90_Сц1.Добавить(ПланСчетов1.Себестоимость);
	МассивСчетов90_Сц1.Добавить(ПланСчетов1.РасходыПоРеал);
	Запрос.УстановитьПараметр("Счет", МассивСчетов90_Сц1);
	Запрос.УстановитьПараметр("Счет90_2_Сц1", ПланСчетов1.Себестоимость);
	МассивСчетов90_Сц2 = Новый Массив;
	МассивСчетов90_Сц2.Добавить(ПланСчетов2.Себестоимость);
	МассивСчетов90_Сц2.Добавить(ПланСчетов2.РасходыПоРеал);
	Запрос.УстановитьПараметр("Счет2", МассивСчетов90_Сц2);
	Запрос.УстановитьПараметр("Счет90_2_Сц2", ПланСчетов2.Себестоимость);
	СчетаДоход = Новый Массив;
	СчетаДоход.Добавить(ПланСчетов1.ВыручкаОтРеал);
	СчетаДоход.Добавить(ПланСчетов1.РеалОС);
	СчетаДоход2 = Новый Массив;
	СчетаДоход2.Добавить(ПланСчетов2.ВыручкаОтРеал);
	СчетаДоход2.Добавить(ПланСчетов2.РеалОС);
	Запрос.УстановитьПараметр("СчетаДоход", СчетаДоход);
	Запрос.УстановитьПараметр("СчетаДоход2", СчетаДоход2);
	Запрос.УстановитьПараметр("Счет91Сц1", ПланСчетов1.ДоходыИРасходы);
	Запрос.УстановитьПараметр("Счет91Сц2", ПланСчетов2.ДоходыИРасходы);
	
	РезультатЗатраты = Запрос.Выполнить();
	
	//91 счет
	Запрос = Новый Запрос;
	Если Отчет.ВидОтчета = 1 ИЛИ Отчет.ВидОтчета = 0 Тогда
		
		Запрос.Текст = "ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА " + КлючПериод + "(Прочие1.Период) ЕСТЬ NULL 
		|			ТОГДА " + КлючПериод + "(Прочие2.Период)
		|		ИНАЧЕ " + КлючПериод + "(Прочие1.Период)
		|	КОНЕЦ КАК Период,
		|	ВЫБОР
		|		КОГДА Прочие1.Период ЕСТЬ NULL 
		|			ТОГДА Прочие2.Период
		|		ИНАЧЕ Прочие1.Период
		|	КОНЕЦ КАК ПериодДата,
		|	ВЫБОР
		|		КОГДА Прочие1.Субконто1 ЕСТЬ NULL 
		|			ТОГДА Прочие2.Субконто1
		|		ИНАЧЕ Прочие1.Субконто1
		|	КОНЕЦ КАК Статья,
		|	-ЕСТЬNULL(Прочие1.СуммаОборот, 0) КАК Сумма1,
		|	-ЕСТЬNULL(Прочие2.СуммаОборот, 0) КАК Сумма2,
		|	ВЫБОР
		|		КОГДА Прочие1.Предприятия ЕСТЬ NULL 
		|			ТОГДА Прочие2.Предприятия
		|		ИНАЧЕ Прочие1.Предприятия
		|	КОНЕЦ КАК Предприятие,
		|	ВЫБОР
		|		КОГДА Прочие1.Субконто2 ЕСТЬ NULL 
		|			ТОГДА Прочие2.Субконто2
		|		ИНАЧЕ Прочие1.Субконто2
		|	КОНЕЦ КАК Деятельность,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСубконто1 ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСубконто1
		|		ИНАЧЕ Прочие1.КорСубконто1
		|	КОНЕЦ КАК Статья25,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСубконто1 ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСубконто1.Код
		|		ИНАЧЕ Прочие1.КорСубконто1.Код
		|	КОНЕЦ КАК Статья25Код,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСубконто1.Родитель ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСубконто1.Родитель
		|		ИНАЧЕ Прочие1.КорСубконто1.Родитель
		|	КОНЕЦ КАК КорРодитель,
		|	ВЫБОР
		|		КОГДА Прочие1.КорСчет ЕСТЬ NULL 
		|			ТОГДА Прочие2.КорСчет
		|		ИНАЧЕ Прочие1.КорСчет
		|	КОНЕЦ КАК КорСчет
		|ИЗ
		|	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		|			&Дата1,
		|			&Дата2,
		|			" + КлючПериод + ",
		|			Счет = &СчетДт2,
		|			,
		|			Предприятия В ИЕРАРХИИ (&Предприятия)
		|				И СценарийПлана = &Сценарий1 
        |			,
		|			) КАК Прочие1
		|		ПОЛНОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".Обороты(
		|				&Дата1,
		|				&Дата2,
		|				" + КлючПериод + ",
		|				Счет = &СчетДт3,
		|				,
		|				Предприятия В ИЕРАРХИИ (&Предприятия)
		|					И СценарийПлана = &Сценарий2
		|			,
		|				) КАК Прочие2
		|		ПО (" + КлючПериод + "(Прочие1.Период) = " + КлючПериод + "(Прочие2.Период))
		|			И Прочие1.Субконто1 = Прочие2.Субконто1
		|			И Прочие1.Предприятия = Прочие2.Предприятия
		|			И Прочие1.Субконто2 = Прочие2.Субконто2
		|			И Прочие1.КорСчет = Прочие2.КорСчет
		|			И Прочие1.КорСубконто1 = Прочие2.КорСубконто1
		|
		|УПОРЯДОЧИТЬ ПО
		|	Статья,Статья25Код";
		
	ИначеЕсли Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 тогда
		
		Запрос.Текст = "ВЫБРАТЬ
		               |	" + КлючПериод + "(Прочие1.Период) КАК Период,
					   |	Прочие1.Период КАК ПериодДата,
		               |	Прочие1.Субконто1 КАК Статья,
		               |	-ЕСТЬNULL(Прочие1.СуммаОборот, 0) КАК Сумма1,
		               |	0 КАК Сумма2,
					   |	Прочие1.КорСчет КАК КорСчет,
					   |	Прочие1.КорСубконто1 КАК Статья25,
                       |	Прочие1.КорСубконто1.Код КАК Статья25Код,
					   |	Прочие1.КорСубконто1.Родитель КАК КорРодитель,
		               |	Прочие1.Предприятия КАК Предприятие,
		               |	Прочие1.Субконто2 КАК Деятельность,
		               |	БюджетныйДвиженияССубконто1.Содержание КАК Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр1 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет = &СчетДт2,
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И СценарийПлана = &Сценарий1
		               |			,
		               |			) КАК Прочие1
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр1 + ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И СценарийПлана = &Сценарий1,
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто1
		               |		ПО Прочие1.Регистратор = БюджетныйДвиженияССубконто1.Регистратор
		               |			И Прочие1.НомерСтроки = БюджетныйДвиженияССубконто1.НомерСтроки
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	" + КлючПериод + "(Прочие2.Период),
					   |	Прочие2.Период,
		               |	Прочие2.Субконто1,
		               |	0,
		               |	-ЕСТЬNULL(Прочие2.СуммаОборот, 0),
					   |	Прочие2.КорСчет КАК КорСчет,
					   |	Прочие2.КорСубконто1 КАК Статья25,
                       |	Прочие2.КорСубконто1.Код КАК Статья25Код,
					   |	Прочие2.КорСубконто1.Родитель КАК КорРодитель,
		               |	Прочие2.Предприятия,
		               |	Прочие2.Субконто2,
		               |	БюджетныйДвиженияССубконто2.Содержание
		               |ИЗ
		               |	РегистрБухгалтерии." + Регистр2 + ".Обороты(
		               |			&Дата1,
		               |			&Дата2,
		               |			Запись,
		               |			Счет = &СчетДт3,
		               |			,
		               |			Предприятия В ИЕРАРХИИ (&Предприятия)
		               |				И СценарийПлана = &Сценарий2
		               |			,
		               |			) КАК Прочие2
		               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии." + Регистр2 + ".ДвиженияССубконто(
		               |				&Дата1,
		               |				&Дата2,
		               |				Предприятия В ИЕРАРХИИ (&Предприятия)
		               |					И СценарийПлана = &Сценарий2,
		               |				,
		               |				) КАК БюджетныйДвиженияССубконто2
		               |		ПО Прочие2.Регистратор = БюджетныйДвиженияССубконто2.Регистратор
		               |			И Прочие2.НомерСтроки = БюджетныйДвиженияССубконто2.НомерСтроки
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	Статья, Статья25Код";
	ИначеЕсли Отчет.ВидОтчета = 3 Тогда
		
	КонецЕсли;
		
	Запрос.УстановитьПараметр("Предприятия", ПредприятияМассив);
	Запрос.УстановитьПараметр("Сценарий1", Отчет.Сценарий1);
	Запрос.УстановитьПараметр("Сценарий2", Отчет.Сценарий2);
	Запрос.УстановитьПараметр("Дата1", ДатаНач);
	Запрос.УстановитьПараметр("Дата2", ДатаКон);
	Запрос.УстановитьПараметр("СчетДт2", ПланСчетов1.ДоходыИРасходы);
	Запрос.УстановитьПараметр("СчетДт3", ПланСчетов2.ДоходыИРасходы);

	РезультатПрочиеЗатраты = Запрос.Выполнить();
	
	
		
	
	Для каждого Предприятие  Из ПредприятияМассив Цикл
		
		//очищаем массив и присваиваем числовой тип
		ТекущиеЗатраты1 = Новый Массив(50);
		ТекущиеЗатраты2 = Новый Массив(50);
		ТекущиеДоходы1 = Новый Массив(50);
		ТекущиеДоходы2 = Новый Массив(50);
		ПрочиеЗатраты1 = Новый Массив(50);
		ПрочиеЗатраты2 = Новый Массив(50);
		Для т = 0 По 49 Цикл
			ТекущиеЗатраты1[т] = 0;
			ТекущиеЗатраты2[т] = 0;
			ТекущиеДоходы1[т] = 0;
			ТекущиеДоходы2[т] = 0;			
			ПрочиеЗатраты1[т] = 0;
			ПрочиеЗатраты2[т] = 0;
		КонецЦикла;
		
		//опрос 90.3
		СтруктураПоиска = Новый Структура("Предприятие", Предприятие);
		Выборка = РезультатЗатраты.Выбрать();
		
		Пока Выборка.НайтиСледующий(СтруктураПоиска) цикл
			
			НоваяСтрока = ТЗ.Добавить();
			НоваяСтрока[0] = 1;
			НоваяСтрока[1] = 0;
			НоваяСтрока[2] = Строка("Ном") + строка("Объем производства");
			НоваяСтрока[3] = Выборка.Предприятие;
			НоваяСтрока[4] = "Объем производства " + Строка("Ном");
			
			СчетчикМесяцев = Окр((Выборка.ПериодДата - ДатаНач) / мнИнтервала, 0, РежимОкругления.Окр15Как10) + 1; // #большегода
			КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
			
					
			НоваяСтрокаД = ТЗ.Добавить();
			НоваяСтрокаД[0] = 0;
			НоваяСтрокаД[1] = 0;
			НоваяСтрокаД[2] = Строка("Ном") + "Доходы";
			НоваяСтрокаД[3] = Выборка.Предприятие;
			НоваяСтрокаД[4] = "Доходы";
						
			Если Не ЗначениеЗаполнено(Выборка.Статья) Тогда	
				НоваяСтрокаД[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = Выборка.Сумма1;
				НоваяСтрокаД[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = Выборка.Сумма2;
				ТекущиеДоходы1[СчетчикМесяцев] = ТекущиеДоходы1[СчетчикМесяцев] + Выборка.Сумма1; 
				ТекущиеДоходы2[СчетчикМесяцев] = ТекущиеДоходы2[СчетчикМесяцев] + Выборка.Сумма2;
				Если Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 Тогда
					НоваяСтрока = ТЗ.Добавить();
					НоваяСтрока[0] = 4;
					НоваяСтрока[1] = 0;
					НоваяСтрока[2] = Строка("НомДоход");
					НоваяСтрока[3] = Выборка.Предприятие;
					НоваяСтрока[4] = Выборка.Содержание;
					НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = Выборка.Сумма1;
					НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = Выборка.Сумма2;
				КонецЕсли;
				Продолжить;
			КонецЕсли;	
			
			НоваяСтрокаР = ТЗ.Добавить();
			НоваяСтрокаР[0] = 0;
			НоваяСтрокаР[1] = 0;
			НоваяСтрокаР[2] = Строка("Ном") + "Расходы";
			НоваяСтрокаР[3] = Выборка.Предприятие;
			НоваяСтрокаР[4] = "Расходы";
			НоваяСтрокаР[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = 0;
			НоваяСтрокаР[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = 0;
			
			НоваяСтрока = ТЗ.Добавить();
			НоваяСтрока[0] = 1 - Выборка.ЭтоГруппа;
			
			Если НЕ Выборка.ЭтоГруппа Тогда
				ТекущиеЗатраты1[СчетчикМесяцев] = ТекущиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1; 
				ТекущиеЗатраты2[СчетчикМесяцев] = ТекущиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;									
			КонецЕсли;
			
			
			НоваяСтрока[1] = 0;
			НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
			НоваяСтрока[3] = Выборка.Предприятие;
			НоваяСтрока[4] = Выборка.Статья;
			НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = - Выборка.Сумма1;
			НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = - Выборка.Сумма2;
			
			Если НЕ Выборка.ЭтоГруппа И (Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4) Тогда
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 4;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = Выборка.Содержание;
				НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = - Выборка.Сумма1;
				НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = - Выборка.Сумма2;
			КонецЕсли;
		КонецЦикла;
		
		//итого по тек.деятельности
		
		Для СчетчикМесяцев = 1 По ВсегоПериодов Цикл
			Если ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты2[СчетчикМесяцев] Тогда
				КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
				СтрокаРасходов = ТЗ.НайтиСтроки(Новый Структура("Значение, Предприятие", "Расходы", Выборка.Предприятие));
				СтрокаРасходов[0][СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = -ТекущиеЗатраты1[СчетчикМесяцев];
				СтрокаРасходов[0][СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = -ТекущиеЗатраты2[СчетчикМесяцев]; 
									
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0; 
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка("Прибыль по основной деятельности");
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = "Прибыль по основной деятельности";
				НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = ТекущиеДоходы1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев];
				НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = ТекущиеДоходы2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев];
			КонецЕсли;
		КонецЦикла;
		
		//опрос 91
		СтруктураПоиска = Новый Структура("Предприятие", Предприятие);
		Выборка = РезультатПрочиеЗатраты.Выбрать();
		Пока Выборка.НайтиСледующий(СтруктураПоиска) цикл
			
			Если Не ТЗ.НайтиСтроки(Новый Структура("Значение, Предприятие", "Объем производства Ном", Выборка.Предприятие)).Количество() Тогда
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 1;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка("Объем производства");
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = "Объем производства " + Строка("Ном");
			КонецЕсли;	
				
			СчетчикМесяцев = Окр((Выборка.ПериодДата - ДатаНач) / мнИнтервала, 0, РежимОкругления.Окр15Как10) + 1; // #большегода
			КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
			
			НоваяСтрока = ТЗ.Добавить();
			НоваяСтрока[0] = 1;	
			НоваяСтрока[1] = 0;
			НоваяСтрока[2] = Строка(Выборка.Предприятие) + Строка(Выборка.Статья);
			НоваяСтрока[3] = Выборка.Предприятие;
			НоваяСтрока[4] = Выборка.Статья;
			НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = - Выборка.Сумма1;
			НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = - Выборка.Сумма2;
			ПрочиеЗатраты1[СчетчикМесяцев] = ПрочиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1;
			ПрочиеЗатраты2[СчетчикМесяцев] = ПрочиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;
			
			Если Отчет.ВидОтчета = 2 ИЛИ Отчет.ВидОтчета = 4 Тогда
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 4;
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка("Ном") + строка(Выборка.Статья);
				НоваяСтрока[3] = Выборка.Предприятие;
				НоваяСтрока[4] = Выборка.Содержание;
				НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = - Выборка.Сумма1;
				НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = - Выборка.Сумма2;
			КонецЕсли;
			
			Если Выборка.Статья = Справочники.СтатьиДоходовРасходов.Простой ИЛИ Выборка.Статья = Справочники.СтатьиДоходовРасходов.ПереносОстатков Тогда
				//КорСтатьи
				НоваяСтрокаГ = ТЗ.Добавить();
				НоваяСтрокаГ[0] = 2;	
				НоваяСтрокаГ[1] = 0;
				НоваяСтрокаГ[3] = Выборка.Предприятие;
				Если Выборка.КорСчет = ПланыСчетов.Учетный.Счет25() ИЛИ Выборка.КорСчет = ПланыСчетов.Учетный.Счет25() Тогда
					НоваяСтрокаГ[2] = Строка(Выборка.Предприятие) + Строка(Выборка.КорРодитель);
					НоваяСтрокаГ[4] = Выборка.КорРодитель;
					НоваяСтрока = ТЗ.Добавить();
					НоваяСтрока[0] = 4;	
					НоваяСтрока[1] = 0;
					НоваяСтрока[2] = Строка(Выборка.Предприятие) + Строка(Выборка.Статья25);
					НоваяСтрока[3] = Выборка.Предприятие;
					НоваяСтрока[4] = Выборка.Статья25;
					НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = - Выборка.Сумма1;
					НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = - Выборка.Сумма2;
					//ПрочиеЗатраты1[СчетчикМесяцев] = ПрочиеЗатраты1[СчетчикМесяцев] + Выборка.Сумма1;
					//ПрочиеЗатраты2[СчетчикМесяцев] = ПрочиеЗатраты2[СчетчикМесяцев] + Выборка.Сумма2;       // 24.05.13
				Иначе
					НоваяСтрокаГ[2] = Строка(Выборка.Предприятие) + "ПРОЧИЕ";
					НоваяСтрокаГ[4] = "ПРОЧИЕ";
				КонецЕсли;
				НоваяСтрокаГ[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = - Выборка.Сумма1;
				НоваяСтрокаГ[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = - Выборка.Сумма2;				
			КонецЕсли;
		КонецЦикла;
		
		Для СчетчикМесяцев = 1 По ВсегоПериодов Цикл
			КоэффициентОтступа = ?(ПустаяСтрока(Отчет.Сценарий2), 0, СчетчикМесяцев * 2 - 2);
			Если ПрочиеЗатраты1[СчетчикМесяцев] ИЛИ ПрочиеЗатраты2[СчетчикМесяцев] ИЛИ ТекущиеЗатраты1[СчетчикМесяцев] ИЛИ ТекущиеЗатраты2[СчетчикМесяцев] ИЛИ ТекущиеДоходы1[СчетчикМесяцев] ИЛИ ТекущиеДоходы2[СчетчикМесяцев] Тогда
				НоваяСтрока = ТЗ.Добавить();
				НоваяСтрока[0] = 0; // 29.10.12	
				НоваяСтрока[1] = 0;
				НоваяСтрока[2] = Строка(Предприятие) + "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
				НоваяСтрока[3] = Предприятие;
				НоваяСтрока[4] = "ИТОГО ФИНАНСОВЫЙ РЕЗУЛЬТАТ";
				НоваяСтрока[СчетчикМесяцев * 2 + 9 + КоэффициентОтступа] = ТекущиеДоходы1[СчетчикМесяцев] + ПрочиеЗатраты1[СчетчикМесяцев] + ТекущиеЗатраты1[СчетчикМесяцев];
				НоваяСтрока[СчетчикМесяцев * 2+ 11 + КоэффициентОтступа] = ТекущиеДоходы2[СчетчикМесяцев] + ПрочиеЗатраты2[СчетчикМесяцев] + ТекущиеЗатраты2[СчетчикМесяцев]
			КонецЕсли;
		КонецЦикла;
		
		
	КонецЦикла;
	
	
	
	//сворачиваем таблицу значений и выводим на печать		
	ТЗ.Свернуть("Шрифт, Порядок, Признак, Предприятие, Значение", НаборИмен);
	
	// квартал помесячно год поквартально 
	ТекПериод = Отчет.Период;
	ТекИнтервал = Отчет.Помесячно;
	ИнтервалМеньше = БюджетныйНаСервере.ИнтервалМеньшеПериода(ТекПериод, ТекИнтервал);
	
	ТабДок.НачатьАвтогруппировкуСтрок();
	Для Строчка = 0 По ТЗ.Количество()-1 Цикл
		
		Если Лев(ТЗ[Строчка][4], 18) = "Объем производства" Тогда // выводим шапку
			
			ОбластьШапка.Параметры.Месяц = ПредставлениеПериода(Отчет.Период.ДатаНачала, Отчет.Период.ДатаОкончания);
			ТабДок.Вывести(ОбластьШапка);
			ОбластьШапкаПредпр.Параметры.Предприятие = ТЗ[Строчка][3];
			ТабДок.Вывести(ОбластьШапкаПредпр, 0);
			Период = 0;
			Для Колонка = 1 По ВсегоПериодов * ?(ПустаяСтрока(Отчет.Сценарий2), 1, 2) Цикл
				Период = Период + Интервал;
				ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий1 = Отчет.Сценарий1;
				Если ВсегоПериодов > 1 Тогда
					ОбластьШапкаПредпрСтолбцы.Параметры.Месяц = ПредставлениеПериода(НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)));	
				иначе
					ОбластьШапкаПредпрСтолбцы.Параметры.Месяц = ПредставлениеПериода(Отчет.Период.ДатаНачала, Отчет.Период.ДатаОкончания);	
				КонецЕсли; 
				
				//ОбластьШапкаСтолбцы.Параметры.Объем1 = ТЗ[Строчка][Колонка * 2 + 4];
				Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
					ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий2 = Отчет.Сценарий2;
					//ОбластьШапкаСтолбцы.Параметры.Объем2 = ТЗ[Строчка][Колонка * 2 + 6];
					//ОбластьШапкаСтолбцы.Параметры.Объем3 = ОбластьШапкаСтолбцы.Параметры.Объем2 - ОбластьШапкаСтолбцы.Параметры.Объем1;
					Колонка = Колонка + 1;
				КонецЕсли;
				ТабДок.Присоединить(ОбластьШапкаПредпрСтолбцы, 0);
			КонецЦикла;
			
			Если ИнтервалМеньше Тогда				
				ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий1 = Отчет.Сценарий1;
				ОбластьШапкаПредпрСтолбцы.Параметры.Месяц = "Итого";	
				Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
					ОбластьШапкаПредпрСтолбцы.Параметры.Сценарий2 = Отчет.Сценарий2;
				КонецЕсли;
				ТабДок.Присоединить(ОбластьШапкаПредпрСтолбцы, 0);	
			КонецЕсли;
			
			Продолжить;
			
		КонецЕсли;
		
		ИтогоСумма1 = 0;
		ИтогоСумма2 = 0;
		
		//получаем шрифт
		ОбластьДанные = Макет.ПолучитьОбласть("Строка" + строка(ТЗ[Строчка][0]) + "|СтолбецНачало");
		ОбластьДанныеСтолбцы = Макет.ПолучитьОбласть("Строка" + строка(ТЗ[Строчка][0]) + "|ДанныеСтолбца");			
		
		//получаем данные
		ОбластьДанные.Параметры.Статья = ТЗ[Строчка][4];
		
		Если (Лев(ТЗ[Строчка][4], 6) = "Доходы" И СтрДлина(ТЗ[Строчка][4]) = 6) ИЛИ (Лев(ТЗ[Строчка][4], 7) = "Расходы" И СтрДлина(ТЗ[Строчка][4]) = 7) Тогда
			ТекУровень = 1
		ИначеЕсли ТипЗнч(ТЗ[Строчка][4]) = Тип("СправочникСсылка.СтатьиЗатрат") ИЛИ ТипЗнч(ТЗ[Строчка][4]) = Тип("СправочникСсылка.СтатьиДоходовРасходов") Тогда
			ТекУровень = ?(ТЗ[Строчка][4].ЭтоГруппа ИЛИ ЗначениеЗаполнено(ТЗ[Строчка][4].Родитель) = Ложь, 2, 3);
		Иначе
			ТекУровень = ?(ТЗ[Строчка][0] = 4, 4, 0);
		КонецЕсли;
			
		ТабДок.Вывести(ОбластьДанные, ТекУровень);
		Период = 0;
		Для Колонка = 1 По ВсегоПериодов * ?(ПустаяСтрока(Отчет.Сценарий2), 1, 2) Цикл
			Период = Период + Интервал;
			ОбластьДанныеСтолбцы.Параметры.Сумма1 = ТЗ[Строчка][Колонка * 2 + 4];
			ИтогоСумма1 = ИтогоСумма1 + ТЗ[Строчка][Колонка * 2 + 4]; 
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьДанныеСтолбцы.Параметры.Сумма2 = ТЗ[Строчка][Колонка * 2 + 6];
				ИтогоСумма2 = ИтогоСумма2 + ТЗ[Строчка][Колонка * 2 + 6];
				ОбластьДанныеСтолбцы.Параметры.Сумма3 = ОбластьДанныеСтолбцы.Параметры.Сумма2 - ОбластьДанныеСтолбцы.Параметры.Сумма1;
				Колонка = Колонка + 1;
			КонецЕсли;
			
			СтруктураРасшифровки = Новый Структура;
			СтруктураРасшифровки.Вставить("Отчет", "Отчеты.Д_Расшифровка");
			СтруктураРасшифровки.Вставить("Счет", ПланСчетов1.ЗатратыНаПрво);
			СтруктураРасшифровки.Вставить("Предприятие", ТЗ[Строчка][3]);
			СтруктураРасшифровки.Вставить("Субконто1", ТЗ[Строчка][4]);
			СтруктураРасшифровки.Вставить("Дата1", ?(ВсегоПериодов > 1, НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), Отчет.Период.ДатаНачала));
			СтруктураРасшифровки.Вставить("Дата2", ?(ВсегоПериодов > 1, КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)), Отчет.Период.ДатаОкончания));
			СтруктураРасшифровки.Вставить("ВидимостьШапки", 0);
			СтруктураРасшифровки.Вставить("Сценарий1", Отчет.Сценарий1);
			
			ОбластьДанныеСтолбцы.Параметры.Расшифровка = СтруктураРасшифровки;
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				СтруктураРасшифровки2 = Новый Структура;
				СтруктураРасшифровки2.Вставить("Отчет", "Отчеты.Д_Расшифровка");
				СтруктураРасшифровки2.Вставить("Счет", ПланСчетов2.ЗатратыНаПрво);
				СтруктураРасшифровки2.Вставить("Предприятие", ТЗ[Строчка][3]);
				СтруктураРасшифровки2.Вставить("Субконто1", ТЗ[Строчка][4]);
				СтруктураРасшифровки2.Вставить("Дата1", ?(ВсегоПериодов > 1, НачалоМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - Интервал)), Отчет.Период.ДатаНачала));
				СтруктураРасшифровки2.Вставить("Дата2", ?(ВсегоПериодов > 1, КонецМесяца(ДобавитьМесяц(Отчет.Период.ДатаНачала, Период - 1)), Отчет.Период.ДатаОкончания));
				СтруктураРасшифровки2.Вставить("ВидимостьШапки", 0);
				СтруктураРасшифровки2.Вставить("Сценарий1", Отчет.Сценарий2);
				ОбластьДанныеСтолбцы.Параметры.Расшифровка2 = СтруктураРасшифровки2;
			КонецЕсли;
			
			ТабДок.Присоединить(ОбластьДанныеСтолбцы, ТекУровень);
			
			//Колонка = Колонка + 1;
		КонецЦикла;
		
		Если ИнтервалМеньше Тогда			
			ОбластьДанныеСтолбцы.Параметры.Сумма1 = ИтогоСумма1; 
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				ОбластьДанныеСтолбцы.Параметры.Сумма2 = ИтогоСумма2;
				ОбластьДанныеСтолбцы.Параметры.Сумма3 = ИтогоСумма2 - ИтогоСумма1;
			КонецЕсли;
			
			ТабДок.Присоединить(ОбластьДанныеСтолбцы, ТекУровень);
			
			СтруктураРасшифровки = Новый Структура;
			СтруктураРасшифровки.Вставить("Отчет", "Отчеты.Д_Расшифровка");
			СтруктураРасшифровки.Вставить("Счет", ПланСчетов1.ЗатратыНаПрво);
			СтруктураРасшифровки.Вставить("Предприятие", ТЗ[Строчка][3]);
			СтруктураРасшифровки.Вставить("Субконто1", ТЗ[Строчка][4]);
			СтруктураРасшифровки.Вставить("Дата1", Отчет.Период.ДатаНачала);
			СтруктураРасшифровки.Вставить("Дата2", Отчет.Период.ДатаОкончания);
			СтруктураРасшифровки.Вставить("ВидимостьШапки", 0);
			СтруктураРасшифровки.Вставить("Сценарий1", Отчет.Сценарий1);
			
			ОбластьДанныеСтолбцы.Параметры.Расшифровка = СтруктураРасшифровки;
			Если НЕ ПустаяСтрока(Отчет.Сценарий2)  Тогда
				СтруктураРасшифровки2 = Новый Структура;
				СтруктураРасшифровки2.Вставить("Отчет", "Отчеты.Д_Расшифровка");
				СтруктураРасшифровки2.Вставить("Счет", ПланСчетов2.ЗатратыНаПрво);
				СтруктураРасшифровки2.Вставить("Предприятие", ТЗ[Строчка][3]);
				СтруктураРасшифровки2.Вставить("Субконто1", ТЗ[Строчка][4]);
				СтруктураРасшифровки2.Вставить("Дата1", Отчет.Период.ДатаНачала);
				СтруктураРасшифровки2.Вставить("Дата2", Отчет.Период.ДатаОкончания);
				СтруктураРасшифровки2.Вставить("ВидимостьШапки", 0);
				СтруктураРасшифровки2.Вставить("Сценарий1", Отчет.Сценарий2);
				ОбластьДанныеСтолбцы.Параметры.Расшифровка2 = СтруктураРасшифровки2;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	ТабДок.ЗакончитьАвтогруппировкуСтрок();
	
	
	//таблицу на экран
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.Защита = Ложь;
	ТабДок.ТолькоПросмотр = Истина;
	ТабДок.ОтображатьЗаголовки = Ложь;
	//ТабДок.Показать();
	Элементы.ТабДок.Видимость = Истина;
	
		
КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	Если Отчет.ВидОтчета = 3 Тогда
		ЗаполнитьТаблицуДеятельность(1);
	иначе
		Если ПоПодразделениям Тогда
			ЗаполнитьТаблицу(1);
		Иначе
			ЗаполнитьТаблицуПредприятия(1);
		КонецЕсли;
	КонецЕсли;
	//ТабДок.Показать();
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ПоПодразделениям = Ложь;
	ВидимостьСпискаПредприятий = ?(БюджетныйНаСервере.ПолучитьПредприятия().Количество() > 0, 1, 0);
	Элементы.ГруппаПредприятие.Видимость = ВидимостьСпискаПредприятий;
	
	Группы = Новый Массив;
	Группы.Добавить(2);
	Группы.Добавить(3);
	Группы.Добавить(4);
	Группы.Добавить(5);
	Группы.Добавить(6);
	Группы.Добавить(7);
	
	//Элементы.ВидОтчета.СписокВыбора.Вставить(0, "Вертикальный", "Вертикальный", 0, );
	//Элементы.ВидОтчета.СписокВыбора.Вставить(1, "Вертикальный2", "Вертикальный с расшифровками", 0, );
	//Элементы.ВидОтчета.СписокВыбора.Вставить(2, "Горизонтальный", "Горизонтальный", 0, );
	
	Если РежимВыбораПредприятий = "" Тогда
		РежимВыбораПредприятий = "Предприятие"
	КонецЕсли;
	
	ЗаполнитьДеревоПредприятий();		
			
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьТаблицу(Команда)
	ЗаполнитьТаблицу(1);
КонецПроцедуры

&НаСервере
Процедура Расшифровать(Расшифровка)
	
	
	
КонецПроцедуры


&НаКлиенте
Процедура ТабДокОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	ОткрытьФорму("Отчет.Д_Расшифровка.Форма.ФормаОтчета", Расшифровка);
	
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//Если Параметры.Свойство("Сценарий1") Тогда //вызван отчет извне с параметрами
	//	Отчет.Сценарий1 = Параметры.Сценарий1;
	//	Отчет.Сценарий2 = Параметры.Сценарий2;
	//	Отчет.Период = Параметры.Период;
	//	Элементы.Группа.Видимость = Параметры.НастройкиВидимость;
	//	БюджетныйНаСервере.ЗаполнитьСписокПредприятия(Отчет.Предприятие, 0);
	//	Отчет.Предприятие.НайтиПоЗначению(Параметры.Предприятие).Пометка = 1;
	//	//Отчет.Предприятие = Параметры.Предприятие;
	//	ЗаполнитьТаблицу(0);
	//КонецЕсли;
	
	
	
КонецПроцедуры


&НаКлиенте
Процедура ПоказатьНастройки(Команда)
	Элементы.Группа.Видимость = 1 - Элементы.Группа.Видимость;
КонецПроцедуры

&НаКлиенте
Процедура Сценарий1ПриИзменении(Элемент)
	Отчет.Период.ДатаНачала = НачалоМесяца(БюджетныйНаСервере.ПолучитьПериодСценария(Отчет.Сценарий1).Дата1 + 60 * 60 * 24);
	Отчет.Период.ДатаОкончания = КонецМесяца(БюджетныйНаСервере.ПолучитьПериодСценария(Отчет.Сценарий1).Дата2);
КонецПроцедуры

&НаКлиенте
Процедура ЗадатьПериод(Команда)
	Элементы.Период.Видимость = 1 - Элементы.Период.Видимость;	
КонецПроцедуры

&НаКлиенте
Процедура ВидОтчетаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	ВидОтчета = ВыбранноеЗначение;
	//Для каждого Элемент Из Элементы.ВидОтчета.СписокВыбора Цикл
	
	
	//КонецЦикла; 
КонецПроцедуры

&НаСервере
Функция ПолучитьСценарийФакта()
	возврат Справочники.СценарииПланирования.Факт;
КонецФункции // ()

&НаКлиенте
Процедура Сценарий2ПриИзменении(Элемент)
	Если НЕ Отчет.Сценарий2 = ПолучитьСценарийФакта() Тогда
		Отчет.Период.ДатаНачала = НачалоМесяца(БюджетныйНаСервере.ПолучитьПериодСценария(Отчет.Сценарий2).Дата1 + 60 * 60 * 24);
		Отчет.Период.ДатаОкончания = КонецМесяца(БюджетныйНаСервере.ПолучитьПериодСценария(Отчет.Сценарий2).Дата2);
	КонецЕсли;
	Если ПустаяСтрока(Отчет.Сценарий2) Тогда
		Сценарий1ПриИзменении(0);	
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВидОтчетаПриИзменении(Элемент)
	
	Если Отчет.ВидОтчета = 3 Тогда
		Элементы.Предприятие.МножественныйВыбор = Ложь;
	Иначе
		Элементы.Предприятие.МножественныйВыбор = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Печать(Команда)
	
	Если ТабДок.ВысотаТаблицы = 0 Тогда
		Возврат;
	КонецЕсли;
	
	КлючУникальности = Строка(Новый УникальныйИдентификатор);
			
	ОткрытьФорму("Отчет.Д_ФРПроектов.Форма.ФормаПечати",, ЭтаФорма, КлючУникальности); 
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоПредприятий() 
	
	Если РежимВыбораПредприятий = "Тип" Тогда
		ДеревоПоТипамПр = БюджетныйНаСервере.ПолучитьДеревоПредприятийПоТипам(ПоПодразделениям);	
		ЗначениеВДанныеФормы(ДеревоПоТипамПр, Отчет.Предприятие)
	ИначеЕсли РежимВыбораПредприятий = "Направление" Тогда
		ДеревоПредприятий = БюджетныйНаСервере.ПолучитьДеревоПредприятийПоНаправлениям();		
		ЗначениеВДанныеФормы(ДеревоПредприятий, Отчет.Предприятие);
	Иначе
		ДеревоПредприятий = БюджетныйНаСервере.ПолучитьДеревоПредприятий(ПоПодразделениям);		
		ЗначениеВДанныеФормы(ДеревоПредприятий, Отчет.Предприятие);
	КонецЕсли;	
		
КонецПроцедуры

&НаКлиенте
Процедура ПоПодразделениямПриИзменении(Элемент)
	
	ЗаполнитьДеревоПредприятий();
	
	Если СкрыватьНеактуальные Тогда	
		КоличествоЭлементовДерева = Отчет.Предприятие.ПолучитьЭлементы().Количество();
		Для ОбратныйИнд = 1 По КоличествоЭлементовДерева Цикл		
			Если НеактуальныйПроект(Отчет.Предприятие.ПолучитьЭлементы()[КоличествоЭлементовДерева - ОбратныйИнд].Значение) Тогда
				Отчет.Предприятие.ПолучитьЭлементы().Удалить(КоличествоЭлементовДерева - ОбратныйИнд)
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура ПредприятиеПометкаПриИзменении(Элемент)
	
	Если Элемент.Родитель.ТекущиеДанные.ПолучитьРодителя() = Неопределено Тогда
		
		Для Каждого Стр Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
			
			Если Стр.Значение = Элемент.Родитель.ТекущиеДанные.Значение Тогда
				
				Для Каждого СтрП Из Стр.ПолучитьЭлементы() Цикл
					
					СтрП.Пометка = Элемент.Родитель.ТекущиеДанные.Пометка;
					
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЦикла;
		
	Иначе
		
		Если Элемент.Родитель.ТекущиеДанные.Пометка Тогда
			Элемент.Родитель.ТекущиеДанные.ПолучитьРодителя().Пометка = Элемент.Родитель.ТекущиеДанные.Пометка;
		КонецЕсли;	
			
	КонецЕсли;
	
КонецПроцедуры

//&НаСервереБезКонтекста
//Процедура ПросуммироватьТЗ(ТЗ)
//	
//	Для Каждого
//	
//КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПросуммироватьТЗПоКолонкам(ТЗ)
	
	Для ИндСтр = 0 По ТЗ.Количество() - 1 Цикл
		
		Если ТЗ[ИндСтр][4] = "Расходы" Тогда
			Продолжить;
		КонецЕсли;
		
		Для ИндКол = 10 По ТЗ.Колонки.Количество() - 1 Цикл
			
			ТЗ[ИндСтр][6] = ТЗ[ИндСтр][6] + ТЗ[ИндСтр][ИндКол];
			ТЗ[ИндСтр][8] = ТЗ[ИндСтр][8] + ТЗ[ИндСтр][ИндКол + 2];
			ИндКол = ИндКол + 3;
			
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПометкиВДереве(ЗначениеЗаполнения)
	
	Если Не РежимВыбораПредприятий = "Предприятие" Тогда
		Для Каждого ЭлТип Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
			
			Для Каждого ЭлПр Из ЭлТип.ПолучитьЭлементы() Цикл
				ЭлПр.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);
				Если ПоПодразделениям Тогда
					Для Каждого ЭлПодр Из ЭлПр.ПолучитьЭлементы() Цикл
						ЭлПодр.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
			ЭлТип.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);;
		КонецЦикла;
	Иначе
		Для Каждого ЭлПр Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
		
			ЭлПр.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);
			Если ПоПодразделениям Тогда
				Для Каждого ЭлПодр Из ЭлПр.ПолучитьЭлементы() Цикл
					ЭлПодр.Пометка = ?(ЗначениеЗаполнения = 1, Истина, Ложь);
			КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПредприятиеПоТипуПометкаПриИзменении(Элемент)
	
	Для Каждого ТекСтрока Из Элемент.Родитель.ТекущиеДанные.ПолучитьЭлементы() Цикл
			
		ТекСтрока.Пометка = Элемент.Родитель.ТекущиеДанные.Пометка;
			
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура НеактуальныеПриИзменении(Элемент)

	Если СкрыватьНеактуальные Тогда	
		Если РежимВыбораПредприятий = "Предприятие" Тогда
			КоличествоЭлементовДерева = Отчет.Предприятие.ПолучитьЭлементы().Количество();
			Для ОбратныйИнд = 1 По КоличествоЭлементовДерева Цикл		
				Если НеактуальныйПроект(Отчет.Предприятие.ПолучитьЭлементы()[КоличествоЭлементовДерева - ОбратныйИнд].Значение) Тогда
					Отчет.Предприятие.ПолучитьЭлементы().Удалить(КоличествоЭлементовДерева - ОбратныйИнд)
				КонецЕсли;
			КонецЦикла;
		Иначе
			Для Каждого ТекНаправление Из Отчет.Предприятие.ПолучитьЭлементы() Цикл
				КоличествоЭлементовДерева = ТекНаправление.ПолучитьЭлементы().Количество();
				Для ОбратныйИнд = 1 По КоличествоЭлементовДерева Цикл		
					Если НеактуальныйПроект(ТекНаправление.ПолучитьЭлементы()[КоличествоЭлементовДерева - ОбратныйИнд].Значение) Тогда
						ТекНаправление.ПолучитьЭлементы().Удалить(КоличествоЭлементовДерева - ОбратныйИнд)
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;			
		КонецЕсли;
	Иначе
		ЗаполнитьДеревоПредприятий()
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция НеактуальныйПроект(ТекущееПредприятие)

	Если ЗначениеЗаполнено(ТекущееПредприятие) И ТипЗнч(ТекущееПредприятие) = Тип("СправочникСсылка.Предприятия") Тогда
		Если ТипЗнч(ТекущееПредприятие.ТипПредприятия) = Тип("СправочникСсылка.сабТипыПредприятий") Тогда
			Возврат ТекущееПредприятие.ТипПредприятия.Родитель = Справочники.сабТипыПредприятий.НайтиПоНаименованию("Неактуальные проекты") ИЛИ ТекущееПредприятие.ТипПредприятия.Родитель = Справочники.сабТипыПредприятий.НайтиПоНаименованию("Неактуальные проекты (группа)")
		Иначе 
			Возврат Ложь
		КонецЕсли
	ИначеЕсли ЗначениеЗаполнено(ТекущееПредприятие) И ТипЗнч(ТекущееПредприятие) = Тип("СправочникСсылка.сабТипыПредприятий") Тогда
		Возврат ТекущееПредприятие.Родитель = Справочники.сабТипыПредприятий.НайтиПоНаименованию("Неактуальные проекты") ИЛИ ТекущееПредприятие.Родитель = Справочники.сабТипыПредприятий.НайтиПоНаименованию("Неактуальные проекты (группа)")
	Иначе
		Возврат Ложь
	КонецЕсли;                                                                                                   
	
КонецФункции

&НаКлиенте
Процедура ВыборПредприятийПоНаправлениямПриИзменении(Элемент)
	
	Если РежимВыбораПредприятий = "Тип" ИЛИ РежимВыбораПредприятий = "Направление" Тогда
		ПоПодразделениям = Ложь;
		Элементы.ПоПодразделениям.Видимость = Ложь;
	Иначе
		Элементы.ПоПодразделениям.Видимость = Истина;
	КонецЕсли;
	
	ЗаполнитьДеревоПредприятий();
	
	Если СкрыватьНеактуальные Тогда	
		КоличествоЭлементовДерева = Отчет.Предприятие.ПолучитьЭлементы().Количество();
		Для ОбратныйИнд = 1 По КоличествоЭлементовДерева Цикл		
			Если НеактуальныйПроект(Отчет.Предприятие.ПолучитьЭлементы()[КоличествоЭлементовДерева - ОбратныйИнд].Значение) Тогда
				Отчет.Предприятие.ПолучитьЭлементы().Удалить(КоличествоЭлементовДерева - ОбратныйИнд)
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Модифицированность = Ложь;
	
КонецПроцедуры
