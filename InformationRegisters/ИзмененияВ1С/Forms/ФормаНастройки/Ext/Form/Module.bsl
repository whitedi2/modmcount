
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ДеревоОбъект = Новый ДеревоЗначений;
	ДеревоОбъект.Колонки.Добавить("Имя");
	ДеревоОбъект.Колонки.Добавить("Синоним");
	ДеревоОбъект.Колонки.Добавить("Включить");
	
	ДобавитьСтрокиДереваПоИмениОбъекта("Документ", "ы", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("Справочник", "и", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("Роли", "", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("ПланыСчетов", "", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("Отчет", "ы", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("Обработки", "", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("БизнесПроцесс", "ы", ДеревоОбъект);
	ДобавитьСтрокиДереваПоИмениОбъекта("Задачи", "", ДеревоОбъект);
	
	Если Параметры.Свойство("ПредставлениеВыбранныхОбъектов") Тогда
		ОтметитьВыбранныеРанееОбъектыВДереве(ДеревоОбъект, Параметры.ПредставлениеВыбранныхОбъектов);
	КонецЕсли;	

    ЗначениеВРеквизитФормы(ДеревоОбъект, "Дерево");
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьСтрокиДереваПоИмениОбъекта(СтрОбъект, ОкончаниеДляМножЧисла, ДеревоОбъект)
	
	ВерхняяСтрока			= ДеревоОбъект.Строки.Добавить();
	ВерхняяСтрока.Имя		= СтрОбъект;
	ВерхняяСтрока.Синоним	= СтрОбъект + ОкончаниеДляМножЧисла;
	
	НижниеСтроки = ВерхняяСтрока.Строки;
	
	Для Каждого ОбъектМетаданных Из Метаданные[ВерхняяСтрока.Синоним] Цикл
		НижняяСтрока		= НижниеСтроки.Добавить();
		НижняяСтрока.Синоним= ОбъектМетаданных.Синоним;
		НижняяСтрока.Имя	= СтрОбъект + "." + ОбъектМетаданных.Имя;
	КонецЦикла;
	
КонецПроцедуры
	
&НаСервере
Процедура ОтметитьВыбранныеРанееОбъектыВДереве(Дерево, ВыбранныеОбъекты)
	
	Если Не ЗначениеЗаполнено(ВыбранныеОбъекты) Тогда
		Возврат;
	КонецЕсли;	
	
	ПозицияРазделителя = Найти(ВыбранныеОбъекты , ";");
	
	Если ПозицияРазделителя <> 0 Тогда
		НайденныйОбъект = Лев(ВыбранныеОбъекты, ПозицияРазделителя);
		Отметить(СтрЗаменить(НайденныйОбъект, ";", ""), Дерево);
		НоваяСтрока = СтрЗаменить(ВыбранныеОбъекты, НайденныйОбъект, "");
	Иначе
		Отметить(ВыбранныеОбъекты, Дерево);
	КонецЕсли;
	
	ОтметитьВыбранныеРанееОбъектыВДереве(Дерево, НоваяСтрока); 
		
КонецПроцедуры 

&НаСервере
Процедура Отметить(НайденныйОбъект, Дерево)
	
	СтрокаДерева = Дерево.Строки.Найти(НайденныйОбъект, "Имя", Истина);
	Если Не СтрокаДерева = Неопределено Тогда
		СтрокаДерева.Включить = Истина;
	КонецЕсли;
	
КонецПроцедуры	

// Находит текущую строку в дереве для дальнейшего 
//
// Параметры:
//  ИмяСтроки      - Имя строки дерева значений
// 
&НаСервере
Процедура УстановитьПометки(ИмяСтроки)
	
	ДеревоОбъект = РеквизитФормыВЗначение("Дерево");
	
	ТекСтрока = ДеревоОбъект.Строки.Найти(ИмяСтроки, , Истина);
	
	УстановитьПометкиПодчиненных(ТекСтрока);
	
	ЗначениеВРеквизитФормы(ДеревоОбъект, "Дерево");
	
КонецПроцедуры // УстановитьПометкиПодчиненных()

// Устанавливает состояние пометки у подчиненных строк строки дерева значений
// в зависимости от пометки текущей строки
//
// Параметры:
//  ТекСтрока      - Строка дерева значений
// 
&НаСервере
Процедура УстановитьПометкиПодчиненных(ТекСтрока)

	Включить    = ТекСтрока.Включить;
	Подчиненные = ТекСтрока.Строки;

	Если Подчиненные.Количество() > 0 Тогда
		Для каждого Строка из Подчиненные Цикл
			Строка.Включить = Включить;
			УстановитьПометкиПодчиненных(Строка);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры // УстановитьПометкиПодчиненных()

//Записывает установленные значения в регистр
//
&НаКлиенте
Процедура Записать(Команда)
	
	ВыделенныеОбъекты = ПолучитьВыделенныеОбъектыНаСервере();
	
	Закрыть(ВыделенныеОбъекты);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьВыделенныеОбъектыНаСервере()
	
	ВыделенныеОбъекты = "";
	ДеревоОбъект = РеквизитФормыВЗначение("Дерево");
	
	Для Каждого ВерхняяСтрока Из ДеревоОбъект.Строки Цикл
		Для Каждого НижняяСтрока Из ВерхняяСтрока.Строки Цикл
			Если Не НижняяСтрока.Включить Тогда
				Продолжить;
			КонецЕсли;	
			ЗначениеОтбора	= НижняяСтрока.Имя;
			ВыделенныеОбъекты = ВыделенныеОбъекты + ?(ВыделенныеОбъекты = "", ЗначениеОтбора, ";" + ЗначениеОтбора);
		КонецЦикла;
	КонецЦикла;	
	
	Возврат ВыделенныеОбъекты;
	
КонецФункции	

&НаКлиенте
Процедура ЗакрытьФорму(Команда)
	
	Закрыть("");
	
КонецПроцедуры
