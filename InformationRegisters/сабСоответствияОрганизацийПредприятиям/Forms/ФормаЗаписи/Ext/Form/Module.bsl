
&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	УстановитьПривилегированныйРежим(Истина);
	НачатьТранзакцию();
	
	Об = Запись.Организация.ПолучитьОбъект();
	Об.Предприятие = Запись.Предприятие;
	Об.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	БанковскиеСчетаТЗ.Ссылка КАК Ссылка
	               |ИЗ
	               |	Справочник.БанковскиеСчета КАК БанковскиеСчетаТЗ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Д_ИсточникПП КАК Д_ИсточникПП
	               |		ПО БанковскиеСчетаТЗ.Ссылка = Д_ИсточникПП.БанковскиеСчета
	               |ГДЕ
	               |	БанковскиеСчетаТЗ.Владелец = &Владелец
	               |	И Д_ИсточникПП.БанковскиеСчета ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("Владелец", Запись.Организация);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Об = Выборка.Ссылка.ПолучитьОбъект();
		Об.Предприятие = Запись.Предприятие;
		Об.Записать();
		
		НоваяЗапись = РегистрыСведений.Д_ИсточникПП.СоздатьМенеджерЗаписи();
		НоваяЗапись.БанковскиеСчета = Выборка.Ссылка;
		НоваяЗапись.Период = НачалоМесяца(ТекущаяДата());
		НоваяЗапись.Записать();
		
	КонецЦикла;
	
	//обрабатываем договоры, т.к. есть реквизит предприятия. а нужен ли?
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ДоговорыКонтрагентов.Ссылка КАК Ссылка,
	               |	ДоговорыКонтрагентов.Организация КАК Организация,
				   |	ДоговорыКонтрагентов.Дата КАК Дата,
				   |	ДоговорыКонтрагентов.СрокОплаты КАК СрокОплаты,
	               |	сабСоответствияОрганизацийПредприятиям.Предприятие КАК Предприятие
	               |ИЗ
	               |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.сабСоответствияОрганизацийПредприятиям КАК сабСоответствияОрганизацийПредприятиям
	               |		ПО ДоговорыКонтрагентов.Организация = сабСоответствияОрганизацийПредприятиям.Организация
	               |ГДЕ
	               |	ДоговорыКонтрагентов.Предприятие = ЗНАЧЕНИЕ(Справочник.Предприятия.ПустаяСсылка)
	               |	И НЕ ДоговорыКонтрагентов.Владелец = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)";
	
	//Запрос.УстановитьПараметр("", );
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Об = Выборка.Ссылка.ПолучитьОбъект();
		Об.Предприятие = Выборка.Предприятие;
		Об.Записать();
		
		НоваяЗапись = РегистрыСведений.ОтсрочкаПоДоговорам.СоздатьМенеджерЗаписи();
		НоваяЗапись.Договор = Выборка.Ссылка;
		НоваяЗапись.Период = Выборка.Дата;
		НоваяЗапись.Отсрочка = Выборка.СрокОплаты;
		НоваяЗапись.Записать();
		
	КонецЦикла;	
	
	ЗафиксироватьТранзакцию();
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры
