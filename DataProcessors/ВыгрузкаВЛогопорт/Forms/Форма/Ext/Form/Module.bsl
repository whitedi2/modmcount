&НаКлиенте
Процедура ПутьКФайлуНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если НЕ ПодключитьРасширениеРаботыСФайлами() Тогда		
		ТекстСообщения = НСтр(
		"ru='Для данной операции необходимо
		|установить расширение работы с файлами!
		|Установка выполняется в разделе
		|""Сервис и администрирование""/
		|""Настройка сервисных функций"".'"
		);
		ПоказатьПредупреждение(Неопределено, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогВыбораКаталога = Новый ДиалогВыбораФайла(Режим);
	ДиалогВыбораКаталога.Каталог = ПутьКФайлу;
	ДиалогВыбораКаталога.МножественныйВыбор = Ложь;
	ДиалогВыбораКаталога.Заголовок = НСтр("ru = 'Выберите каталог'");
	Если ДиалогВыбораКаталога.Выбрать() Тогда
		ПутьКФайлу = ДиалогВыбораКаталога.Каталог;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПолулчитьСтруктуруЗаказа(ТекЗаказ, ТекКроссДокинг)
	
	Если ТипЗнч(ТекЗаказ) = Тип("ДокументСсылка.сабМаршрутныйЛист") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	""NP381"" КАК CCODE,
		|	""3665817038"" КАК SHIPID,
		|	"""" КАК ORDNR,
		|	ЗаказПоставщику.Номер КАК DLVNR,
		|	ЗаказПоставщику.ДатаПоступления КАК ORDTE,
		|	1 КАК RMENG,
		|	""НАШ ПАРТНЕР ООО"" КАК VNAME,
		|	""00-000008"" КАК VCODE,
		|	"""" КАК ADINF,
		|	0 КАК MCOST,
		|	1 КАК POSNR,
		|	""БП-00002883"" КАК MATNR,
		|	ЗаказПоставщику.КоличествоПаллет КАК MMENG,
		|	ЗаказПоставщику.Вес КАК Weight,
		|	""PCE"" КАК MEINH,
		|	0 КАК PRICE,
		|	"""" КАК BBDDT,
		|	ЗаказПоставщику.КоличествоПаллет КАК NMPQuantity,
		|	ИСТИНА КАК KrossDoc
		|ИЗ
		|	Документ.сабМаршрутныйЛист КАК ЗаказПоставщику
		|ГДЕ
		|	ЗаказПоставщику.Ссылка = &Ссылка";
		
		Запрос.УстановитьПараметр("Ссылка", ТекЗаказ);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		СтруктураЗаказа = Новый Структура("CCODE, SHIPID, ORDNR, DLVNR, ORDTE, RMENG, VNAME, VCODE, ADINF, MCOST, Weight, NMPQuantity, KrossDoc");
		
		Пока Выборка.Следующий() Цикл
			
			ЗаполнитьЗначенияСвойств(СтруктураЗаказа, Выборка);
			МассивСтрок = Новый Массив;
			СтруктураСтроки = Новый Структура("POSNR, MATNR, MMENG, MEINH, PRICE, BBDDT");
			ЗаполнитьЗначенияСвойств(СтруктураСтроки, Выборка);
			МассивСтрок.Добавить(СтруктураСтроки);
			СтруктураЗаказа.Вставить("Товары", МассивСтрок);
			
		КонецЦикла;
		
	Иначе
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	""NP381"" КАК CCODE,
		|	ЗаказПоставщику.Контрагент.ИНН КАК SHIPID,
		|	"""" КАК ORDNR,
		|	ЗаказПоставщику.Номер КАК DLVNR,
		|	ЗаказПоставщику.ДатаПоступления КАК ORDTE,
		|	1 КАК RMENG,
		|	ЗаказПоставщику.Контрагент.Наименование КАК VNAME,
		|	ЗаказПоставщику.Контрагент.Код КАК VCODE,
		|	"""" КАК ADINF,
		|	ЗаказПоставщику.СуммаДокумента КАК MCOST,
		|	ЗаказПоставщику.ТабличнаяЧасть.(
		|		НомерСтроки КАК POSNR,
		|		Номенклатура.Код КАК MATNR,
		|		Количество КАК MMENG,
		|		ЕдиницаИзмерения КАК MEINH,
		|		Цена КАК PRICE,
		|		"""" КАК BBDDT,
		|		КоличествоУпаковок КАК КоличествоУпаковок
		|	) КАК ТабличнаяЧасть,
		|	ЗаказПоставщику.ВесТовара КАК Weight,
		|	0 КАК NMPQuantity,
		|	&ЭтоКроссДок КАК KrossDoc
		|ИЗ
		|	Документ.ЗаказПоставщику КАК ЗаказПоставщику
		|ГДЕ
		|	ЗаказПоставщику.Ссылка = &Ссылка";
		
		Запрос.УстановитьПараметр("Ссылка", ТекЗаказ);
		Запрос.УстановитьПараметр("ЭтоКроссДок", ТекКроссДокинг);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		СтруктураЗаказа = Новый Структура("CCODE, SHIPID, ORDNR, DLVNR, ORDTE, RMENG, VNAME, VCODE, ADINF, MCOST");
		Если ТекКроссДокинг Тогда
			СтруктураЗаказа.Вставить("Weight");	
			СтруктураЗаказа.Вставить("NMPQuantity");
			СтруктураЗаказа.Вставить("KrossDoc");
		КонецЕсли;
		
		Пока Выборка.Следующий() Цикл
			
			ЗаполнитьЗначенияСвойств(СтруктураЗаказа, Выборка);
			ВыборкаТЧ = Выборка.ТабличнаяЧасть.Выгрузить();
			СтруктураЗаказа.RMENG = ВыборкаТЧ.Количество();
			Если ТекКроссДокинг Тогда
				СтруктураЗаказа.NMPQuantity = ВыборкаТЧ.Итог("КоличествоУпаковок");
				СтруктураЗаказа.Weight = ВыборкаТЧ.Итог("MMENG");
			КонецЕсли;
			
			МассивСтрок = Новый Массив;
			Для каждого ТекСтрока Из ВыборкаТЧ Цикл
				СтруктураСтроки = Новый Структура("POSNR, MATNR, MMENG, MEINH, PRICE, BBDDT");
				ЗаполнитьЗначенияСвойств(СтруктураСтроки, ТекСтрока);
				Если ТекКроссДокинг Тогда
					СтруктураСтроки.MMENG = ТекСтрока.КоличествоУпаковок;
				КонецЕсли;
				МассивСтрок.Добавить(СтруктураСтроки);
			КонецЦикла;
			СтруктураЗаказа.Вставить("Товары", МассивСтрок);
			
		КонецЦикла;
		
	КонецЕсли;
	
    Возврат СтруктураЗаказа;
	
КонецФункции

&НаСервере
Функция ПолулчитьСтруктуруЗаказаКлиента(ТекЗаказ, ТекКроссДокинг)
	
	Если ТипЗнч(ТекЗаказ) = Тип("ДокументСсылка.сабМаршрутныйЛист") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	""NP381"" КАК CCODE,
		|	"""" КАК SHIPID,
		|	ЗаказКлиента.Номер КАК SFNR,
		|	ЗаказКлиента.Номер КАК ORDNR,
		|	ЗаказКлиента.Номер КАК DLVNR,
		|	ЗаказКлиента.Дата КАК ORDTE,
		|	1 КАК RMENG,
		|	""Кросс-Докинг Самовывоз Наш Партнёр"" КАК SNAME,
		|	""00-000008"" КАК VCODE,
		|	"""" КАК ADINF,
		|	0 КАК MCOST,
		|	1 КАК POSNR,
		|	""БП-00003021"" КАК MATNR,
		|	ЗаказКлиента.Вес КАК MMENG,
		|	""PCE"" КАК MEINH,
		|	0 КАК PRICE,
		|	"""" КАК BBDDT,
		|	ЗаказКлиента.Вес КАК КоличествоУпаковок,
		|	ЗаказКлиента.Дата КАК SDATE,
		|	"""" КАК SADDR,
		|	"""" КАК SINNN,
		|	""00000001968"" КАК SHPID,
		|	1 КАК STATUS,
		|	ИСТИНА КАК UCHNDS,
		|	ИСТИНА КАК NDSVSUMME,
		|	ЗаказКлиента.Вес КАК Weight,
		|	ЗаказКлиента.КоличествоПаллет КАК NMPQuantity,
		|	ИСТИНА КАК KrossDoc
		|ИЗ
		|	Документ.сабМаршрутныйЛист КАК ЗаказКлиента
		|ГДЕ
		|	ЗаказКлиента.Ссылка = &Ссылка";
		
		Запрос.УстановитьПараметр("Ссылка", ТекЗаказ);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		СтруктураЗаказа = Новый Структура("CCODE, SFNR, SHIPID, ORDNR, DLVNR, ORDTE, RMENG, SNAME, VCODE, ADINF, MCOST, SDATE, SADDR, SINNN, SHPID, STATUS, UCHNDS, NDSVSUMME, Weight, NMPQuantity, KrossDoc");

		Пока Выборка.Следующий() Цикл
			
			ЗаполнитьЗначенияСвойств(СтруктураЗаказа, Выборка);
			
			МассивСтрок = Новый Массив;
			СтруктураСтроки = Новый Структура("POSNR, MATNR, MMENG, MEINH, PRICE, BBDDT");
			ЗаполнитьЗначенияСвойств(СтруктураСтроки, Выборка);
			МассивСтрок.Добавить(СтруктураСтроки);
			СтруктураЗаказа.Вставить("Товары", МассивСтрок);
			
		КонецЦикла;
		
	Иначе
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	""NP381"" КАК CCODE,
		|	ЗаказКлиента.Контрагент.ИНН КАК SHIPID,
		|	ЕСТЬNULL(СчетФактураВыданный.Номер, ЗаказКлиента.Номер) КАК SFNR,
		|	ЕСТЬNULL(РеализацияТоваровУслуг.Номер, ЗаказКлиента.Номер) КАК ORDNR,
		|	ЗаказКлиента.Номер КАК DLVNR,
		|	ЗаказКлиента.Дата КАК ORDTE,
		|	1 КАК RMENG,
		|	ЗаказКлиента.Контрагент.Наименование КАК SNAME,
		|	ЗаказКлиента.Контрагент.Код КАК VCODE,
		|	"""" КАК ADINF,
		|	ЗаказКлиента.СуммаДокумента КАК MCOST,
		|	ЗаказКлиента.ТабличнаяЧасть.(
		|		НомерСтроки КАК POSNR,
		|		Номенклатура.Код КАК MATNR,
		|		Количество КАК MMENG,
		|		ЕдиницаИзмерения КАК MEINH,
		|		Цена КАК PRICE,
		|		ДОБАВИТЬКДАТЕ(ЗаказКлиента.Дата, ДЕНЬ, ЗаказКлиента.ТабличнаяЧасть.Номенклатура.СрокГодности) КАК BBDDT,
		|		КоличествоУпаковок КАК КоличествоУпаковок
		|	) КАК ТабличнаяЧасть,
		|	ЗаказКлиента.ДатаПоступления КАК SDATE,
		|	ЗаказКлиента.АдресДоставки КАК SADDR,
		|	ЗаказКлиента.Контрагент.ИНН КАК SINNN,
		|	ЗаказКлиента.ПодразделениеКонтрагента.Код КАК SHPID,
		|	1 КАК STATUS,
		|	ЗаказКлиента.УчитыватьНДС КАК UCHNDS,
		|	ЗаказКлиента.ЦенаВключаетНДС КАК NDSVSUMME,
		|	ЗаказКлиента.ВесТовара КАК Weight,
		|	0 КАК NMPQuantity,
		|	&ЭтоКроссДок КАК KrossDoc
		|ИЗ
		|	Документ.ЗаказКлиента КАК ЗаказКлиента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
		|			ПО РеализацияТоваровУслуг.Ссылка = СчетФактураВыданный.ДокументОснование
		|				И (СчетФактураВыданный.ПометкаУдаления = ЛОЖЬ)
		|		ПО ЗаказКлиента.Ссылка = РеализацияТоваровУслуг.Заказ
		|			И (РеализацияТоваровУслуг.ПометкаУдаления = ЛОЖЬ)
		|ГДЕ
		|	ЗаказКлиента.Ссылка = &Ссылка";
		
		Запрос.УстановитьПараметр("Ссылка", ТекЗаказ);
		Запрос.УстановитьПараметр("ЭтоКроссДок", ТекКроссДокинг);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		СтруктураЗаказа = Новый Структура("CCODE, SFNR, SHIPID, ORDNR, DLVNR, ORDTE, RMENG, SNAME, VCODE, ADINF, MCOST, SDATE, SADDR, SINNN, SHPID, STATUS, UCHNDS, NDSVSUMME");
		Если ТекКроссДокинг Тогда
			СтруктураЗаказа.Вставить("Weight");	
			СтруктураЗаказа.Вставить("NMPQuantity");
			СтруктураЗаказа.Вставить("KrossDoc");
		КонецЕсли;
		
		Пока Выборка.Следующий() Цикл
			
			ЗаполнитьЗначенияСвойств(СтруктураЗаказа, Выборка);
			ВыборкаТЧ = Выборка.ТабличнаяЧасть.Выгрузить();
			СтруктураЗаказа.RMENG = ВыборкаТЧ.Количество();
			
			МассивСтрок = Новый Массив;
			Для каждого ТекСтрока Из ВыборкаТЧ Цикл
				СтруктураСтроки = Новый Структура("POSNR, MATNR, MMENG, MEINH, PRICE, BBDDT");
				ЗаполнитьЗначенияСвойств(СтруктураСтроки, ТекСтрока);
				Если ТекКроссДокинг Тогда
					СтруктураСтроки.MMENG = ТекСтрока.КоличествоУпаковок;
				КонецЕсли;
				МассивСтрок.Добавить(СтруктураСтроки);
			КонецЦикла;
			СтруктураЗаказа.Вставить("Товары", МассивСтрок);
			
			Если ТекКроссДокинг Тогда
				СтруктураЗаказа.NMPQuantity = ВыборкаТЧ.Итог("КоличествоУпаковок");
				СтруктураЗаказа.Weight = ВыборкаТЧ.Итог("MMENG");
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	        
    Возврат СтруктураЗаказа;
	
КонецФункции

&НаКлиенте
Процедура ВыгрузитьФайлы(Команда)
	
	ЗаписатьCSV("", ПутьКФайлу + "\users.csv");
		
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьCSV(текст,имяФайла)
	
	Для каждого ТекЗаказ Из ЗаказыПоставщикам Цикл
		
		ТекКроссДокинг = ТекЗаказ.ТранзитныйГруз;
		Выборка = ПолулчитьСтруктуруЗаказа(ТекЗаказ.ЗаказПоставщику, ТекКроссДокинг);
		
		ЗаписьXML = Новый ЗаписьXML;
		
		ЗаписьXML.ОткрытьФайл(ПутьКФайлу+ "\Inbound_" + Выборка.DLVNR + "_" + Формат(Выборка.ORDTE, "ДФ=yyyyMMddhhmmss") + ".xml", "UTF-8"); //Открываем файл для записи, указываем кодировку
		
		ЗаписьXML.ЗаписатьОбъявлениеXML();  // Записываем объявление XML
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("INBNOTIFICATION");
		ЗаписьXML.ЗаписатьНачалоЭлемента("ORDHD"); // 
		ЗаписьXML.ЗаписатьАтрибут("CCODE", Выборка.CCODE);
		ЗаписьXML.ЗаписатьАтрибут("SHIPID", Выборка.SHIPID);
		ЗаписьXML.ЗаписатьАтрибут("ORDNR", Выборка.ORDNR); 
		ЗаписьXML.ЗаписатьАтрибут("DLVNR", Выборка.DLVNR);
		ЗаписьXML.ЗаписатьАтрибут("ORDTE", Формат(Выборка.ORDTE, "ДФ=yyyyMMdd"));
		ЗаписьXML.ЗаписатьАтрибут("RMENG", Формат(Выборка.RMENG, "ЧГ=0"));
		ЗаписьXML.ЗаписатьАтрибут("VNAME", Выборка.VNAME);
		ЗаписьXML.ЗаписатьАтрибут("VCODE", Выборка.VCODE);
		ЗаписьXML.ЗаписатьАтрибут("ADINF", Выборка.ADINF);
		ЗаписьXML.ЗаписатьАтрибут("MCOST", Формат(Выборка.MCOST, "ЧГ=0; ЧРД=."));
		
		Если ТекКроссДокинг Тогда
			ЗаписьXML.ЗаписатьАтрибут("Weight", Формат(Выборка.Weight * ?(КоэффициентБрутто, КоэффициентБрутто, 1), "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("NMPQuantity", Формат(Выборка.NMPQuantity, "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("KrossDoc", Строка(?(Выборка.KrossDoc, "Истина", "Ложь")));
		КонецЕсли;
		
		Для каждого ТекСтрока Из Выборка.Товары Цикл
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ORDRW"); // Начало элемента Организация
			
			ЗаписьXML.ЗаписатьАтрибут("POSNR", Формат(ТекСтрока.POSNR, "ЧГ=0"));
			ЗаписьXML.ЗаписатьАтрибут("MATNR", Строка(ТекСтрока.MATNR));
			ЗаписьXML.ЗаписатьАтрибут("MMENG", Формат(ТекСтрока.MMENG, "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("MEINH", Строка(?(ТекКроссДокинг, "PCE", ТекСтрока.MEINH)));
			ЗаписьXML.ЗаписатьАтрибут("PRICE", Формат(ТекСтрока.PRICE, "ЧГ=0; ЧРД=."));
			//ЗаписьXML.ЗаписатьАтрибут("BBDDT", Строка(ТекСтрока.BBDDT));
			
			ЗаписьXML.ЗаписатьКонецЭлемента(); 
			
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьКонецЭлемента(); 
		
		ЗаписьXML.ЗаписатьКонецЭлемента(); 
		
	КонецЦикла;
	
	Для каждого ТекЗаказ Из ЗаказыКлиентов Цикл
		
		ТекКроссДокинг = ТекЗаказ.ТранзитныйГруз;
		
		Выборка = ПолулчитьСтруктуруЗаказаКлиента(ТекЗаказ.ЗаказКлиента, ТекКроссДокинг);
		
		ЗаписьXML = Новый ЗаписьXML;
		
		ЗаписьXML.ОткрытьФайл(ПутьКФайлу+ "\Outbound_" + Выборка.DLVNR + "_" + Формат(Выборка.ORDTE, "ДФ=yyyyMMddhhmmss") + ".xml", "UTF-8"); //Открываем файл для записи, указываем кодировку
		
		ЗаписьXML.ЗаписатьОбъявлениеXML();  // Записываем объявление XML
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("SHPNOTIFICATION");
		ЗаписьXML.ЗаписатьНачалоЭлемента("ORDHD"); 
		ЗаписьXML.ЗаписатьАтрибут("CCODE", Выборка.CCODE);
		ЗаписьXML.ЗаписатьАтрибут("SHIPID", Выборка.SHIPID);
		ЗаписьXML.ЗаписатьАтрибут("ORDNR", Выборка.ORDNR); 
		ЗаписьXML.ЗаписатьАтрибут("DLVNR", Выборка.DLVNR);
		ЗаписьXML.ЗаписатьАтрибут("ORDTE", Формат(Выборка.ORDTE, "ДФ=yyyyMMdd"));
		ЗаписьXML.ЗаписатьАтрибут("RMENG", Формат(Выборка.RMENG, "ЧГ=0"));
		ЗаписьXML.ЗаписатьАтрибут("SNAME", Выборка.SNAME);
		//ЗаписьXML.ЗаписатьАтрибут("VCODE", Выборка.VCODE);
		ЗаписьXML.ЗаписатьАтрибут("ADINF", Выборка.ADINF);
		ЗаписьXML.ЗаписатьАтрибут("MCOST", Формат(Выборка.MCOST, "ЧГ=0; ЧРД=."));
		ЗаписьXML.ЗаписатьАтрибут("SFNR", Выборка.SFNR);
		ЗаписьXML.ЗаписатьАтрибут("SDATE", Формат(Выборка.SDATE, "ДФ=yyyyMMdd"));
		ЗаписьXML.ЗаписатьАтрибут("SADDR", Выборка.SADDR);
		ЗаписьXML.ЗаписатьАтрибут("SINNN", Выборка.SINNN);
		ЗаписьXML.ЗаписатьАтрибут("SHPID", Выборка.SHPID);
		ЗаписьXML.ЗаписатьАтрибут("STATUS", Строка(Выборка.STATUS));
		ЗаписьXML.ЗаписатьАтрибут("UCHNDS", Строка(Выборка.UCHNDS));
		ЗаписьXML.ЗаписатьАтрибут("NDSVSUMME", Строка(Выборка.NDSVSUMME));
		
		Если ТекКроссДокинг Тогда
			ЗаписьXML.ЗаписатьАтрибут("Weight", Формат(Выборка.Weight * ?(КоэффициентБрутто, КоэффициентБрутто, 1), "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("NMPQuantity", Формат(Выборка.NMPQuantity, "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("KrossDoc", Строка(?(Выборка.KrossDoc, "Истина", "Ложь")));
		КонецЕсли;
		
		Для каждого ТекСтрока Из Выборка.Товары Цикл
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ORDRW"); 
			
			ЗаписьXML.ЗаписатьАтрибут("POSNR", Формат(ТекСтрока.POSNR, "ЧГ=0"));
			ЗаписьXML.ЗаписатьАтрибут("MATNR", Строка(ТекСтрока.MATNR));
			ЗаписьXML.ЗаписатьАтрибут("MMENG", Формат(ТекСтрока.MMENG, "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("MEINH", Строка(?(ТекКроссДокинг, "PCE", ТекСтрока.MEINH)));
			ЗаписьXML.ЗаписатьАтрибут("PRICE", Формат(ТекСтрока.PRICE, "ЧГ=0; ЧРД=."));
			ЗаписьXML.ЗаписатьАтрибут("BBDDT", Формат(ТекСтрока.BBDDT, "ДФ=yyyyMMdd"));
			
			ЗаписьXML.ЗаписатьКонецЭлемента(); 
			
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьКонецЭлемента(); 
		ЗаписьXML.ЗаписатьКонецЭлемента(); 
		
	КонецЦикла;
	
	Сообщения = "Файлы созданы";
	
КонецПроцедуры


&НаКлиенте
Процедура КроссДокингПриИзменении(Элемент)
	Элементы.КоличествоПаллет.Доступность = КроссДокинг;
	Элементы.КоэффициентБрутто.Доступность = КроссДокинг;
КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	КроссДокингПриИзменении(Неопределено);
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	КоличествоПаллет = 1;
	КоэффициентБрутто = 1.08;
	
	Если Параметры.Свойство("Документ") Тогда
		ЗаполнитьЗаказамиИзМЛ(Параметры.Документ);	
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьЗаказамиИзМЛ(МаршрутныйЛист)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента КАК ЗаказКлиента,
	               |	ЕСТЬNULL(сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента.ТранзитныйГруз, сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента.КроссДокинг) КАК ТранзитныйГруз,
	               |	ВЫБОР
	               |		КОГДА ТИПЗНАЧЕНИЯ(сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента) = ТИП(Документ.ЗаказКлиента)
	               |			ТОГДА сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента.ДатаПоступления
	               |		ИНАЧЕ сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента.Дата
	               |	КОНЕЦ КАК ДатаОтгрузки,
	               |	сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента.ДатаПоступления КАК ДатаТранзитнойОтгрузки
	               |ИЗ
	               |	Документ.сабМаршрутныйЛист.ТабличнаяЧасть КАК сабМаршрутныйЛистТабличнаяЧасть
	               |ГДЕ
	               |	сабМаршрутныйЛистТабличнаяЧасть.Ссылка = &Ссылка
	               |	И (ТИПЗНАЧЕНИЯ(сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента) = ТИП(Документ.ЗаказКлиента)
	               |			ИЛИ ТИПЗНАЧЕНИЯ(сабМаршрутныйЛистТабличнаяЧасть.ЗаказКлиента) = ТИП(Документ.СабМаршрутныйЛист))";
	
	Запрос.УстановитьПараметр("Ссылка", МаршрутныйЛист);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	ЗаказыКлиентов.Очистить();
	ЗаказыПоставщикам.Очистить();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ЗаказыКлиентов.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		НоваяСтрока.Дата = Выборка.ДатаОтгрузки;
		
		Если Выборка.ТранзитныйГруз И ТипЗнч(Выборка.ЗаказКлиента) = Тип("ДокументСсылка.сабМаршрутныйЛист") Тогда
			НоваяСтрока = ЗаказыПоставщикам.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			НоваяСтрока.ЗаказПоставщику = Выборка.ЗаказКлиента;
			НоваяСтрока.Дата = Выборка.ДатаТранзитнойОтгрузки;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры


